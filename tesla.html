<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BoardingGate Lanzador</title>
    <link rel="icon" href="https://boardinggate.github.io/Tesla/IMG_4157.jpeg" type="image/jpeg">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background-color: #F3F4F6;
            margin: 0;
            overflow-x: hidden;
        }
        body.dark-mode {
            background-color: #374151;
        }
        .minimal-mode .reminder-count,
        .minimal-mode .reminder-notification {
            display: none !important;
        }
        .sidebar {
            position: fixed;
            top: 0;
            left: -256px;
            width: 256px;
            height: 100%;
            background-color: #E5E7EB;
            transition: left 0.3s ease-in-out;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            padding-top: 1rem;
        }
        body.dark-mode .sidebar {
            background-color: #4B5563;
        }
        .sidebar.open {
            left: 0;
        }
        .sidebar button {
            margin: 0.5rem 1rem;
            padding: 0.75rem;
            border-radius: 0.375rem;
            font-size: 1.125rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            position: relative;
        }
        .sidebar button img {
            width: 24px;
            height: 24px;
        }
        .sidebar button:not(#toggle-sidebar) {
            background-color: #D1D5DB;
            color: #111827;
        }
        body.dark-mode .sidebar button:not(#toggle-sidebar) {
            background-color: #6B7280;
            color: #F9FAFB;
        }
        #toggle-sidebar {
            background-color: #2563EB;
            color: #FFFFFF;
        }
        .bookmark-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
        }
        .bookmark {
            background-color: #E5E7EB;
            padding: 1rem;
            border-radius: 0.375rem;
            text-align: center;
            position: relative;
            transition: transform 0.2s;
        }
        body.dark-mode .bookmark {
            background-color: #4B5563;
        }
        .bookmark:hover {
            transform: scale(1.05);
        }
        .bookmark img {
            width: 48px;
            height: 48px;
            margin-bottom: 0.5rem;
        }
        .bookmark p {
            font-size: 1rem;
            font-weight: 500;
            color: #111827;
            margin: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        body.dark-mode .bookmark p {
            color: #F9FAFB;
        }
        .bookmark-actions {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            display: none;
            gap: 0.25rem;
        }
        .bookmark:hover .bookmark-actions {
            display: flex;
        }
        .bookmark-actions button {
            background-color: #EF4444;
            color: #FFFFFF;
            padding: 0.25rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
        }
        footer {
            margin-top: auto;
            padding: 1rem;
            text-align: center;
            background-color: #E5E7EB;
            width: 100%;
        }
        body.dark-mode footer {
            background-color: #4B5563;
        }
        footer p {
            color: #111827;
            margin: 0;
        }
        body.dark-mode footer p {
            color: #F9FAFB;
        }
        .reminder-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #F3F4F6;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 2000;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            font-size: 1.25rem;
        }
        body.dark-mode .reminder-modal {
            background-color: #4B5563;
        }
        .reminder-modal h2 {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: #111827;
        }
        body.dark-mode .reminder-modal h2 {
            color: #F9FAFB;
        }
        .reminder-modal label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }
        body.dark-mode .reminder-modal label {
            color: #D1D5DB;
        }
        .reminder-modal input,
        .reminder-modal textarea {
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border: 1px solid #D1D5DB;
            border-radius: 0.25rem;
            font-size: 1.25rem;
        }
        body.dark-mode .reminder-modal input,
        body.dark-mode .reminder-modal textarea {
            border-color: #6B7280;
            background-color: #374151;
            color: #F9FAFB;
        }
        .reminder-modal textarea {
            font-size: 1.5rem;
            font-weight: bold;
            text-transform: uppercase;
        }
        .reminder-modal .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        .reminder-modal .full-width {
            grid-column: span 2;
        }
        .reminder-modal .days-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        .reminder-modal .button-group {
            display: flex;
            justify-content: space-between;
            gap: 0.5rem;
            flex-wrap: nowrap;
        }
        .reminder-modal button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.25rem;
            cursor: pointer;
            font-size: 1.25rem;
            flex: 1;
            text-align: center;
        }
        .reminder-modal button[type="submit"] {
            background-color: #2563EB;
            color: #FFFFFF;
        }
        .reminder-modal button[type="button"] {
            background-color: #D1D5DB;
            color: #111827;
        }
        body.dark-mode .reminder-modal button[type="button"] {
            background-color: #6B7280;
            color: #F9FAFB;
        }
        .reminder-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #FFFF99;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            z-index: 3000;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        .reminder-notification .reminder-text {
            margin: 0.5rem 0;
            font-size: 1.5rem;
            font-weight: bold;
            color: #0000FF;
        }
        .reminder-notification .reminder-details {
            margin: 0.5rem 0;
            font-size: 1rem;
            color: #0000FF;
        }
        .reminder-notification .button-group {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        .reminder-notification button {
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .reminder-notification button.cancel {
            background-color: #EF4444;
            color: #FFFFFF;
        }
        .reminder-notification button.modify {
            background-color: #10B981;
            color: #FFFFFF;
        }
        .reminder-notification button.postpone {
            background-color: #F59E0B;
            color: #FFFFFF;
        }
        .reminder-table-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #F3F4F6;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 2000;
            max-width: 90%;
            width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }
        body.dark-mode .reminder-table-modal {
            background-color: #4B5563;
        }
        .reminder-table-modal table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
        }
        .reminder-table-modal th,
        .reminder-table-modal td {
            padding: 0.5rem;
            border: 1px solid #1E3A8A;
            font-size: 0.9rem;
            text-align: center;
        }
        .reminder-table-modal td.text-column {
            text-align: left;
        }
        .reminder-table-modal th {
            background-color: #E5E7EB;
            font-weight: bold;
        }
        body.dark-mode .reminder-table-modal th {
            background-color: #6B7280;
        }
        .reminder-table-modal td.date-column {
            white-space: nowrap;
        }
        .reminder-table-modal button {
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            cursor: pointer;
            font-size: 0.8rem;
            margin-right: 0.25rem;
        }
        .reminder-table-modal button.modify,
        .reminder-table-modal button.delete,
        .reminder-table-modal button.postpone {
            width: 5rem;
            text-align: center;
        }
        .reminder-table-modal button.modify {
            background-color: #10B981;
            color: #FFFFFF;
        }
        .reminder-table-modal button.delete {
            background-color: #EF4444;
            color: #FFFFFF;
        }
        .reminder-table-modal button.postpone {
            background-color: #F59E0B;
            color: #FFFFFF;
        }
        .reminder-table-modal .button-group {
            display: flex;
            justify-content: flex-start;
            margin-top: 1rem;
        }
        .reminder-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: #EF4444;
            color: white;
            border-radius: 50%;
            padding: 4px 8px;
            font-size: 0.75rem;
            font-weight: bold;
        }
    </style>
</head>
<body class="min-h-screen bg-[#F3F4F6] flex flex-col items-center p-6">
    <aside class="sidebar" id="sidebar">
        <button id="toggle-sidebar" class="flex items-center gap-2">
            <img src="https://boardinggate.github.io/Tesla/menu-icon.png" alt="Menu">
            Menú
        </button>
        <button id="add-bookmark" class="flex items-center gap-2">
            <img src="https://boardinggate.github.io/Tesla/add-icon.png" alt="Add">
            Añadir Marcador
        </button>
        <button id="reminder-button" class="flex items-center gap-2">
            <img src="https://boardinggate.github.io/Tesla/reminder-icon.png" alt="Reminder">
            Recordatorio
            <span class="reminder-count" style="display: none;"></span>
        </button>
        <button id="dark-mode-toggle" class="flex items-center gap-2">
            <img src="https://boardinggate.github.io/Tesla/dark-mode-icon.png" alt="Dark Mode">
            Modo Oscuro
        </button>
        <button id="minimal-mode-toggle" class="flex items-center gap-2">
            <img src="https://boardinggate.github.io/Tesla/minimal-mode-icon.png" alt="Minimal Mode">
            Modo Minimalista
        </button>
    </aside>
    <div id="reminder-notifications"></div>
    <main class="flex-grow w-full">
        <div id="bookmark-grid" class="bookmark-grid"></div>
    </main>
    <footer>
        <div class="footer-content">
            <p>BoardingGate Lanzador</p>
        </div>
    </footer>

    <script>
        // Configuración inicial
        let isDarkMode = false;
        let isMinimalMode = false;
        let reminderPressStartTime = null;

        // Funciones de recordatorios
        function formatDateToDDMMMYY(dateStr) {
            if (!dateStr) return '-';
            const [year, month, day] = dateStr.split('-');
            const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
            return `${day}/${months[parseInt(month) - 1]}/${year.slice(2)}`;
        }

        function parseReminderText(text) {
            const result = {
                text: `<b>${text.trim().toUpperCase()}</b>`,
                time: null,
                date: null,
                repeatDays: [],
                intervalDays: null,
                timerMinutes: null
            };
            let normalizedText = text.toUpperCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            const numberWords = {
                'UNA': 1, 'UNO': 1, 'DOS': 2, 'TRES': 3, 'CUATRO': 4, 'CINCO': 5,
                'SEIS': 6, 'SIETE': 7, 'OCHO': 8, 'NUEVE': 9, 'DIEZ': 10,
                'ONCE': 11, 'DOCE': 12, 'TRECE': 13, 'CATORCE': 14, 'QUINCE': 15,
                'DIECISEIS': 16, 'DIECISIETE': 17, 'DIECIOCHO': 18, 'DIECINUEVE': 19,
                'VEINTE': 20, 'VEINTIUNO': 21, 'VEINTIDOS': 22, 'VEINTITRES': 23,
                'VEINTICUATRO': 24, 'VEINTICINCO': 25, 'VEINTISEIS': 26, 'VEINTISIETE': 27,
                'VEINTIOCHO': 28, 'VEINTINUEVE': 29, 'TREINTA': 30, 'TREINTAYUNO': 31
            };
            const timeRegex = /\b(\d{1,2}):(\d{2})\b/;
            const timeTextRegex = /.*\bA\s*LAS?\s*(\w+)\s*(?:Y\s*(CUARTO|MEDIA|DIEZ|VEINTE|TREINTA|CUARENTA|CINCUENTA)|MENOS\s*CUARTO)?\s*(DE\s*LA\s*(MANANA|TARDE|NOCHE))?/i;
            const timeMatches = normalizedText.match(timeRegex) || normalizedText.match(timeTextRegex);
            if (timeMatches) {
                let hours, minutes;
                if (timeMatches[0].includes(':')) {
                    hours = parseInt(timeMatches[1]);
                    minutes = parseInt(timeMatches[2]);
                } else {
                    hours = numberWords[timeMatches[1]] || parseInt(timeMatches[1]) || 0;
                    const minuteText = timeMatches[2] || '';
                    minutes = minuteText === 'CUARTO' ? 15 :
                              minuteText === 'MEDIA' ? 30 :
                              minuteText === 'DIEZ' ? 10 :
                              minuteText === 'VEINTE' ? 20 :
                              minuteText === 'TREINTA' ? 30 :
                              minuteText === 'CUARENTA' ? 40 :
                              minuteText === 'CINCUENTA' ? 50 :
                              0;
                    if (minuteText === 'MENOS' && timeMatches[2] === 'CUARTO') {
                        hours = hours === 0 ? 23 : hours - 1;
                        minutes = 45;
                    }
                    const period = timeMatches[4] || null;
                    if (!period && hours >= 1 && hours <= 5) {
                        hours += 12;
                    } else if (period) {
                        if (period === 'TARDE' && hours < 12) hours += 12;
                        if (period === 'NOCHE' && hours < 12) hours += 12;
                        if (period === 'MANANA' && hours === 12) hours = 0;
                    }
                }
                if (hours >= 0 && hours <= 23 && minutes >= 0 && minutes <= 59) {
                    result.time = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
                }
            }
            const daysMap = {
                'LUNES': 1, 'MARTES': 2, 'MIERCOLES': 3,
                'JUEVES': 4, 'VIERNES': 5, 'SABADO': 6, 'DOMINGO': 0
            };
            const weeklyRegex = /(TODOS\s+LOS|LOS|CADA)?\s*(LUNES|MARTES|MIERCOLES|JUEVES|VIERNES|SABADO|DOMINGO)/g;
            const weeklyMatches = normalizedText.matchAll(weeklyRegex);
            for (const match of weeklyMatches) {
                const dayName = match[2];
                if (daysMap[dayName] !== undefined && !result.repeatDays.includes(daysMap[dayName])) {
                    result.repeatDays.push(daysMap[dayName]);
                }
            }
            const dateNextDayRegex = /(?:EL\s*(PROXIMO)?\s*)?(LUNES|MARTES|MIERCOLES|JUEVES|VIERNES|SABADO|DOMINGO)/i;
            const dateNextDayMatch = normalizedText.match(dateNextDayRegex);
            if (dateNextDayMatch) {
                const now = new Date();
                const targetDay = daysMap[dateNextDayMatch[2]];
                const currentDay = now.getDay();
                let daysUntil = (targetDay - currentDay + 7) % 7 || 7;
                if (dateNextDayMatch[1]) daysUntil += 7;
                const targetDate = new Date(now);
                targetDate.setDate Resizable(true);
                targetDate.setDate(now.getDate() + daysUntil);
                result.date = `${targetDate.getFullYear()}-${(targetDate.getMonth() + 1).toString().padStart(2, '0')}-${targetDate.getDate().toString().padStart(2, '0')}`;
                if (result.time && result.date) {
                    const [hours, minutes] = result.time.split(':').map(Number);
                    targetDate.setHours(hours, minutes, 0, 0);
                    result.time = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
                }
            }
            const tomorrowRegex = /\bMANANA\b/;
            const dayAfterTomorrowRegex = /\bPASADO\s*MANANA\b/;
            if (normalizedText.match(dayAfterTomorrowRegex)) {
                const now = new Date();
                const targetDate = new Date(now);
                targetDate.setDate(now.getDate() + 2);
                result.date = `${targetDate.getFullYear()}-${(targetDate.getMonth() + 1).toString().padStart(2, '0')}-${targetDate.getDate().toString().padStart(2, '0')}`;
            } else if (normalizedText.match(tomorrowRegex)) {
                const now = new Date();
                const targetDate = new Date(now);
                targetDate.setDate(now.getDate() + 1);
                result.date = `${targetDate.getFullYear()}-${(targetDate.getMonth() + 1).toString().padStart(2, '0')}-${targetDate.getDate().toString().padStart(2, '0')}`;
            }
            const manualDateRegex = /(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2,4})/;
            const manualDateMatch = normalizedText.match(manualDateRegex);
            if (manualDateMatch) {
                let day = parseInt(manualDateMatch[1]);
                let month = parseInt(manualDateMatch[2]);
                let year = parseInt(manualDateMatch[3]);
                if (year < 100) year += 2000;
                if (day >= 1 && day <= 31 && month >= 1 && month <= 12 && year >= 2000) {
                    result.date = `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                }
            }
            const dateInDaysRegex = /(?:DENTRO\s*DE\s*)(\d+)\s*DIAS?/;
            const dateInDaysMatch = normalizedText.match(dateInDaysRegex);
            if (dateInDaysMatch) {
                const days = parseInt(dateInDaysMatch[1]);
                const targetDate = new Date();
                targetDate.setDate(targetDate.getDate() + days);
                result.date = `${targetDate.getFullYear()}-${(targetDate.getMonth() + 1).toString().padStart(2, '0')}-${targetDate.getDate().toString().padStart(2, '0')}`;
            }
            const dateSpecificDayRegex = /(?:EL\s*DIA\s*)(\d{1,2})\b/;
            const dateSpecificDayMatch = normalizedText.match(dateSpecificDayRegex);
            if (dateSpecificDayMatch) {
                const day = parseInt(dateSpecificDayMatch[1]);
                const now = new Date();
                let month = now.getMonth();
                let year = now.getFullYear();
                if (day < now.getDate()) {
                    month = (month + 1) % 12;
                    if (month === 0) year += 1;
                }
                const targetDate = new Date(year, month, day);
                if (day >= 1 && day <= 31) {
                    result.date = `${targetDate.getFullYear()}-${(targetDate.getMonth() + 1).toString().padStart(2, '0')}-${targetDate.getDate().toString().padStart(2, '0')}`;
                }
            }
            const intervalRegex = /CADA\s*(\d+)\s*DIAS?/;
            const intervalMatch = normalizedText.match(intervalRegex);
            if (intervalMatch) {
                result.intervalDays = parseInt(intervalMatch[1]);
                if (!result.date) {
                    const now = new Date();
                    result.date = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}`;
                }
            }
            const timerRegex = /(ALARMA|AVISO|AVISAR|AVISARME|TEMPORIZADOR|TIMER|RECORDAR|RECORDARME)\b.*?\b(\d+|\w+)\s*(MINUTOS?|HORAS?|MINS?|HRS?)/g;
            const timerMatches = normalizedText.matchAll(timerRegex);
            for (const match of timerMatches) {
                const value = numberWords[match[2]] || parseInt(match[2]);
                if (value) {
                    result.timerMinutes = match[3].startsWith('HORA') || match[3].startsWith('HR') ? value * 60 : value;
                    const endTime = new Date(Date.now() + result.timerMinutes * 60 * 1000);
                    result.time = `${endTime.getHours().toString().padStart(2, '0')}:${endTime.getMinutes().toString().padStart(2, '0')}`;
                }
            }
            return result;
        }

        function showReminderModal(reminder = null) {
            const parsed = reminder ? reminder : { text: '', time: null, date: '', repeatDays: [], intervalDays: '', timerMinutes: '' };
            const modal = document.createElement('div');
            modal.className = 'reminder-modal';
            modal.setAttribute('aria-label', 'Formulario de recordatorio');
            modal.innerHTML = `
                <h2 class="text-2xl font-bold text-gray-900">RECORDATORIOS</h2>
                <form id="reminder-form">
                    <div class="form-grid">
                        <div class="full-width">
                            <label for="reminder-text">Texto del recordatorio:</label>
                            <textarea id="reminder-text" rows="3" required>${parsed.text.replace(/<b>|<\/b>/g, '')}</textarea>
                            <p id="parse-status" class="text-sm mt-1"></p>
                        </div>
                        <div>
                            <label for="reminder-time">Hora:</label>
                            <input type="time" id="reminder-time" value="${parsed.time || ''}">
                        </div>
                        <div>
                            <label for="reminder-date">Fecha:</label>
                            <input type="date" id="reminder-date" value="${parsed.date || ''}">
                        </div>
                        <div class="full-width">
                            <label>Días de repetición:</label>
                            <div class="days-group">
                                ${['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'].map((day, i) => `
                                    <label style="flex: 0 0 auto;">
                                        <input type="checkbox" name="repeat" value="${(i + 1) % 7}" ${parsed.repeatDays.includes((i + 1) % 7) ? 'checked' : ''}> ${day}
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                        <div>
                            <label for="reminder-interval">Intervalo (días):</label>
                            <input type="number" id="reminder-interval" min="1" value="${parsed.intervalDays || ''}">
                        </div>
                        <div>
                            <label for="reminder-timer">Temporizador (minutos):</label>
                            <input type="number" id="reminder-timer" min="1" value="${parsed.timerMinutes || ''}">
                        </div>
                        <div class="full-width button-group">
                            <button type="button" id="clear-fields">Vaciar Campos</button>
                            <button type="button" id="view-reminders">Ver Recordatorios</button>
                            <button type="button" id="cancel-reminder">Cancelar</button>
                            <button type="submit" id="save-reminder">Aceptar</button>
                        </div>
                    </div>
                </form>
            `;
            document.body.appendChild(modal);

            const parseStatus = modal.querySelector('#parse-status');
            let manualTimeInput = false;
            const timeInput = modal.querySelector('#reminder-time');
            timeInput.addEventListener('input', () => {
                manualTimeInput = true;
            });

            let parseTimeout = null;
            modal.querySelector('#reminder-text').addEventListener('input', (e) => {
                const text = e.target.value || '';
                parseStatus.textContent = 'Esperando 4 segundos para parsear...';
                parseStatus.classList.remove('text-green-600', 'text-red-600');
                if (parseTimeout) clearTimeout(parseTimeout);
                parseTimeout = setTimeout(() => {
                    try {
                        const parsed = parseReminderText(text);
                        if (!manualTimeInput) {
                            modal.querySelector('#reminder-time').value = parsed.time || '';
                        }
                        modal.querySelector('#reminder-date').value = parsed.date || '';
                        modal.querySelectorAll('input[name="repeat"]').forEach(input => {
                            input.checked = (parsed.repeatDays || []).includes(parseInt(input.value));
                        });
                        modal.querySelector('#reminder-interval').value = parsed.intervalDays || '';
                        modal.querySelector('#reminder-timer').value = parsed.timerMinutes || '';
                        parseStatus.textContent = 'Datos parseados correctamente';
                        parseStatus.classList.add('text-green-600');
                    } catch (error) {
                        console.error('Error durante el parseo:', error);
                        parseStatus.textContent = `Error al parsear: ${error.message}`;
                        parseStatus.classList.add('text-red-600');
                    }
                }, 4000);
            });

            const form = modal.querySelector('#reminder-form');
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                const text = modal.querySelector('#reminder-text').value.trim();
                let time = modal.querySelector('#reminder-time').value.trim();
                let date = modal.querySelector('#reminder-date').value;
                const repeatDays = Array.from(modal.querySelectorAll('input[name="repeat"]:checked')).map(input => parseInt(input.value));
                const intervalDays = parseInt(modal.querySelector('#reminder-interval').value) || null;
                const timerMinutes = parseInt(modal.querySelector('#reminder-timer').value) || null;

                if (!text) {
                    alert('El texto del recordatorio es obligatorio.');
                    return;
                }

                const type = timerMinutes ? 'timer' : intervalDays ? 'interval' : repeatDays.length > 0 ? 'weekly' : date ? 'daily' : time ? 'hourly' : 'simple';
                if (!time && type !== 'timer' && (type !== 'simple' || date || repeatDays.length > 0 || intervalDays)) {
                    time = '00:01';
                }

                let reminders = JSON.parse(localStorage.getItem('reminders') || '[]');
                const newReminder = {
                    id: reminder ? reminder.id : Date.now(),
                    text: `<b>${text.toUpperCase()}</b>`,
                    type,
                    time: ['hourly', 'daily', 'weekly', 'interval', 'timer'].includes(type) ? time : null,
                    date: type === 'daily' || type === 'interval' ? date : null,
                    repeatDays: type === 'weekly' ? repeatDays : [],
                    intervalDays: type === 'interval' ? intervalDays : null,
                    timerMinutes: type === 'timer' ? timerMinutes : null,
                    createdAt: reminder ? reminder.createdAt : new Date().toISOString(),
                    timerEnd: type === 'timer' ? new Date(Date.now() + timerMinutes * 60 * 1000).toISOString() : null
                };

                if (reminder) {
                    const index = reminders.findIndex(r => r.id === reminder.id);
                    if (index !== -1) reminders[index] = newReminder;
                } else {
                    reminders.push(newReminder);
                }

                localStorage.setItem('reminders', JSON.stringify(reminders));
                document.body.removeChild(modal);
                updateButtonStyles();
            });

            modal.querySelector('#save-reminder').addEventListener('click', () => {
                const submitEvent = new Event('submit', { bubbles: true, cancelable: true });
                form.dispatchEvent(submitEvent);
            });

            modal.querySelector('#cancel-reminder').addEventListener('click', () => {
                document.body.removeChild(modal);
            });

            modal.querySelector('#clear-fields').addEventListener('click', () => {
                modal.querySelector('#reminder-text').value = '';
                modal.querySelector('#reminder-time').value = '';
                modal.querySelector('#reminder-date').value = '';
                modal.querySelectorAll('input[name="repeat"]').forEach(input => input.checked = false);
                modal.querySelector('#reminder-interval').value = '';
                modal.querySelector('#reminder-timer').value = '';
                parseStatus.textContent = '';
                manualTimeInput = false;
            });

            modal.querySelector('#view-reminders').addEventListener('click', () => {
                document.body.removeChild(modal);
                showAllReminders();
            });

            modal.querySelector('#reminder-text').focus();
        }

        function showReminderNotification(reminder) {
            const notification = document.createElement('div');
            notification.className = 'reminder-notification';
            notification.setAttribute('aria-label', 'Notificación de recordatorio');
            const formattedDate = reminder.date ? `${reminder.date.split('-')[2]}/${reminder.date.split('-')[1]}/${reminder.date.split('-')[0]}` : '';
            notification.innerHTML = `
                <p class="reminder-text">${reminder.text}</p>
                ${reminder.time ? `<p class="reminder-details">Hora: ${reminder.time}</p>` : ''}
                ${reminder.date ? `<p class="reminder-details">Fecha: ${formattedDate}</p>` : ''}
                ${reminder.repeatDays.length > 0 ? `<p class="reminder-details">Repite: ${reminder.repeatDays.map(d => ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'][d]).join(', ')}</p>` : ''}
                ${reminder.intervalDays ? `<p class="reminder-details">Por intervalo: ${reminder.intervalDays} días</p>` : ''}
                ${reminder.timerMinutes ? `<p class="reminder-details">Temporizador: ${reminder.timerMinutes} minutos</p>` : ''}
                <div class="button-group">
                    <button class="cancel">Borrar</button>
                    <button class="modify">Modificar</button>
                    <button class="postpone">Posponer</button>
                </div>
            `;
            document.getElementById('reminder-notifications').appendChild(notification);

            alert(`Recordatorio: ${reminder.text.replace(/<b>|<\/b>/g, '')}\n${reminder.time ? `Hora: ${reminder.time}\n` : ''}${reminder.date ? `Fecha: ${formattedDate}\n` : ''}${reminder.repeatDays.length > 0 ? `Repite: ${reminder.repeatDays.map(d => ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'][d]).join(', ')}\n` : ''}${reminder.intervalDays ? `Por intervalo: ${reminder.intervalDays} días\n` : ''}${reminder.timerMinutes ? `Temporizador: ${reminder.timerMinutes} minutos` : ''}`);

            notification.querySelector('.cancel').addEventListener('click', () => {
                document.getElementById('reminder-notifications').removeChild(notification);
                let reminders = JSON.parse(localStorage.getItem('reminders') || '[]');
                reminders = reminders.filter(r => r.id !== reminder.id);
                localStorage.setItem('reminders', JSON.stringify(reminders));
                updateButtonStyles();
            });

            notification.querySelector('.modify').addEventListener('click', () => {
                document.getElementById('reminder-notifications').removeChild(notification);
                showReminderModal(reminder);
            });

            notification.querySelector('.postpone').addEventListener('click', () => {
                document.getElementById('reminder-notifications').removeChild(notification);
                let reminders = JSON.parse(localStorage.getItem('reminders') || '[]');
                const index = reminders.findIndex(r => r.id === reminder.id);
                if (index !== -1) {
                    const now = new Date();
                    if (reminder.type === 'timer') {
                        const [hours, minutes] = reminder.time.split(':').map(Number);
                        const totalMinutes = hours * 60 + minutes + reminder.timerMinutes;
                        const newHours = Math.floor(totalMinutes / 60) % 24;
                        const newMinutes = totalMinutes % 60;
                        reminders[index].time = `${newHours.toString().padStart(2, '0')}:${newMinutes.toString().padStart(2, '0')}`;
                        const timerEnd = new Date(now);
                        timerEnd.setHours(newHours, newMinutes, 0, 0);
                        if (timerEnd <= now) timerEnd.setDate(timerEnd.getDate() + 1);
                        reminders[index].timerEnd = timerEnd.toISOString();
                    } else if (reminder.type === 'interval') {
                        const nextDate = new Date();
                        nextDate.setDate(nextDate.getDate() + reminder.intervalDays);
                        reminders[index].date = `${nextDate.getFullYear()}-${(nextDate.getMonth() + 1).toString().padStart(2, '0')}-${nextDate.getDate().toString().padStart(2, '0')}`;
                    } else if (reminder.date || reminder.type === 'daily' || reminder.type === 'hourly') {
                        const [year, month, day] = (reminder.date || `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}`).split('-').map(Number);
                        const date = new Date(year, month - 1, day);
                        date.setDate(date.getDate() + 1);
                        reminders[index].date = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
                    } else {
                        const created = new Date(reminder.createdAt);
                        created.setDate(created.getDate() + 1);
                        reminders[index].createdAt = created.toISOString();
                    }
                    localStorage.setItem('reminders', JSON.stringify(reminders));
                    updateButtonStyles();
                }
            });
        }

        function showAllReminders() {
            const reminders = JSON.parse(localStorage.getItem('reminders') || '[]');
            reminders.sort((a, b) => {
                const typeOrder = { 'timer': 0, 'simple': 0, 'hourly': 1, 'weekly': 2, 'interval': 3, 'daily': 4 };
                const typeDiff = typeOrder[a.type] - typeOrder[b.type];
                if (typeDiff !== 0) return typeDiff;
                const timeA = a.time || '00:00';
                const timeB = b.time || '00:00';
                const timeDiff = timeA.localeCompare(timeB);
                if (typeDiff === 0 && timeDiff !== 0) return timeDiff;
                const dateA = a.date || '2000-01-01';
                const dateB = b.date || '2000-01-01';
                return dateA.localeCompare(dateB);
            });
            const modal = document.createElement('div');
            modal.className = 'reminder-table-modal';
            modal.setAttribute('aria-label', 'Tabla de recordatorios');
            modal.innerHTML = `
                <h2>Recordatorios</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Acciones</th>
                            <th>Texto</th>
                            <th>Hora</th>
                            <th>Fecha</th>
                            <th>Días</th>
                            <th>Cada x días</th>
                            <th>ALARMA minutos</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${reminders.length === 0 ? '<tr><td colspan="7">No hay recordatorios.</td></tr>' : reminders.map(r => `
                            <tr>
                                <td>
                                    <button class="modify" data-id="${r.id}">Modificar</button>
                                    <button class="delete" data-id="${r.id}">Borrar</button>
                                    <button class="postpone" data-id="${r.id}">Posponer</button>
                                </td>
                                <td class="text-column">${r.text}</td>
                                <td>${r.time || '-'}</td>
                                <td class="date-column">${formatDateToDDMMMYY(r.date)}</td>
                                <td>${r.repeatDays.length > 0 ? r.repeatDays.map(d => ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'][d]).join(', ') : '-'}</td>
                                <td>${r.intervalDays || '-'}</td>
                                <td>${r.timerMinutes || '-'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                <div class="button-group flex justify-start">
                    <button type="button" id="close-reminders" class="bg-blue-700 text-white px-12 py-3 rounded-lg text-xl font-bold border-2 border-blue-900 hover:bg-blue-800 transition-colors">SALIR</button>
                </div>
            `;
            document.body.appendChild(modal);

            modal.querySelectorAll('.modify').forEach(button => {
                button.addEventListener('click', () => {
                    const id = parseInt(button.dataset.id);
                    const reminder = reminders.find(r => r.id === id);
                    document.body.removeChild(modal);
                    showReminderModal(reminder);
                });
            });

            modal.querySelectorAll('.delete').forEach(button => {
                button.addEventListener('click', () => {
                    const id = parseInt(button.dataset.id);
                    let reminders = JSON.parse(localStorage.getItem('reminders') || '[]');
                    reminders = reminders.filter(r => r.id !== id);
                    localStorage.setItem('reminders', JSON.stringify(reminders));
                    document.body.removeChild(modal);
                    updateButtonStyles();
                    showAllReminders();
                });
            });

            modal.querySelectorAll('.postpone').forEach(button => {
                button.addEventListener('click', () => {
                    const id = parseInt(button.dataset.id);
                    let reminders = JSON.parse(localStorage.getItem('reminders') || '[]');
                    const index = reminders.findIndex(r => r.id === id);
                    if (index !== -1) {
                        const now = new Date();
                        if (reminders[index].type === 'timer') {
                            const [hours, minutes] = reminders[index].time.split(':').map(Number);
                            const totalMinutes = hours * 60 + minutes + reminders[index].timerMinutes;
                            const newHours = Math.floor(totalMinutes / 60) % 24;
                            const newMinutes = totalMinutes % 60;
                            reminders[index].time = `${newHours.toString().padStart(2, '0')}:${newMinutes.toString().padStart(2, '0')}`;
                            const timerEnd = new Date(now);
                            timerEnd.setHours(newHours, newMinutes, 0, 0);
                            if (timerEnd <= now) timerEnd.setDate(timerEnd.getDate() + 1);
                            reminders[index].timerEnd = timerEnd.toISOString();
                        } else if (reminders[index].type === 'interval') {
                            const nextDate = new Date();
                            nextDate.setDate(nextDate.getDate() + reminders[index].intervalDays);
                            reminders[index].date = `${nextDate.getFullYear()}-${(nextDate.getMonth() + 1).toString().padStart(2, '0')}-${nextDate.getDate().toString().padStart(2, '0')}`;
                        } else if (reminders[index].date || reminders[index].type === 'daily' || reminders[index].type === 'hourly') {
                            const [year, month, day] = (reminders[index].date || `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}`).split('-').map(Number);
                            const date = new Date(year, month - 1, day);
                            date.setDate(date.getDate() + 1);
                            reminders[index].date = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
                        } else {
                            const created = new Date(reminders[index].createdAt);
                            created.setDate(created.getDate() + 1);
                            reminders[index].createdAt = created.toISOString();
                        }
                        localStorage.setItem('reminders', JSON.stringify(reminders));
                        document.body.removeChild(modal);
                        updateButtonStyles();
                        showAllReminders();
                    }
                });
            });

            modal.querySelector('#close-reminders').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
        }

        function checkReminders() {
            if (isMinimalMode) return;
            const reminders = JSON.parse(localStorage.getItem('reminders') || '[]');
            const now = new Date();
            const currentTime = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
            const currentDay = now.getDay();
            const currentDate = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}`;

            reminders.forEach(reminder => {
                let shouldNotify = false;
                if (reminder.time === '00:01' && !reminder.date && !reminder.repeatDays.length && !reminder.intervalDays && !reminder.timerMinutes) {
                    return;
                }
                if (reminder.type === 'hourly' && reminder.time === currentTime) {
                    shouldNotify = true;
                } else if (reminder.type === 'daily' && reminder.date === currentDate && reminder.time === currentTime) {
                    shouldNotify = true;
                } else if (reminder.type === 'weekly' && reminder.repeatDays.includes(currentDay) && reminder.time === currentTime) {
                    shouldNotify = true;
                } else if (reminder.type === 'interval' && reminder.date === currentDate && reminder.time === currentTime) {
                    shouldNotify = true;
                } else if (reminder.type === 'timer' && new Date(reminder.timerEnd) <= now) {
                    shouldNotify = true;
                }

                if (shouldNotify) {
                    showReminderNotification(reminder);
                }
            });
        }

        function showSimpleReminders() {
            if (isMinimalMode) return;
            const reminders = JSON.parse(localStorage.getItem('reminders') || '[]');
            reminders.forEach(reminder => {
                if (reminder.type === 'simple' && !(reminder.time === '00:01' && !reminder.date && !reminder.repeatDays.length && !reminder.intervalDays && !reminder.timerMinutes)) {
                    showReminderNotification(reminder);
                }
            });
        }

        function updateButtonStyles() {
            const reminders = JSON.parse(localStorage.getItem('reminders') || '[]');
            const count = reminders.length;
            const reminderButton = document.getElementById('reminder-button');
            const reminderCount = reminderButton.querySelector('.reminder-count');
            if (count > 0) {
                reminderCount.textContent = count;
                reminderCount.style.display = 'block';
            } else {
                reminderCount.style.display = 'none';
            }
        }

        // Funciones de marcadores
        function loadBookmarks() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarks') || '[]');
            const grid = document.getElementById('bookmark-grid');
            grid.innerHTML = '';
            bookmarks.forEach((bookmark, index) => {
                const bookmarkElement = document.createElement('div');
                bookmarkElement.className = 'bookmark';
                bookmarkElement.innerHTML = `
                    <a href="${bookmark.url}" target="_blank">
                        <img src="${bookmark.icon || 'https://boardinggate.github.io/Tesla/default-icon.png'}" alt="${bookmark.name}">
                        <p>${bookmark.name}</p>
                    </a>
                    <div class="bookmark-actions">
                        <button class="edit-bookmark" data-index="${index}">Editar</button>
                        <button class="delete-bookmark" data-index="${index}">Eliminar</button>
                    </div>
                `;
                grid.appendChild(bookmarkElement);
            });
        }

        function showAddBookmarkModal(editIndex = null) {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarks') || '[]');
            const bookmark = editIndex !== null ? bookmarks[editIndex] : { name: '', url: '', icon: '' };
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white p-6 rounded-lg max-w-md w-full">
                    <h2 class="text-2xl font-bold mb-4">${editIndex !== null ? 'Editar Marcador' : 'Añadir Marcador'}</h2>
                    <form id="bookmark-form">
                        <div class="mb-4">
                            <label for="bookmark-name" class="block text-sm font-medium text-gray-700">Nombre</label>
                            <input type="text" id="bookmark-name" value="${bookmark.name}" class="mt-1 block w-full border border-gray-300 rounded-md p-2" required>
                        </div>
                        <div class="mb-4">
                            <label for="bookmark-url" class="block text-sm font-medium text-gray-700">URL</label>
                            <input type="url" id="bookmark-url" value="${bookmark.url}" class="mt-1 block w-full border border-gray-300 rounded-md p-2" required>
                        </div>
                        <div class="mb-4">
                            <label for="bookmark-icon" class="block text-sm font-medium text-gray-700">Icono (URL)</label>
                            <input type="url" id="bookmark-icon" value="${bookmark.icon}" class="mt-1 block w-full border border-gray-300 rounded-md p-2">
                        </div>
                        <div class="flex justify-end gap-2">
                            <button type="button" id="cancel-bookmark" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md">Cancelar</button>
                            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md">Guardar</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);

            const form = modal.querySelector('#bookmark-form');
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = modal.querySelector('#bookmark-name').value;
                const url = modal.querySelector('#bookmark-url').value;
                const icon = modal.querySelector('#bookmark-icon').value || 'https://boardinggate.github.io/Tesla/default-icon.png';
                const bookmarks = JSON.parse(localStorage.getItem('bookmarks') || '[]');
                if (editIndex !== null) {
                    bookmarks[editIndex] = { name, url, icon };
                } else {
                    bookmarks.push({ name, url, icon });
                }
                localStorage.setItem('bookmarks', JSON.stringify(bookmarks));
                document.body.removeChild(modal);
                loadBookmarks();
            });

            modal.querySelector('#cancel-bookmark').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
        }

        // Configuración inicial
        function loadSavedSettings() {
            const savedDarkMode = localStorage.getItem('darkMode');
            isDarkMode = savedDarkMode ? JSON.parse(savedDarkMode) : false;
            if (isDarkMode) document.body.classList.add('dark-mode');
            const savedMinimalMode = localStorage.getItem('minimalMode');
            isMinimalMode = savedMinimalMode ? JSON.parse(savedMinimalMode) : false;
            if (isMinimalMode) document.body.classList.add('minimal-mode');
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadSavedSettings();
            loadBookmarks();
            updateButtonStyles();
            showSimpleReminders();
            setInterval(checkReminders, 60000);
            checkReminders();

            const sidebar = document.getElementById('sidebar');
            document.getElementById('toggle-sidebar').addEventListener('click', () => {
                sidebar.classList.toggle('open');
            });

            document.getElementById('add-bookmark').addEventListener('click', () => {
                showAddBookmarkModal();
            });

            document.getElementById('reminder-button').addEventListener('mousedown', () => {
                reminderPressStartTime = Date.now();
            });
            document.getElementById('reminder-button').addEventListener('mouseup', () => {
                const pressDuration = Date.now() - reminderPressStartTime;
                if (pressDuration < 500) {
                    showReminderModal();
                } else {
                    showAllReminders();
                }
            });
            document.getElementById('reminder-button').addEventListener('touchstart', () => {
                reminderPressStartTime = Date.now();
            });
            document.getElementById('reminder-button').addEventListener('touchend', () => {
                const pressDuration = Date.now() - reminderPressStartTime;
                if (pressDuration < 500) {
                    showReminderModal();
                } else {
                    showAllReminders();
                }
            });

            document.getElementById('dark-mode-toggle').addEventListener('click', () => {
                isDarkMode = !isDarkMode;
                document.body.classList.toggle('dark-mode');
                localStorage.setItem('darkMode', JSON.stringify(isDarkMode));
            });

            document.getElementById('minimal-mode-toggle').addEventListener('click', () => {
                isMinimalMode = !isMinimalMode;
                document.body.classList.toggle('minimal-mode');
                localStorage.setItem('minimalMode', JSON.stringify(isMinimalMode));
            });

            document.getElementById('bookmark-grid').addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-bookmark')) {
                    const index = e.target.dataset.index;
                    const bookmarks = JSON.parse(localStorage.getItem('bookmarks') || '[]');
                    bookmarks.splice(index, 1);
                    localStorage.setItem('bookmarks', JSON.stringify(bookmarks));
                    loadBookmarks();
                } else if (e.target.classList.contains('edit-bookmark')) {
                    const index = e.target.dataset.index;
                    showAddBookmarkModal(parseInt(index));
                }
            });
        });
    </script>
</body>
</html>
