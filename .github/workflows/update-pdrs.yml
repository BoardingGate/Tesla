name: Actualizar Puntos de Recarga DGT

on:
  workflow_dispatch:
  schedule:
    - cron: '0 5 * * *'

jobs:
  update-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout del repositorio
        uses: actions/checkout@v3

      - name: Configurar Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'

      - name: Instalar dependencias
        run: npm install axios xml-js

      - name: Ejecutar script de actualización
        run: |
          node -e '
            const fs = require("fs");
            const axios = require("axios");
            const convert = require("xml-js");

            const DGT_URL = "https://infocar.dgt.es/datex2/v3/miterd/EnergyInfrastructureTablePublication/electrolineras.xml";

            async function fetchData() {
              try {
                console.log(`Pidiendo datos a ${DGT_URL}...`);
                
                // --- CORRECCIÓN 1: Añadir User-Agent para simular un navegador ---
                const response = await axios.get(DGT_URL, {
                  headers: {
                    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36"
                  }
                });
                
                const xmlData = response.data;
                console.log("Datos XML recibidos. Parseando...");

                const jsonData = convert.xml2js(xmlData, { compact: true, spaces: 2 });
                
                // --- CORRECCIÓN 2: Acceso seguro a los datos (evita errores si la estructura cambia) ---
                const sites = jsonData?.d2LogicalModel?.payloadPublication?.energyInfrastructureTablePublication?.energyInfrastructureTable?.energyInfrastructureSite;

                if (!sites || !Array.isArray(sites)) {
                    throw new Error("No se pudo encontrar la matriz de `energyInfrastructureSite` en el XML. La estructura puede haber cambiado.");
                }

                console.log(`Encontrados ${sites.length} sitios.`);
                const processedData = sites.map(site => {
                  try {
                    // --- CORRECCIÓN 3: Uso de Optional Chaining (`?.`) para evitar errores si un campo falta ---
                    const lat = parseFloat(site?.pointCoordinates?.latitude?._text);
                    const lon = parseFloat(site?.pointCoordinates?.longitude?._text);

                    if (isNaN(lat) || isNaN(lon)) return null;

                    return {
                      address: site?.siteName?._text || "Dirección no disponible",
                      lat: lat,
                      lon: lon,
                      power: site?.power?._text || "N/A",
                      numPoints: site?.numberOfChargingPoints?._text || "0",
                      available: site?.availableCapacity?._text || "0",
                      price: site?.price?._text || "Consultar",
                      plugTypes: Array.isArray(site?.plugType) ? site.plugType.map(p => p._text).join(", ") : (site?.plugType?._text || "N/A"),
                      payment: Array.isArray(site?.paymentMethod) ? site.paymentMethod.map(p => p._text).join(", ") : (site?.paymentMethod?._text || "No especificado"),
                      services: Array.isArray(site?.service) ? site.service.map(s => s._text).join(", ") : (site?.service?._text || "No especificados"),
                      hours: site?.openingHours?._text || "No especificado"
                    };
                  } catch (e) {
                    console.warn("Se omitió un punto de recarga por tener datos malformados.");
                    return null;
                  }
                }).filter(Boolean); // Elimina los nulos si los hubiera

                console.log(`Procesados ${processedData.length} puntos de recarga válidos.`);
                fs.writeFileSync("pdrs.json", JSON.stringify(processedData, null, 2));
                console.log("Fichero pdrs.json actualizado correctamente.");

              } catch (error) {
                console.error("Error en el script de actualización:", error.message);
                process.exit(1); // Esto es lo que causa el 'exit code 1'
              }
            }

            fetchData();
          '
      
      - name: Commit y Push de los cambios
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "chore: Actualización automática de puntos de recarga DGT"
          file_pattern: 'pdrs.json'
