<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BoardingGate Lanzador</title>
    <link rel="icon" href="https://boardinggate.github.io/Tesla/IMG_4157.jpeg" type="image/jpeg">
    <script src="https://cdn.tailwindcss.com"></script>

<style>
    /* --- Estilos Base y Layout --- */
    body {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        background-color: #ABAB99; /* Light mode default */
        margin: 0;
        overflow-x: hidden; /* Evita scroll horizontal */
        padding: 6px; /* Pequeño padding general */
        box-sizing: border-box;
    }
    body.dark-mode {
        background-color: #92927E; /* Dark mode background */
    }

    main {
        /* Ocupa el espacio principal, margen izquierdo para botones */
        margin: 0.5rem auto 0.5rem 60px;
        max-width: 984px; /* Ancho máximo del contenido */
        width: calc(100% - 70px); /* Ancho menos margen botones y algo de espacio */
        padding: 16px; /* Padding interno */
        box-sizing: border-box;
        /* background-color: transparent; */ /* Hereda del body o puede tener el suyo */
        border-radius: 0.75rem;
        min-height: 400px; /* Asegura altura mínima */
    }

    /* --- Grid de Marcadores --- */
    #bookmark-grid {
        display: grid;
        /* Grid por defecto, se ajusta por JS/responsive */
        grid-template-columns: repeat(6, minmax(120px, 1fr));
        gap: 15px;
        width: 100%; /* Ocupa el ancho de main */
        transition: all 0.3s ease;
    }
    /* Contenedor de cada celda */
    #bookmark-grid > div {
        height: auto;
        aspect-ratio: 16 / 9; /* Mantiene proporción */
        transition: all 0.3s ease;
        border: 2px solid transparent; /* Borde para modo config */
        display: flex; /* Para que el link interno ocupe todo */
        align-items: stretch;
        justify-content: stretch;
        overflow: hidden; /* Evita que contenido desborde */
        border-radius: 0.5rem; /* Redondeo de la celda */
    }
    /* Link dentro de la celda */
    .bookmark-item {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        /* border-radius: 0.5rem; */ /* Redondeo ahora en el div padre */
        transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
        background-color: hsla(var(--hue, 0), var(--saturation, 80%), var(--lightness, 90%), 0.64); /* Color base con variables CSS */
        padding: 4px;
        box-sizing: border-box;
        text-decoration: none; /* Quita subrayado de links */
        box-shadow: 4px 4px 8px rgba(0, 0, 0, 0.3), -4px -4px 8px rgba(255, 255, 255, 0.1); /* Sombra Neumorfica suave */
        position: relative; /* Para z-index en hover */
    }
    .bookmark-item:hover {
        transform: scale(1.03) translateY(-1px); /* Efecto hover sutil */
        box-shadow: 6px 6px 12px rgba(0, 0, 0, 0.4), -6px -6px 12px rgba(255, 255, 255, 0.15);
        z-index: 10;
    }
    /* Icono */
    .bookmark-item img {
        width: 36px;
        height: 36px; /* Altura fija para consistencia */
        max-width: 40px;
        object-fit: contain; /* Escala manteniendo aspecto */
        border-radius: 0.25rem;
        margin-bottom: 4px;
        image-rendering: crisp-edges; /* Estilo pixelado */
        -ms-interpolation-mode: nearest-neighbor;
    }
    /* Nombre */
    .bookmark-name {
        font-weight: bold;
        color: #333; /* Color texto light mode */
        text-align: center;
        margin-top: 4px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: calc(100% - 8px); /* Evita que toque bordes */
        font-size: clamp(0.80rem, 1.4vw, 1.10rem); /* Tamaño ajustado */
        line-height: 1.2; /* Ajuste interlineado */
    }
    body.dark-mode .bookmark-name {
        color: #E5E7EB; /* Color texto dark mode */
    }
    /* Estilos para marcadores pequeños (sección Varios) */
    .small-bookmark img {
        width: 24px;
        height: 24px;
        max-width: 28px;
    }
    /* Celdas vacías */
    #bookmark-grid > div.config-empty-cell {
        background-color: rgba(200, 200, 200, 0.3); /* Gris claro transparente */
        border: 1px dashed rgba(150, 150, 150, 0.5);
        box-shadow: none; /* Sin sombra */
    }
    body.dark-mode #bookmark-grid > div.config-empty-cell {
        background-color: rgba(80, 80, 80, 0.3); /* Gris oscuro transparente */
        border-color: rgba(100, 100, 100, 0.5);
        filter: brightness(70%);
    }

    /* Responsive Grid */
    @media (max-width: 768px) {
        #bookmark-grid { grid-template-columns: repeat(3, minmax(100px, 1fr)); gap: 10px; }
        main { width: calc(100% - 70px); } /* Ajuste ancho main */
    }
    @media (max-width: 480px) {
        #bookmark-grid { grid-template-columns: repeat(2, minmax(80px, 1fr)); gap: 8px; }
        main { width: calc(100% - 70px); } /* Ajuste ancho main */
    }

    /* --- Header/Footer/Avisos/Contador (Estilos originales restaurados) --- */
    .header-container { display: flex; align-items: center; justify-content: center; gap: 0.5rem; background-color: #ABAB99; padding: 0.5rem; border-radius: 0.5rem 0.5rem 0 0; /* Redondeo superior */ }
    body.dark-mode .header-container { background-color: #92927E; }
    .header-logo { width: 100px; height: 70px; transition: filter 0.2s ease; border-radius: 0.25rem; }
    body.dark-mode .header-logo { filter: brightness(85%); }
    .title-container { background-color: #ABAB99; padding: 0.5rem 1rem; border-radius: 0.5rem; display: inline-block; }
    body.dark-mode .title-container { background-color: #92927E; }
    .header-container h1 { color: #5C5C47; }
    body.dark-mode .header-container h1 { color: #3E3E2F; }
    .version-text { font-size: 0.75rem; color: #5C5C47; font-weight: normal; margin-left: 5px;}
    body.dark-mode .version-text { color: #C1C1A9; }

    footer { margin: 0.5rem auto; text-align: center; max-width: 984px; width: calc(100% - 70px); display: block; background-color: #ABAB99; margin-left: 60px; box-sizing: border-box; border-radius: 0.75rem; }
    body.dark-mode footer { background-color: #92927E; }
    .footer-content { color: #5C5C47; padding: 0 0.5rem 0.5rem 0.5rem; /* Padding ajustado sin el header */ margin: 0 auto; max-width: 100%; position: relative; }
    body.dark-mode .footer-content, body.dark-mode .footer-subtext, body.dark-mode .footer-link-green { color: #C1C1A9; }
    .footer-subtext { font-size: 0.75rem; margin-top: 0.25rem; text-align: center; }
    .footer-link-green { text-decoration: none; transition: color 0.2s ease; }
    .footer-link-green:hover { color: #3E3E2F; }
    body.dark-mode .footer-link-green:hover { color: #E6E6DC; }
    .footer-line { display: flex; justify-content: center; align-items: center; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.5rem; }

    .notices-icon-container { display: flex; align-items: center; /* justify-content: center; */ justify-content: flex-start; /* Alinea a la izquierda */ width: 100%; max-width: 984px; margin: 0.5rem auto 0.5rem 60px; /* Margen igual que main/footer */ position: relative; width: calc(100% - 70px); box-sizing: border-box; height: 3rem; /* Altura fija */ }
    .notice-off-icon { width: auto; height: 100%; /* Ocupa altura del contenedor */ align-self: center; cursor: pointer; transition: filter 0.3s ease; flex-shrink: 0; margin-right: 10px; /* Espacio a la derecha */ }
    body.dark-mode .notice-off-icon { filter: brightness(85%); }
    .notices-container { flex-grow: 1; overflow: hidden; display: flex; align-items: center; justify-content: center; height: 100%; }
    .notice-wrapper { width: 100%; height: 100%; overflow: hidden; position: relative; display: flex; align-items: center; justify-content: center; }
    .notice { color: #00ff00; font-weight: bold; white-space: nowrap; text-align: center; opacity: 0; animation: fadeInOut 14s infinite; font-size: 1.1rem; } /* Tamaño aviso */
    @keyframes fadeInOut { 0% { opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { opacity: 0; } }

    .counter-wrapper { margin: 0.5rem auto 0 60px; text-align: center; max-width: 984px; width: calc(100% - 70px); display: block; opacity: 0.5; box-sizing: border-box; }
    .counter-container { display: flex; justify-content: center; align-items: center; flex-direction: column; margin-top: 0; /* Sin margen extra */ }

    .top-text-container { display: flex; align-items: center; justify-content: center; font-size: clamp(0.6rem, 1.5vw, 0.75rem); color: #5C5C47; background-color: #D1D5DB; margin: 0 auto 0.5rem 60px; /* Margen arriba/abajo */ gap: 0.5rem; padding: 0.25rem 0.5rem; border-radius: 0.25rem; animation: fadeOut 6s forwards; max-width: 984px; width: calc(100% - 70px); box-sizing: border-box; }
    body.dark-mode .top-text-container { background-color: #6B7280; color: #C1C1A9;}
    .top-text-container span { color: #D9A066; font-size: clamp(0.9rem, 2vw, 1.2rem); }
    @keyframes fadeOut { 0% { opacity: 1; } 80% { opacity: 1; } 100% { opacity: 0; display: none; } }
    .arrow-button { width: clamp(36px, 6vw, 48px); height: clamp(36px, 6vw, 48px); background-color: #D9A066; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3); transition: background-color 0.2s ease; }
    .arrow-button:hover { background-color: #5C5C47; }
    .arrow-button svg { stroke: #E6E6DC; }

    /* --- Botones Laterales (Estilos originales restaurados) --- */
    /* Scroll Toggle */
    .scroll-toggle-button { position: fixed; width: 91px; height: clamp(78.2px, 19.55vw, 175.95px); background-color: #668B8B; border-radius: 60px; display: flex; flex-direction: column; align-items: center; justify-content: space-between; padding: clamp(10px, 2vw, 20px); cursor: pointer; box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3); z-index: 1000; transition: background-color 0.2s ease, opacity 0.3s, visibility 0.3s, top 0.2s ease-out; left: 10px; top: 10px; /* Posición inicial */ box-sizing: border-box; }
    .scroll-toggle-button:hover { background-color: #D9A066; }
    .scroll-toggle-button svg { width: clamp(24px, 4vw, 32px); height: clamp(24px, 4vw, 32px); stroke: #E6E6DC; }
    body.dark-mode .scroll-toggle-button { background-color: #5C5C47; }
    body.dark-mode .scroll-toggle-button:hover { background-color: #D9A066; }

    /* Toggle Sign (para filtros, reload, home, config, weather, reminder, zoom) */
    .toggle-sign { position: fixed; width: 91px; height: 54px; border-radius: 20px; background-color: #668B8B; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.25rem; color: #E6E6DC; text-align: center; cursor: pointer; z-index: 1000; transition: background-color 0.2s ease, filter 0.2s ease, opacity 0.3s, visibility 0.3s, top 0.2s ease-out; left: 10px; box-sizing: border-box; overflow: hidden; box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3); }
    .toggle-sign:hover { background-color: #D9A066; }
    .toggle-sign .sign { font-size: 1.5rem; margin-right: 3px; min-width: 12px; display: inline-block; text-align: center; }
    .toggle-sign img { max-width: calc(100% - 10px); max-height: calc(100% - 10px); object-fit: contain; }
    body.dark-mode .toggle-sign { background-color: #5C5C47; }
    body.dark-mode .toggle-sign:hover { background-color: #D9A066; }

    /* Toggle Image (para on/off, dark mode) */
    .toggle-image { position: fixed; width: 91px; height: 54px; cursor: pointer; z-index: 1000; transition: filter 0.2s ease, opacity 0.3s, visibility 0.3s, top 0.2s ease-out; left: 10px; border-radius: 20px; object-fit: cover; box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3); }
    .toggle-image:hover { filter: brightness(80%); }
    body.dark-mode .toggle-image#on-off-toggle { filter: brightness(85%); }
    body.dark-mode .toggle-image#dark-mode-toggle { filter: brightness(85%); } /* Apply filter to dark mode toggle image */

    /* Colores específicos botones (Light Mode) - Restaurados */
    body:not(.dark-mode) .toggle-sign.range-toggle[data-state="visible"] { background-color: #006400; }
    body:not(.dark-mode) .toggle-sign.range-toggle[data-state="hidden"] { background-color: #696969; }
    body:not(.dark-mode) #reload-button { background-color: #5DA8D6; }
    body:not(.dark-mode) #home-button { background-color: #5DA8D6; }
    body:not(.dark-mode) #weather-button { background-color: #FBBF24; }
    body:not(.dark-mode) #zoom-button { background-color: #F97316; }
    body:not(.dark-mode) #zoom-button.zoomed { background-color: #C2410C; }
    body:not(.dark-mode) #reminder-button { background-color: #4DA7A7; }
    body:not(.dark-mode) #config-button { background-color: #ABAB99; }

    /* Colores específicos botones (Dark Mode) - Restaurados */
    body.dark-mode .toggle-sign.range-toggle[data-state="visible"] { background-color: #166534; }
    body.dark-mode .toggle-sign.range-toggle[data-state="hidden"] { background-color: #4B5563; }
    body.dark-mode #reload-button { background-color: #0e7490; }
    body.dark-mode #home-button { background-color: #0e7490; }
    body.dark-mode #weather-button { background-color: #b45309; }
    body.dark-mode #zoom-button { background-color: #c2410c; }
    body.dark-mode #zoom-button.zoomed { background-color: #7c2d12; }
    body.dark-mode #reminder-button { background-color: #4DA7A7; } /* Mismo color en dark por ahora */
    body.dark-mode #config-button { background-color: #92927E; }
    body.dark-mode #config-button img { filter: brightness(85%); }

    /* Contador Recordatorios */
    #reminder-button { position: relative; /* Needed for absolute positioning of count */ }
    #reminder-button .reminder-count { position: absolute; top: 4px; left: 4px; font-size: 0.65rem; color: #FFFFFF; background-color: #EF4444; border-radius: 50%; width: 18px; height: 18px; display: none; /* Oculto hasta que haya > 0 */ align-items: center; justify-content: center; font-weight: bold; box-shadow: 0 0 3px rgba(0,0,0,0.5); z-index: 1; }

    /* --- Utilidades y Modos --- */
    .hidden { display: none !important; visibility: hidden !important; opacity: 0 !important; pointer-events: none !important; }
    .footer-hidden { display: none !important; } /* Para ocultar contenido del footer */

    /* Dark Mode - General Effects */
    body.dark-mode .bookmark-item { filter: brightness(60%); }

    /* Minimal Mode - Selectores Cuidadosos */
    body.minimal-mode main,
    body.minimal-mode footer,
    body.minimal-mode .notices-icon-container,
    body.minimal-mode .counter-wrapper,
    body.minimal-mode .top-text-container,
    body.minimal-mode #scroll-toggle,
    body.minimal-mode .range-toggle, /* Oculta botones de filtro */
    body.minimal-mode #weather-button,
    body.minimal-mode #reminder-button,
    body.minimal-mode #zoom-button,
    body.minimal-mode #dark-mode-toggle, /* Oculta toggle dark */
    body.minimal-mode #reload-button,
    body.minimal-mode #home-button,
    body.minimal-mode #reminder-notifications {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
    }
    /* Excepciones: Botones que SÍ se ven en minimal mode */
    body.minimal-mode #on-off-toggle { display: block !important; visibility: visible !important; opacity: 0.3 !important; filter: none !important; } /* Visible pero atenuado */
    body.minimal-mode #config-button { display: flex !important; visibility: visible !important; opacity: 1 !important; } /* Totalmente visible */
    /* Mensaje Minimal Mode */
    .minimal-mode-message { color: #000000; font-size: 1rem; font-weight: bold; position: fixed; top: 70px; left: 10px; z-index: 1100; background: rgba(255, 255, 255, 0.7); padding: 5px; border-radius: 5px; }
    body.dark-mode .minimal-mode-message { color: #FFFFFF; background: rgba(0, 0, 0, 0.7); }

    /* --- Recordatorios y Configuración (Estilos sin cambios grandes) --- */
    /* Recordatorios */
    .reminder-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: #F3F4F6; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); z-index: 2000; max-width: 400px; width: 90%; color: #111827; }
    .reminder-modal.dark-mode { background-color: #4B5563; color: #F3F4F6; }
    .reminder-modal h2 { font-size: 1.25rem; font-weight: bold; margin-bottom: 1rem; }
    .reminder-modal label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
    .reminder-modal input, .reminder-modal textarea { width: 100%; padding: 0.5rem; margin-bottom: 1rem; border: 1px solid #D1D5DB; border-radius: 0.25rem; background-color: #FFFFFF; color: #111827; box-sizing: border-box; }
    .reminder-modal.dark-mode input, .reminder-modal.dark-mode textarea { background-color: #6B7280; color: #F3F4F6; border-color: #9CA3AF; }
    .reminder-modal .button-group { display: flex; justify-content: flex-end; gap: 1rem; }
    .reminder-modal button { padding: 0.5rem 1rem; border-radius: 0.25rem; cursor: pointer; border: none; }
    .reminder-modal button[type="submit"] { background-color: #2563EB; color: #FFFFFF; }
    .reminder-modal.dark-mode button[type="submit"] { background-color: #3B82F6; }
    .reminder-modal button[type="button"] { background-color: #D1D5DB; color: #111827; }
    .reminder-modal.dark-mode button[type="button"] { background-color: #4B5563; color: #F3F4F6; }
    .reminder-modal button.delete-reminder { background-color: #EF4444; color: #FFFFFF; margin-left: 0.5rem; padding: 0.25rem 0.5rem; font-size:0.8rem; }
    .reminder-modal.dark-mode button.delete-reminder { background-color: #DC2626; }
    .reminder-modal button.modify-reminder { background-color: #10B981; color: #FFFFFF; margin-left: 0.5rem; padding: 0.25rem 0.5rem; font-size:0.8rem; }
    .reminder-modal.dark-mode button.modify-reminder { background-color: #059669; }
    #reminder-notifications { position: fixed; top: 10px; right: 10px; z-index: 1500; max-width: 300px; width: 90%; }
    .reminder-notification { background-color: #FFFF99; padding: 1rem; margin-bottom: 0.5rem; border-radius: 0.25rem; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); display: flex; flex-direction: column; gap: 0.5rem; color: #333; }
    .reminder-notification.dark-mode { background-color: #FDE047; color: #1F2937; }
    .reminder-notification p { margin: 0; font-size: 1rem; color: #1E40AF; }
    .reminder-notification.dark-mode p { color: #172554; }
    .reminder-notification .button-group { display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 0.5rem; }
    .reminder-notification button { padding: 0.25rem 0.5rem; border-radius: 0.25rem; cursor: pointer; font-size: 0.8rem; border: none; color: #FFFFFF; }
    .reminder-notification button.cancel { background-color: #EF4444; }
    .reminder-notification button.modify { background-color: #10B981; }
    .reminder-notification button.postpone { background-color: #F59E0B; }
    .reminder-notification.dark-mode button.cancel { background-color: #DC2626; }
    .reminder-notification.dark-mode button.modify { background-color: #059669; }
    .reminder-notification.dark-mode button.postpone { background-color: #D97706; }

    /* Modo Configuración */
    .config-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); z-index: 2500; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; color: white; }
    .config-modal { background-color: #ABAB99; padding: 2rem; border-radius: 0.75rem; box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2); max-width: 90%; max-height: 90vh; overflow-y: auto; text-align: center; color: #333; }
    .config-modal.dark-mode { background-color: #92927E; color: #E6E6DC; }
    .config-modal h2 { margin-bottom: 1.5rem; font-size: 1.5rem; font-weight: bold; }
    .config-modal p { margin-bottom: 1rem; }
    .config-modal button, .config-modal .config-toggle-button { background-color: #668B8B; color: #E6E6DC; padding: 0.75rem 1.25rem; border: none; border-radius: 0.375rem; cursor: pointer; margin: 0.5rem; transition: background-color 0.2s ease; font-size: 1rem; }
    .config-modal button:hover, .config-modal .config-toggle-button:hover { background-color: #D9A066; }
    .config-modal.dark-mode button, .config-modal.dark-mode .config-toggle-button { background-color: #5C5C47; }
    .config-modal.dark-mode button:hover, .config-modal.dark-mode .config-toggle-button:hover { background-color: #D9A066; }
    .config-modal .cancel-button { background-color: #EF4444; }
    .config-modal.dark-mode .cancel-button { background-color: #B91C1C; }
    .config-modal .save-button { background-color: #10B981; }
    .config-modal.dark-mode .save-button { background-color: #059669; }

    /* Grid en Modo Selección Items */
    body.selecting-items-mode #bookmark-grid { border: 3px dashed #D9A066 !important; background-color: rgba(217, 160, 102, 0.1); z-index: 1; padding: 5px; /* Add padding for border */ }
    body.selecting-items-mode #bookmark-grid > div { cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.3s ease, border-color 0.2s ease; opacity: 0.6; border-width: 2px; border-style: solid; border-color: transparent; }
    body.dark-mode.selecting-items-mode #bookmark-grid > div { opacity: 0.5; }
    body.selecting-items-mode #bookmark-grid > div:not(.config-empty-cell):hover { transform: scale(1.05); opacity: 0.8; }
    body.dark-mode.selecting-items-mode #bookmark-grid > div:not(.config-empty-cell):hover { opacity: 0.7; }
    body.selecting-items-mode #bookmark-grid > div.config-selected { opacity: 1 !important; border-color: #2563EB !important; box-shadow: 0 0 10px rgba(37, 99, 235, 0.7); transform: scale(1.02); }
    body.dark-mode.selecting-items-mode #bookmark-grid > div.config-selected { border-color: #60A5FA !important; box-shadow: 0 0 10px rgba(96, 165, 250, 0.7); }
    body.selecting-items-mode #bookmark-grid > div.config-empty-cell { opacity: 0.2 !important; cursor: not-allowed; background-color: rgba(128, 128, 128, 0.3) !important; border-color: rgba(150, 150, 150, 0.5) !important; }
    body.dark-mode.selecting-items-mode #bookmark-grid > div.config-empty-cell { background-color: rgba(0, 0, 0, 0.3) !important; border-color: rgba(100, 100, 100, 0.5) !important; }

    /* Ocultar botones en Modo Configuración */
    body.config-mode .scroll-toggle-button,
    body.config-mode .toggle-image:not(#dark-mode-toggle),
    body.config-mode .toggle-sign:not(#config-button),
    body.config-mode #reminder-notifications,
    body.config-mode .top-text-container { display: none !important; visibility: hidden !important; }
    body.config-mode #dark-mode-toggle { display: block !important; visibility: visible !important; z-index: 2600; }
    body.config-mode #config-button { display: flex !important; visibility: visible !important; z-index: 2600; }

</style>
</head>
<body class=""> <!-- Clase dark-mode se añadirá con JS -->
    <!-- Contenedor de Texto Superior -->
    <div class="top-text-container">
        <div class="arrow-button" id="back-button">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
        </div>
        <span>[ Web anterior o posterior arrastre hacia los bordes ]</span>
        <div class="arrow-button" id="forward-button">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
        </div>
    </div>

    <!-- Contenido Principal -->
    <main>
        <div id="bookmark-grid">
            <!-- Populated by JavaScript -->
        </div>
    </main>

     <!-- Avisos y Footer -->
    <div class="notices-icon-container">
        <img src="https://boardinggate.github.io/Tesla/IMG_4194.jpg" alt="Toggle Avisos" class="notice-off-icon" id="notice-toggle-icon">
        <div class="notices-container">
            <div class="notice-wrapper">
                <span class="notice" id="current-notice"></span>
            </div>
        </div>
    </div>

    <footer>
         <!-- Header ahora DENTRO del footer para agrupar -->
        <div class="header-container">
            <img src="https://boardinggate.github.io/Tesla/LOGOTESLA.jpg" class="header-logo">
            <div class="title-container">
                <h1 class="text-2xl font-bold inline">
                    <span class="text-2xl">BoardingGate</span>
                    <span class="text-base">Lanzador</span>
                    <span id="version" class="version-text"></span>
                </h1>
            </div>
        </div>
        <div class="footer-content">
            <div class="footer-line">
                <a href="https://x.com/boardinggate?s=21" class="footer-link-green" target="_blank" rel="noopener noreferrer">@BoardingGate</a>
                <span class="text-green-200" style="font-size: 1.5rem;">🤝</span>
                <a href="https://x.com/boardinggate/status/1857325553742721116?s=46" class="footer-link-green" target="_blank" rel="noopener noreferrer">Ahorremos un dinero con mis REFERIDOS</a>
            </div>
            <p class="footer-subtext">La inteligencia tiene ciertas limitaciones. La locura, casi ninguna 🫶 🤟</p>
        </div>
    </footer>

    <!-- Contador -->
    <div class="counter-wrapper">
        <div class="counter-container">
            <div id="sfcg896pbr68y2dejczgbn1ys664xjxdf2d"></div>
            <script type="text/javascript" src="https://counter4.optistats.ovh/private/counter.js?c=g896pbr68y2dejczgbn1ys664xjxdf2d&down=async" async></script>
        </div>
    </div>

     <!-- Botón Scroll (Estático HTML, clase base eliminada aquí) -->
    <div id="scroll-toggle" class="scroll-toggle-button" title="Ir al inicio o fin">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19V5M5 12l7-7 7 7"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14M19 12l-7 7-7-7"/></svg>
    </div>
    <!-- Resto de botones laterales se añadirán aquí por JS -->

    <!-- Contenedor Notificaciones Recordatorios -->
    <div id="reminder-notifications"></div>

    <!-- Script Principal -->
    <script>
        // === Constants and Global Variables ===
        const bookmarks = [
            { name: "YouTube", url: "https://www.youtube.com" },
            { name: "Google", url: "https://www.google.com" },
            { name: "GDrive", url: "https://drive.google.com", favicon: "./IMG_4172.png" },
            { name: "GMail", url: "https://mail.google.com/mail/mu/mp/603/#tl/Recibidos", favicon: "./IMG_4171.png"},
            { name: "Google Fotos", url: "https://photos.google.com" },
            { name: "iCloud", url: "https://www.icloud.com/", favicon: "https://www.google.com/s2/favicons?domain=icloud.com&sz=64" },
            { name: "ABRP", url: "https://abetterrouteplanner.com" },
            { name: "ElectroMaps", url: "https://map.electromaps.com/es/", favicon: "https://www.google.com/s2/favicons?domain=electromaps.com&sz=64" },
            { name: "REVE PdR España", url: "https://www.mapareve.es/mapa-puntos-recarga", favicon: "https://www.google.com/s2/favicons?domain=mapareve.es&sz=64" },
            { name: "PdR,s", url: "https://www.google.com/maps/search/puntos+recarga+veh%C3%ADculos+el%C3%A9ctricos", favicon: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M12 18h8v2h-8v-2z'/><path d='M12 14h8v2h-8v-2z'/><path d='M12 10h8v2h-8v-2z'/><path d='M12 6h8v2h-8V6z'/><path d='M4 18h4v-2H4v2zM4 14h4v-2H4v2zM4 10h4v-2H4v2zM4 6h4V4H4v2z'/></svg>" },
            { name: "Google Maps", url: "https://maps.google.com" },
            { name: "", url: "https://www.ventusky.com/?p=40.2;-4.7;5&l=rain-3h" }, // Ventusky (sin nombre)
            { name: "TESSIE", url: "https://dash.tessie.com/signin", favicon: "https://www.google.com/s2/favicons?domain=tessie.com&sz=64" },
            { name: "Mis Updates", url: "https://dash.tessie.com/software", favicon: "https://cdn-icons-png.flaticon.com/512/148/148767.png" },
            { name: "Olas Updates", url: "https://es.stats.tessie.com/", favicon: "https://cdn-icons-png.flaticon.com/512/5815/5815902.png" },
            { name: "NotaTeslaApp", url: "https://www.notateslaapp.com/software-updates/" },
            { name: "ENHAUTO", url: "https://www.enhauto.com" },
            { name: "MAREAS", url: "https://www.meteogalicia.gal/web/predicion/mareas-e-luas" },
            { name: "ELECTROVERSE", url: "https://electroverse.com/es/map", favicon: "https://www.google.com/s2/favicons?domain=electroverse.com&sz=64" }, // ÍNDICE 18
            { name: "ACCIONA", url: "https://www.google.com/maps/search/recarga+Acciona", favicon: "https://www.google.com/s2/favicons?domain=acciona.com&sz=64" },
            { name: "IBERDROLA", url: "https://www.google.com/maps/search/recarga+IBERDROLA", favicon: "https://www.google.com/s2/favicons?domain=iberdrola.com&sz=64" },
            { name: "WAYLET Repsol", url: "https://www.google.com/maps/search/recarga+REPSOL+Waylet", favicon: "https://www.google.com/s2/favicons?domain=repsol.com&sz=64" },
            { name: "ENDESA xWay", url: "https://www.google.com/maps/search/recarga+ENDESA+XWAY", favicon: "https://www.google.com/s2/favicons?domain=endesa.com&sz=64" },
            { name: "ZUNDER", url: "https://www.google.com/maps/search/recarga+ZUNDER", favicon: "https://www.google.com/s2/favicons?domain=zunder.com&sz=64" },
            { name: "IONITY", url: "https://www.google.com/maps/search/recarga+IONITY", favicon: "https://www.google.com/s2/favicons?domain=ionity.eu&sz=64" },
            { name: "WENEA", url: "https://www.google.com/maps/search/recarga+WENEA", favicon: "https://www.google.com/s2/favicons?domain=wenea.com&sz=64" },
            { name: "T.ENERGIES", url: "https://www.google.com/maps/search/recarga+TOTAL+ENERGIES", favicon: "https://www.google.com/s2/favicons?domain=totalenergies.com&sz=64" },
            { name: "GALP", url: "https://www.google.com/maps/search/recarga+GALP", favicon: "https://www.google.com/s2/favicons?domain=galp.com&sz=64" },
            { name: "MIIO", url: "https://miio.com", favicon: "https://www.google.com/s2/favicons?domain=miio.com&sz=64" }, // ÍNDICE 29
            { name: "EVDC", url: "https://evdc.network", favicon: "https://www.google.com/s2/favicons?domain=evdc.network&sz=64" }, // ÍNDICE 30
            { name: "GROK", url: "https://grok.com/?referrer=website" },
            { name: "CHATGPT", url: "https://chat.openai.com" },
            { name: "CLAUDE", url: "https://claude.ai/new" },
            { name: "GEMINI", url: "https://gemini.google.com" },
            { name: "NOTEBOOKLM", url: "https://notebooklm.google.com" }, // ÍNDICE 35
            { name: "Batería", url: "https://docs.google.com/spreadsheets/d/1bLZmgVGTBqg2bS2E45JpORjs9eK2nb05AWXYLLDY-RI/edit?gid=1398548891#gid=1398548891", favicon: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><circle cx='12' cy='12' r='10'/><polyline points='12 6 12 12 16 14'/></svg>" },
             null, null, null, null, null, // ÍNDICE 41
            { name: "TeslaParaTodos", url: "https://teslaparatodos.com/cine/" }, // ÍNDICE 42
            { name: "BetterTheater", url: "https://abettertheater.com", favicon: "https://www.google.com/s2/favicons?domain=abettertheater.com&sz=64" },
            { name: "Filmin", url: "https://www.filmin.es/catalogo/peliculas" },
            { name: "Octopus", url: "https://octopus.energy/dashboard" },
            { name: "App MCE", url: "https://www.oscarabilleira.com/app-mi-coche-electrico/#ayuda" },
            { name: "Patrón Luz", url: "https://docs.google.com/spreadsheets/d/1R7UUZ9i4BAYWAGAX6PQT1WGd12GEZ4Ja/edit?usp=sharing&ouid=108345701896498198132&rtpof=true&sd=true" },
            { name: "TradingView", url: "https://es.tradingview.com/chart/t5g9UFG0/" },
            { name: "Inicio Tesla" }, // Placeholder, sin URL
            { name: "Twitter", url: "https://x.com" },
            { name: "Maesal Detailer", url: "https://www.maesaldetailer.es/" },
            { name: "Superchargers", url: "https://www.tesla.com/es_es/findus?bounds=45.41107111786193%2C19.27853056943938%2C29.703668286784747%2C-16.64676239931062" },
            { name: "TESLA web", url: "https://www.tesla.com/es_es" },
            { name: "Manual M3", url: "https://www.tesla.com/ownersmanual/model3/es_es/" },
            { name: "de Servicio", url: "https://service.tesla.com/docs/Model3/ServiceManual/2024/es-es/" },
            { name: "de Despiece", url: "https://epc.tesla.com/es-MX/catalogs/e0e07c3d-272f-4d06-b8b6-9e92f857e5f3" },
            { name: "de Usted Mismo", url: "https://www.tesla.com/es_es/support/do-it-yourself-guides" },
            { name: "de Filtro Cabina", url: "https://service.tesla.com/docs/Public/diy/model3/es_es/GUID-DB0A1E3C-926E-498C-A2FD-A27B8421A471.html" }, // ÍNDICE 59
            { name: "de Móvil remoto", url: "https://service.tesla.com/docs/Public/diy/model3/es_es/GUID-53651B16-A2E3-4118-933E-B5F41C74D433.html" }, // ÍNDICE 60
            { name: "Waze (consultas)", url: "https://www.waze.com/es/live-map/", favicon: "https://www.google.com/s2/favicons?domain=waze.com&sz=64" },
            { name: "AMAZON", url: "https://www.amazon.es" },
            { name: "BIP&DRIVE", url: "https://areaprivada.bipdrive.com/login" },
            { name: "ITV Cita", url: "https://www.sycitv.com/es/cita-previa-particulares/", favicon: "https://boardinggate.github.io/Tesla/itv.png" },
            null, null,
            { name: "Jaime Odena", url: "https://www.youtube.com/@JOdena", favicon: "https://www.youtube.com/favicon.ico" },
            { name: "Eduardo Arcos", url: "https://www.youtube.com/@earcos", favicon: "https://www.youtube.com/favicon.ico" },
            { name: "AutoIngenium", url: "https://www.youtube.com/@AutoIngenium", favicon: "https://www.youtube.com/favicon.ico" },
            { name: "Gallego en Munich", url: "https://www.youtube.com/@ungallegoenmunich", favicon: "https://www.youtube.com/favicon.ico" },
            { name: "Electromiaumiau", url: "https://www.youtube.com/@electromiaumiau", favicon: "https://www.youtube.com/favicon.ico" },
            { name: "Manuel Martos", url: "https://www.youtube.com/@Manuel_Martos", favicon: "https://www.youtube.com/favicon.ico" },
            { name: "Todos Electricos", url: "https://www.youtube.com/@TodosElectricos", favicon: "https://www.youtube.com/favicon.ico" },
            { name: "Juan Vidal Haces", url: "https://www.youtube.com/@JuanVidalHaces", favicon: "https://www.youtube.com/favicon.ico" },
            { name: "Ruedana", url: "https://www.youtube.com/@ruedana", favicon: "https://www.youtube.com/favicon.ico" },
            { name: "STR-600", url: "https://www.youtube.com/@STR-600", favicon: "https://www.youtube.com/favicon.ico" },
            { name: "Juanjo T. Aventuras", url: "https://www.youtube.com/@juanjoteslaventuras", favicon: "https://www.youtube.com/favicon.ico" },
            { name: "Carlos Cuezva", url: "https://www.youtube.com/@CarlosCuezva", favicon: "https://www.youtube.com/favicon.ico" },
            { name: "Javi Manzanoo", url: "https://www.youtube.com/@javimanzanoo", favicon: "https://www.youtube.com/favicon.ico" },
            { name: "Crifedi", url: "https://www.youtube.com/@Crifedi", favicon: "https://www.youtube.com/favicon.ico" },
            { name: "Tescno Tesla", url: "https://www.youtube.com/@TecnoTesla", favicon: "https://www.youtube.com/favicon.ico" },
            { name: "Full Electric Mex", url: "https://www.youtube.com/@FullElectricMexico", favicon: "https://www.youtube.com/favicon.ico" },
            null,
            null,
            { name: "La iA Jon", url: "https://www.youtube.com/@la_inteligencia_artificial", favicon: "https://www.youtube.com/favicon.ico" },
            { name: "JF Ccalero", url: "https://www.youtube.com/@jfcalero", favicon: "https://www.youtube.com/favicon.ico" },
            { name: "Visual Politik", url: "https://www.youtube.com/@VisualPolitik", favicon: "https://www.youtube.com/favicon.ico" },
            { name: "Fabian Barrio", url: "https://www.youtube.com/@fabiancbarrio", favicon: "https://www.youtube.com/favicon.ico" },
            { name: "Loquetudigas", url: "https://www.youtube.com/@Loquetudigas", favicon: "https://www.youtube.com/favicon.ico" },
            { name: "David Antunes", url: "https://www.youtube.com/@davidantunesmusic", favicon: "https://www.youtube.com/favicon.ico" },
            { name: "TheWildProject", url: "https://www.youtube.com/@TheWildProject", favicon: "https://www.youtube.com/favicon.ico" },
            { name: "Estas Tonne", url: "https://www.youtube.com/@Estastonne", favicon: "https://www.youtube.com/favicon.ico" },
            { name: "BBC6 Music", url: "https://www.youtube.com/@BBC6Music", favicon: "https://www.youtube.com/favicon.ico" }, // ÍNDICE 94
            null // ÍNDICE 95
        ];
        const TOTAL_CELLS = 96;
        const COLS = 6;
        const grid = document.getElementById('bookmark-grid');
        const cellElements = [];
        let createdToggleButtons = [];
        let sideButtons = [];

        // --- State Variables ---
        let isDarkMode = false;
        let isMinimalMode = false; // Default to normal
        let isConfigMode = false;
        let isActive = true; // Notices
        let isFooterVisible = true; // Footer
        let pressStartTime = null;
        let reminderPressStartTime = null;
        let notices = [];
        let currentNoticeIndex = 0;

        // --- Config State ---
        let customToggleConfigs = {};
        let currentConfiguringToggle = null;
        let currentConfigIndices = [];

        // --- Toggle Definitions ---
        const toggleRanges = [
            { id: "toggle-pdr", start: 18, end: 29, defaultLabel: "PdR,s" },
            { id: "toggle-ias", start: 30, end: 41, defaultLabel: "iAs" },
            { id: "toggle-util", start: 42, end: 59, defaultLabel: "Útil" },
            { id: "toggle-varios", start: 60, end: 95, defaultLabel: "Varios" }
        ];

        // === Helper Functions ===
        const clamp = (min, val, max) => Math.min(Math.max(val, min), max);
        const checkDarkModeTime = () => { const h = new Date().getHours(); return h >= 21 || h < 7; };

        // === Settings Management ===
        function loadCustomToggleConfigs() {
            const saved = localStorage.getItem('customToggleConfigs');
            customToggleConfigs = {};
            if (saved) { try { const p = JSON.parse(saved); if (typeof p === 'object' && p !== null) customToggleConfigs = p; } catch(e) { console.error("Err parsing custom toggles", e); }}
            // console.log("Loaded custom toggles:", JSON.stringify(customToggleConfigs));
        }
        function saveCustomToggleConfigs() {
            localStorage.setItem('customToggleConfigs', JSON.stringify(customToggleConfigs));
            // console.log("Saved custom toggles:", JSON.stringify(customToggleConfigs));
        }
        function saveSettings() {
            localStorage.setItem('darkMode', JSON.stringify(isDarkMode));
            localStorage.setItem('minimalMode', JSON.stringify(isMinimalMode));
            const tStates = {}; createdToggleButtons.forEach(t => { if(t.dataset.toggleId) tStates[t.dataset.toggleId] = t.dataset.state; }); localStorage.setItem('toggleStates', JSON.stringify(tStates));
            const zb = document.getElementById('zoom-button'); if(zb) localStorage.setItem('zoomState', zb.dataset.zoomState);
            const oot = document.getElementById('on-off-toggle'); if(oot) localStorage.setItem('onOffState', oot.dataset.state);
            localStorage.setItem('noticesActive', JSON.stringify(isActive)); localStorage.setItem('footerVisible', JSON.stringify(isFooterVisible));
            // console.log("Settings saved.");
        }

        function loadSavedSettings() {
            console.log("Loading saved settings...");
            // Read storage
            const sDarkMode = localStorage.getItem('darkMode'); const sMinimal = localStorage.getItem('minimalMode'); const sZoom = localStorage.getItem('zoomState');
            const sOnOff = localStorage.getItem('onOffState'); const sNotices = localStorage.getItem('noticesActive'); const sFooter = localStorage.getItem('footerVisible');
            const sToggles = localStorage.getItem('toggleStates');

            // Determine initial JS state (use defaults)
            isDarkMode = sDarkMode ? JSON.parse(sDarkMode) : checkDarkModeTime();
            isMinimalMode = sMinimal ? JSON.parse(sMinimal) : false; // CRITICAL: Default is FALSE
            isActive = sNotices ? JSON.parse(sNotices) : true;
            isFooterVisible = sFooter ? JSON.parse(sFooter) : true;

            // Load custom toggle configs (needed before applying states)
            loadCustomToggleConfigs();

            // Apply state to buttons DATASET (visuals applied later)
            const zoomBtn = document.getElementById('zoom-button'); if(zoomBtn) zoomBtn.dataset.zoomState = sZoom || 'off';
            const onOffBtn = document.getElementById('on-off-toggle'); if(onOffBtn) onOffBtn.dataset.state = sOnOff || 'on';
            let toggleStates = {}; if (sToggles) { try { toggleStates = JSON.parse(sToggles); } catch(e){} }
            createdToggleButtons.forEach(toggle => {
                if(toggle.dataset.toggleId) toggle.dataset.state = toggleStates[toggle.dataset.toggleId] || 'visible';
            });

            // Load reminder data
            loadReminders();
            console.log("Finished loading settings state. isMinimalMode:", isMinimalMode);
        }

        // === Mode Toggling ===
        function toggleMinimalMode(enable) {
            console.log("Setting Minimal Mode Visuals:", enable);
            isMinimalMode = enable; // Ensure state is current
            document.body.classList.toggle('minimal-mode', enable);
            const msg = document.getElementById('minimal-mode-message');
            if (enable) {
                if (!msg) { /* create message */ }
                 // Explicitly hide elements affected by minimal mode CSS
                 document.querySelector('main')?.classList.add('hidden');
                 document.querySelector('footer')?.classList.add('hidden');
                 document.querySelector('.notices-icon-container')?.classList.add('hidden');
                 document.querySelector('.counter-wrapper')?.classList.add('hidden');
                 document.querySelector('.top-text-container')?.classList.add('hidden');
                 document.getElementById('reminder-notifications')?.classList.add('hidden');
            } else {
                if (msg) msg.remove();
                 // Explicitly show elements (if they should be visible based on other flags)
                 document.querySelector('main')?.classList.remove('hidden');
                toggleFooterVisibility(); // This handles footer/notices/counter based on isActive/isFooterVisible
                 document.querySelector('.top-text-container')?.classList.remove('hidden');
                 document.getElementById('reminder-notifications')?.classList.remove('hidden');
            }
            adjustButtonPositions(); // Adjust visibility/position of side buttons
            // Save setting might happen outside if called by user action
        }

        function exitConfigurationMode() {
             if (document.body.classList.contains('selecting-items-mode')) exitItemSelectionMode();
             const overlay = document.getElementById('config-overlay'); if (overlay) document.body.removeChild(overlay);
             document.body.classList.remove('config-mode'); document.body.style.overflow = ''; isConfigMode = false;
             adjustButtonPositions(); // Re-show normal buttons
        }
        // ... other config functions ...
        function showConfigMenu() { /* ... (implementation) ... */ }
        function showToggleSelectionMenu() { /* ... (implementation) ... */ }
        function startToggleConfiguration(toggleId) { /* ... (implementation) ... */ }
        function handleGridItemClickInConfig(event) { /* ... (implementation) ... */ }
        function saveToggleConfiguration(toggleId, newLabel) { /* ... (implementation) ... */ }
        function exitItemSelectionMode() { /* ... (implementation) ... */ }


        // === UI Updates ===
        function applyZoom(state) {
             const zoomBtn = document.getElementById('zoom-button'); if (!zoomBtn) return;
             const gridCells = document.querySelectorAll('#bookmark-grid > div');
             const bkImgs = document.querySelectorAll('.bookmark-item img'); const bkNames = document.querySelectorAll('.bookmark-name');
             const smImgs = document.querySelectorAll('.small-bookmark img'); const smNames = document.querySelectorAll('.small-bookmark .bookmark-name');
             const origW = 984, adjW = 935, origC = 6, zoomC = 4, gap = 15; const zCellW = (adjW - (zoomC - 1) * gap) / zoomC;

             if (state === 'on') {
                 grid.style.gridTemplateColumns = `repeat(${zoomC}, ${zCellW}px)`; grid.style.maxWidth = `${adjW}px`;
                 gridCells.forEach(c => c.style.aspectRatio = '16 / 9');
                 bkImgs.forEach(i => { i.style.width='48px'; i.style.maxWidth='56px'; i.style.height='48px'; i.style.maxHeight='56px'; });
                 bkNames.forEach(n => n.style.fontSize = 'clamp(1.05rem, 1.8vw, 1.35rem)');
                 smImgs.forEach(i => { i.style.width='48px'; i.style.maxWidth='56px'; i.style.height='48px'; i.style.maxHeight='56px'; });
                 smNames.forEach(n => n.style.fontSize = 'clamp(1.05rem, 1.8vw, 1.35rem)');
                 zoomBtn.innerHTML = `<img src="./zoon+.png" alt="Zoom In">`; zoomBtn.classList.add('zoomed');
             } else {
                 grid.style.gridTemplateColumns = `repeat(${origC}, minmax(120px, 1fr))`; grid.style.maxWidth = `${origW}px`;
                 gridCells.forEach(c => c.style.aspectRatio = '16 / 9');
                 bkImgs.forEach(i => { i.style.width='36px'; i.style.maxWidth='40px'; i.style.height='36px'; i.style.maxHeight='40px'; });
                 bkNames.forEach(n => n.style.fontSize = 'clamp(0.80rem, 1.4vw, 1.10rem)');
                 smImgs.forEach(i => { i.style.width='24px'; i.style.maxWidth='28px'; i.style.height='24px'; i.style.maxHeight='28px'; });
                 smNames.forEach(n => n.style.fontSize = 'clamp(0.80rem, 1.4vw, 1.10rem)');
                 zoomBtn.innerHTML = `<img src="./zoon-.png" alt="Zoom Out">`; zoomBtn.classList.remove('zoomed');
             }
        }
        function updateButtonStyles() {
            // console.log("Updating button styles");
            const dkToggle = document.getElementById('dark-mode-toggle'); const ooToggle = document.getElementById('on-off-toggle');
            const zmBtn = document.getElementById('zoom-button'); const rmBtn = document.getElementById('reminder-button');
            if(ooToggle) { ooToggle.src = `https://boardinggate.github.io/Tesla/${ooToggle.dataset.state === 'on' ? 'IMG_4192.jpg' : 'IMG_4191.jpg'}`; ooToggle.alt = `Toggle ${ooToggle.dataset.state === 'on' ? 'On' : 'Off'}`; }
            if(dkToggle) { dkToggle.src = `https://boardinggate.github.io/Tesla/${isDarkMode ? 'IMG_4189.jpg' : 'IMG_4190.jpg'}`; dkToggle.alt = `Toggle ${isDarkMode ? 'Oscuro' : 'Claro'}`; }
            if(rmBtn) { const rmdrs = JSON.parse(localStorage.getItem('reminders') || '[]'); const cnt = rmdrs.length; let cntEl = rmBtn.querySelector('.reminder-count'); if (cnt > 0) { if(!cntEl){cntEl = document.createElement('span'); cntEl.className='reminder-count'; rmBtn.appendChild(cntEl);} cntEl.textContent = cnt; cntEl.style.display = 'flex'; } else if (cntEl) { cntEl.style.display = 'none'; }}
            if(zmBtn) { zmBtn.classList.toggle('zoomed', zmBtn.dataset.zoomState === 'on'); }
            // Filter toggle button text/sign is handled by applyToggleConfiguration
        }
        async function updateVersion() {
             try { const lmDate = await getLastModifiedDate(); const v = formatVersionDate(lmDate); const vEl = document.getElementById('version'); if(vEl) vEl.textContent = `v${v}`; } catch (err) { console.error("Version update failed", err); const vEl = document.getElementById('version'); if(vEl) vEl.textContent = 'v?.?.?'; }
        }
        function applyCurrentThemeToElements() {
             // console.log("Applying theme to elements. Dark mode:", isDarkMode);
             document.body.classList.toggle('dark-mode', isDarkMode); // Ensure body class is correct
             // Empty cells
             document.querySelectorAll('#bookmark-grid > div.config-empty-cell').forEach(cell => {
                 cell.style.backgroundColor = isDarkMode ? 'rgba(80, 80, 80, 0.3)' : 'rgba(200, 200, 200, 0.3)';
                 cell.style.borderColor = isDarkMode ? 'rgba(100, 100, 100, 0.5)' : 'rgba(150, 150, 150, 0.5)';
                 cell.style.filter = isDarkMode ? 'brightness(70%)' : '';
             });
             // Modals/Notifications (add/remove dark-mode class)
             document.querySelectorAll('.reminder-modal, .config-modal').forEach(m => m.classList.toggle('dark-mode', isDarkMode));
             document.querySelectorAll('.reminder-notification').forEach(n => n.classList.toggle('dark-mode', isDarkMode));
             // Update button styles that might depend on theme
             updateButtonStyles();
        }

        // === Grid Creation ===
        function createGridItems() {
             console.log("Creating grid items...");
             grid.innerHTML = ''; cellElements.length = 0;
             const colors = []; // Generate colors...
             for (let i = 0; i < TOTAL_CELLS; i++) { if (bookmarks[i] !== null) { try { let color, attempts=0; do { color = generateBrightColor(); attempts++; /* check neighbors */ } while (/* condition */ attempts < 20); colors[i] = color; } catch(e){} }}

             Array.from({ length: TOTAL_CELLS }).forEach((_, index) => {
                const cell = document.createElement('div');
                const bookmark = (index < bookmarks.length) ? bookmarks[index] : null;
                 const isEmpty = !(bookmark && bookmark.name !== undefined); // Simplified empty check

                 if (!isEmpty) {
                     const link = document.createElement('a');
                     link.className = index >= 60 ? 'bookmark-item small-bookmark' : 'bookmark-item';
                     link.title = bookmark.name || '';
                     if (colors[index]) { try { const [h, s, l] = colors[index].match(/\d+/g).map(Number); link.style.setProperty('--hue', h); link.style.setProperty('--saturation', `${s}%`); link.style.setProperty('--lightness', `${l}%`); } catch(e){ link.style.backgroundColor = '#EEE'; } } else { link.style.backgroundColor = '#EEE'; }
                     link.href = bookmark.url || "#";
                     if (bookmark.url && bookmark.name !== "Inicio Tesla") { link.target = "_blank"; link.rel = "noopener noreferrer"; }

                     // Add icon only if name is not explicitly empty string "" (allows URL-only bookmarks like Ventusky)
                     if (bookmark.name !== "" || !bookmark.url) { // If it has a name OR no URL (like "Inicio Tesla")
                         const img = document.createElement('img');
                         img.src = getFaviconUrl(bookmark); img.alt = `Favicon ${bookmark.name || ''}`; img.loading = "lazy";
                         img.onerror = (e) => { e.target.src='https://via.placeholder.com/32/CCCCCC/FFFFFF?text=?'; e.target.onerror=null; };
                         if (bookmark.name === "Mis Updates") img.classList.add('favicon-red'); else if (bookmark.name === "Olas Updates") img.classList.add('favicon-blue');
                         link.appendChild(img);
                     }
                     // Add name text only if name exists and is not empty string ""
                     if (bookmark.name && bookmark.name !== "") {
                         const name = document.createElement('span'); name.className = 'bookmark-name'; name.textContent = bookmark.name; link.appendChild(name);
                     } else if (!bookmark.url) {
                         // Handle "Inicio Tesla" which has a name but no URL and might need text
                          const name = document.createElement('span'); name.className = 'bookmark-name'; name.textContent = bookmark.name; link.appendChild(name);
                     } else { link.classList.add('no-name'); } // For URL-only like Ventusky
                     cell.appendChild(link);
                 } else {
                     cell.className = 'config-empty-cell'; // Mark empty
                 }
                 grid.appendChild(cell);
                 cellElements.push(cell);
             });
             applyCurrentThemeToElements(); // Style empty cells based on current theme
             console.log(`Grid items created (${cellElements.length}).`);
        }

        // === Side Button Creation ===
        function createSideButtons() {
            console.log("Creating side buttons...");
            const buttonContainer = document.body;
            createdToggleButtons = []; // Reset filter toggle array
            const newSideButtons = []; // Temp array for this run

            // Helper to avoid repetition
            const addButton = (elType, id, classes, innerHTML = '', dataset = {}) => {
                const el = document.createElement(elType);
                el.id = id;
                el.className = classes.join(' '); // Join class array
                if (innerHTML) el.innerHTML = innerHTML;
                Object.entries(dataset).forEach(([key, value]) => el.dataset[key] = value);
                buttonContainer.appendChild(el);
                newSideButtons.push(el);
                return el;
            };

            // --- Create Buttons (Using original classes structure) ---
            const onOffToggle = addButton('img', 'on-off-toggle', ['toggle-image'], '', { state: 'on' });
            onOffToggle.alt = 'Toggle On/Off'; onOffToggle.src = 'https://boardinggate.github.io/Tesla/IMG_4192.jpg'; // Default ON image
            onOffToggle.addEventListener('mousedown', () => { pressStartTime = Date.now(); }); // Add listeners
            onOffToggle.addEventListener('mouseup', handleOnOffLongPress);
            onOffToggle.addEventListener('touchstart', (e) => { e.preventDefault(); pressStartTime = Date.now(); });
            onOffToggle.addEventListener('touchend', (e) => { e.preventDefault(); handleOnOffLongPress(); });

            toggleRanges.forEach((range) => {
                 const toggle = addButton('span', range.id, ['toggle-sign', 'range-toggle'], '', { toggleId: range.id, state: 'visible' });
                 toggle.addEventListener('click', () => { if (!isMinimalMode && !isConfigMode) updateToggleState(toggle); });
                 createdToggleButtons.push(toggle);
            });

            const weatherBtn = addButton('span', 'weather-button', ['toggle-sign'], `<img src="https://www.google.com/s2/favicons?domain=ventusky.com&sz=64" alt="Tiempo">`);
            weatherBtn.addEventListener('click', () => { if (!isMinimalMode && !isConfigMode) window.open('https://www.ventusky.com/?p=40.2;-4.7;5&l=rain-3h', '_blank'); });

            const reminderBtn = addButton('span', 'reminder-button', ['toggle-sign'], `<img src="https://boardinggate.github.io/Tesla/IMG_4197.jpg" alt="Recordatorio">`);
            reminderBtn.addEventListener('mousedown', () => { reminderPressStartTime = Date.now(); }); // Add listeners
            reminderBtn.addEventListener('mouseup', handleReminderLongPress);
            reminderBtn.addEventListener('touchstart', (e) => { e.preventDefault(); reminderPressStartTime = Date.now(); });
            reminderBtn.addEventListener('touchend', (e) => { e.preventDefault(); handleReminderLongPress(); });

            const zoomBtn = addButton('span', 'zoom-button', ['toggle-sign'], `<img src="./zoon-.png" alt="Zoom">`, { zoomState: 'off' });
            zoomBtn.addEventListener('click', () => { if (!isMinimalMode && !isConfigMode) { const ns=zoomBtn.dataset.zoomState==='off'?'on':'off'; zoomBtn.dataset.zoomState=ns; applyZoom(ns); updateButtonStyles(); saveSettings();} });

            const dkModeToggle = addButton('img', 'dark-mode-toggle', ['toggle-image']);
            dkModeToggle.alt = 'Toggle Dark Mode'; dkModeToggle.src = 'https://boardinggate.github.io/Tesla/IMG_4190.jpg'; // Default Light image
            dkModeToggle.addEventListener('click', () => { if (!isMinimalMode) { isDarkMode=!isDarkMode; applyCurrentThemeToElements(); saveSettings(); } });

            const reloadBtn = addButton('span', 'reload-button', ['toggle-sign'], `<img src="./reload.webp" alt="Recargar">`);
            reloadBtn.addEventListener('click', () => { if (!isMinimalMode && !isConfigMode) location.reload(); });

            const homeBtn = addButton('span', 'home-button', ['toggle-sign'], `<img src="./home.webp" alt="Inicio">`);
            homeBtn.addEventListener('click', (e) => { if (!isMinimalMode && !isConfigMode) { e.preventDefault(); window.history.back(); } });

            const configBtn = addButton('span', 'config-button', ['toggle-sign'], `<img src="https://boardinggate.github.io/Tesla/config.jpg" alt="Configuración">`);
            configBtn.addEventListener('click', () => { if (!isMinimalMode && !isConfigMode) showConfigMenu(); });

            // --- Finalize Side Button List ---
            const scrollToggle = document.getElementById('scroll-toggle');
            sideButtons = [scrollToggle, ...newSideButtons].filter(Boolean); // Combine and ensure no nulls
            console.log(`Side buttons created/collected (${sideButtons.length}).`);
        }


        // === Side Button Positioning ===
        function adjustButtonPositions() {
             console.log("Adjusting button positions. Minimal Mode:", isMinimalMode);
             const scrollToggle = document.getElementById('scroll-toggle');
             if (!scrollToggle || sideButtons.length === 0) return;

             const scrollToggleHeight = scrollToggle.offsetHeight || 100; // Default height if needed
             const buttonHeight = 54; // Standard height for others
             const spacing = 4;
             let currentTop = 10; // Initial top for scroll toggle

             sideButtons.forEach((button) => {
                 if (!button) return; // Skip if button not found

                 const isScroll = button.id === 'scroll-toggle';
                 const isException = (button.id === 'config-button' || button.id === 'on-off-toggle');
                 // Determine visibility based on minimal mode and exceptions
                 const shouldBeVisible = !isMinimalMode || isException;

                 if (shouldBeVisible) {
                     button.style.top = `${currentTop}px`;
                     button.style.visibility = 'visible';
                     // Set display based on original type (flex for spans, block for images)
                     button.style.display = (button.classList.contains('toggle-sign')) ? 'flex' : 'block';

                     // Calculate next top position
                     const currentButtonHeight = isScroll ? scrollToggleHeight : (button.offsetHeight || buttonHeight);
                     const validHeight = currentButtonHeight > 20 ? currentButtonHeight : (isScroll ? 100 : buttonHeight); // Use default if offsetHeight is 0
                     currentTop += validHeight + spacing;
                     // console.log(` - Visible: ${button.id || 'filter'}, Top: ${button.style.top}, Next Top: ${currentTop}`);
                 } else {
                     // Hide the button
                     button.style.visibility = 'hidden';
                     button.style.display = 'none';
                     // console.log(` - Hidden: ${button.id || 'filter'}`);
                 }
             });
             console.log("Button positions adjustment complete.");
        }

        // === Toggle Filter Logic ===
        function getDefaultIndices(rangeInfo) {
             const indices = []; if (!rangeInfo || typeof rangeInfo.start !== 'number' || typeof rangeInfo.end !== 'number') return indices;
             for (let i = rangeInfo.start; i <= rangeInfo.end; i++) { if (i < cellElements.length && cellElements[i] && !cellElements[i].classList.contains('config-empty-cell')) indices.push(i); } return indices;
        }
        function applyToggleConfiguration(toggleId) {
             if (!toggleId) return; const btn = createdToggleButtons.find(b => b.dataset.toggleId === toggleId); if (!btn) return;
             const rInfo = toggleRanges.find(r => r.id === toggleId); const cfg = customToggleConfigs[toggleId];
             let lbl = cfg?.label || rInfo.defaultLabel; let idxs = cfg?.itemIndices || getDefaultIndices(rInfo);
             btn.dataset.itemIndices = idxs.join(','); btn.dataset.label = lbl;
             const state = btn.dataset.state || 'visible'; const sign = state === 'visible' ? '-' : '+'; btn.innerHTML = `<span class="sign">${sign}</span>${lbl}`;
             const hide = state === 'hidden'; idxs.forEach(i => { if(cellElements[i]) cellElements[i].classList.toggle('hidden', hide); });
        }
        function updateToggleState(toggle) {
             if (!toggle?.dataset?.toggleId) return; const state = toggle.dataset.state; const idxsStr = toggle.dataset.itemIndices || '';
             const idxs = idxsStr.split(',').filter(s=>s).map(Number); const lbl = toggle.dataset.label;
             const nState = state === 'visible' ? 'hidden' : 'visible'; const hide = nState === 'hidden'; const sign = nState === 'visible' ? '-' : '+';
             idxs.forEach(i => { if(cellElements[i]) cellElements[i].classList.toggle('hidden', hide); });
             toggle.dataset.state = nState; toggle.innerHTML = `<span class="sign">${sign}</span>${lbl}`;
             updateButtonStyles(); saveSettings(); // Save state after update
        }
        function updateAllToggles(targetState) {
             createdToggleButtons.forEach(t => { const id = t.dataset.toggleId; if(!id) return; const cState = t.dataset.state; const vis = targetState === 'on'; if ((vis && cState==='hidden') || (!vis && cState==='visible')) updateToggleState(t); });
             const ooBtn = document.getElementById('on-off-toggle'); if(ooBtn) { ooBtn.dataset.state = targetState; updateButtonStyles(); }
             // saveSettings is called inside updateToggleState
        }

        // === ON/OFF Button Logic ===
        function handleOnOffLongPress() {
             const dur = pressStartTime ? Date.now() - pressStartTime : 0; const ooBtn = document.getElementById('on-off-toggle');
             if (dur >= 2000) { toggleMinimalMode(!isMinimalMode); saveSettings(); /* Save minimal mode state */ } // Toggle minimal mode & save
             else if (!isMinimalMode && ooBtn) { const cState = ooBtn.dataset.state; updateAllToggles(cState==='on'?'off':'on'); saveSettings(); /* Save on/off state */ }
             pressStartTime = null;
        }

        // === Config Logic Stubs ===
        function showConfigMenu() { console.log("Config Menu"); /* Full implementation needed */ }
        function showToggleSelectionMenu() { console.log("Toggle Selection"); /* Full implementation needed */ }
        function startToggleConfiguration(toggleId) { console.log("Start Config:", toggleId); /* Full implementation needed */ }
        function handleGridItemClickInConfig(event) { /* ... */ }
        function saveToggleConfiguration(toggleId, newLabel) { /* ... */ }
        function exitItemSelectionMode() { /* ... */ }

        // === Notices and Footer Logic ===
        async function loadNotices() { /* ... */ }
        function updateNotice() { /* ... */ }
        function startNoticeRotation() { /* ... */ }
        function toggleFooterVisibility() {
             const ftr = document.querySelector('footer'); const cntr = document.querySelector('.counter-wrapper'); const ntcCont = document.querySelector('.notices-icon-container');
             const show = !isMinimalMode && isActive && isFooterVisible; // Determine visibility based on ALL flags
             if(ntcCont) ntcCont.classList.toggle('hidden', !show); if(ftr) ftr.classList.toggle('hidden', !show); if(cntr) cntr.classList.toggle('hidden', !show);
             // Only save isActive/isFooterVisible state if NOT in minimal mode
             if (!isMinimalMode) saveSettings();
        }
        // Add listener to notice toggle icon...
         document.getElementById('notice-toggle-icon')?.addEventListener('click', () => {
             if (isMinimalMode || isConfigMode) return;
             isActive = !isActive; isFooterVisible = isActive;
             toggleFooterVisibility(); // Update visuals and save state (if not minimal)
         });


        // === Reminder Logic Stubs ===
        function parseTimeOrTimerFromText(text) { /* ... */ return null; }
        function showReminderModal(reminder = null) { console.log("Show reminder modal"); /* Full implementation */ }
        function showReminderNotification(reminder) { console.log("Show reminder notification"); /* Full implementation */ }
        function deleteReminder(reminderId) { /* ... */ }
        function postponeReminder(reminderId, minutes) { /* ... */ }
        function updateReminderLastShown(reminderId, timestamp) { /* ... */ }
        function showAllReminders() { console.log("Show all reminders"); /* Full implementation */ }
        function checkReminders() { /* ... */ }
        function loadReminders() { console.log("Loading reminders"); /* setTimeout(checkReminders, 1000); setInterval(checkReminders, 60000); */ updateButtonStyles(); }
        function handleReminderLongPress() { /* ... (implementation) ... */ }

        // === Navigation & Swipe ===
        document.getElementById('back-button')?.addEventListener('click', () => { if (!isMinimalMode && !isConfigMode) window.history.back(); });
        document.getElementById('forward-button')?.addEventListener('click', () => { if (!isMinimalMode && !isConfigMode) window.history.forward(); });
        let touchStartX = 0; let touchEndX = 0;
        document.addEventListener('touchstart', e => { if (isMinimalMode || isConfigMode || e.target.closest('.toggle-sign, .toggle-image, .scroll-toggle-button, #bookmark-grid, .reminder-modal, .config-overlay')) { touchStartX = 0; return; } touchStartX = e.changedTouches[0].screenX; });
        document.addEventListener('touchend', e => { if (touchStartX === 0 || isMinimalMode || isConfigMode) return; touchEndX = e.changedTouches[0].screenX; handleSwipe(); touchStartX = 0; });
        function handleSwipe() { const dist = touchEndX - touchStartX; const thresh = 80; if (dist > thresh) window.history.back(); else if (dist < -thresh) window.history.forward(); }

        // === Initialization ===
        window.addEventListener('resize', () => { if (!isMinimalMode && !isConfigMode) adjustButtonPositions(); });

        document.addEventListener('DOMContentLoaded', async () => {
            console.log("=== Initializing Application ===");

            // 1. Create UI Elements (Grid, Buttons)
            console.log("Step 1: Creating Grid Items");
            createGridItems();
            console.log("Step 2: Creating Side Buttons");
            createSideButtons(); // Populates `sideButtons` & `createdToggleButtons`

            // 3. Load Static/Async Data
            console.log("Step 3: Loading Version & Notices");
            await updateVersion();
            await loadNotices(); // Also starts rotation if needed

            // 4. Load Saved State (into JS variables)
            console.log("Step 4: Loading Saved Settings");
            loadSavedSettings(); // Populates state vars like isDarkMode, isMinimalMode, applies data-* attrs

            // 5. Apply Initial Visual State Based on Loaded Settings
            console.log("Step 5: Applying Initial Visual State");
            applyCurrentThemeToElements(); // Sets body class, styles empty cells, modals etc.
            applyZoom(document.getElementById('zoom-button')?.dataset.zoomState || 'off'); // Apply visual zoom
            createdToggleButtons.forEach(toggle => applyToggleConfiguration(toggle.dataset.toggleId)); // Apply filter visibility/labels
            updateButtonStyles(); // Update button icons (on/off, dark/light), reminder count

            // 6. Apply Minimal Mode & Footer Visibility (which also calls adjustButtonPositions)
            console.log("Step 6: Applying Minimal Mode Visuals & Footer Visibility");
            toggleMinimalMode(isMinimalMode); // Apply visual hides/shows for minimal mode
            if (!isMinimalMode) {
                toggleFooterVisibility(); // Ensure footer/notices correct if not minimal
            }
            // adjustButtonPositions(); // Called inside toggleMinimalMode and toggleFooterVisibility indirectly affects it? Maybe call again for safety. Let's rely on toggleMinimalMode calling it. If issues persist, uncomment this line.

            console.log("=== Initialization Complete ===");
        });

    </script>
</body>
</html>