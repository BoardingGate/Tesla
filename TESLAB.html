<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BoardingGate Lanzador</title>
    <link rel="icon" href="https://boardinggate.github.io/Tesla/IMG_4157.jpeg" type="image/jpeg">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* === INICIO CSS PROPORCIONADO === */
        .bookmark-item {
            transition: transform 4s ease, box-shadow 4s ease;
            box-shadow: 4px 4px 8px rgba(0, 0, 0, 0.5), -4px -4px 8px rgba(255, 255, 255, 0.1);
            position: relative;
        }
        .bookmark-item:hover {
            transform: scale(1.1) translateY(-2px);
            box-shadow: 6px 6px 12px rgba(0, 0, 0, 0.6), -6px -6px 12px rgba(255, 255, 255, 0.15);
        }
        .bookmark-item img {
            image-rendering: crisp-edges;
        }
        .bookmark-name {
            font-weight: bold;
            color: #333;
            text-align: center;
            margin-top: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }
        #bookmark-grid {
            display: grid;
            grid-template-columns: repeat(6, minmax(120px, 1fr));
            gap: 15px;
            background-color: transparent;
            border-radius: 0.75rem;
            position: relative;
            width: 100%;
            max-width: 984px;
            margin: 0 auto 0 60px; /* Ajustado para sidebar */
            transition: all 0.3s ease;
        }
        #bookmark-grid > div {
            height: auto;
            aspect-ratio: 16 / 9;
            transition: all 0.3s ease;
        }
        .bookmark-item {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
            /* Color base - Ajustado dinámicamente por JS si es necesario */
             background-color: hsla(45, 20%, 70%, 0.64); /* Ejemplo: HSL beige claro */
             /* Variables HSL para posible personalización futura */
             --hue: 45;
             --saturation: 20%;
             --lightness: 70%;
             background-color: hsla(var(--hue), var(--saturation), var(--lightness), 0.64);
        }
        .bookmark-item img {
            width: 36px;
            height: auto;
            max-width: 40px;
            border-radius: 0.25rem;
        }
        .bookmark-name {
            font-size: clamp(0.85rem, 1.5vw, 1.15rem);
        }
        .small-bookmark img {
            width: 24px;
            max-width: 28px;
        }
        .small-bookmark .bookmark-name {
            font-size: clamp(0.85rem, 1.5vw, 1.15rem); /* Mismo tamaño que normal */
        }
        @media (max-width: 768px) {
            #bookmark-grid {
                grid-template-columns: repeat(3, minmax(100px, 1fr));
                gap: 10px;
                margin-left: 60px; /* Mantener espacio para sidebar */
            }
        }
        @media (max-width: 480px) {
            #bookmark-grid {
                grid-template-columns: repeat(2, minmax(80px, 1fr));
                gap: 8px;
                 margin-left: 60px; /* Mantener espacio para sidebar */
            }
        }
        .header-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            background-color: #ABAB99;
            padding: 0.5rem;
        }
        body.dark-mode .header-container {
            background-color: #92927E;
        }
        .header-logo {
            width: 100px;
            height: 70px;
            transition: filter 0.2s ease;
        }
        body.dark-mode .header-logo {
            filter: brightness(85%);
        }
        .title-container {
            background-color: #ABAB99;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            display: inline-block;
        }
        body.dark-mode .title-container {
            background-color: #92927E;
        }
        .header-container h1 {
            color: #5C5C47;
        }
        .version-text {
            font-size: 0.75rem;
            color: #5C5C47;
            font-weight: normal;
        }
        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background-color: #ABAB99;
            margin: 0;
            overflow-x: hidden; /* Prevenir scroll horizontal */
            padding-left: 60px; /* Espacio permanente para botones izquierdos */
            box-sizing: border-box;
        }
        body.dark-mode {
            background-color: #92927E;
        }
        header {
            margin-bottom: 0.5rem;
             width: calc(100% - 60px); /* Ajustar ancho por el padding del body */
             margin-left: auto; /* Centrar o alinear */
             margin-right: auto;
        }
        main {
            margin: 0.5rem auto 0.5rem 0; /* Sin margen izquierdo extra, ya está en body */
            background-color: transparent;
            border-radius: 0.75rem;
            padding: 16px;
            min-height: 400px;
            transition: margin-top 0.5s ease-in-out;
            max-width: 984px;
            width: 100%; /* Ocupa el espacio disponible */
            box-sizing: border-box;
        }
        footer {
            margin: 0.5rem auto;
            text-align: center;
            max-width: 984px;
            width: 100%; /* Ocupa el espacio disponible */
            display: block;
            background-color: #ABAB99;
             /* margin-left: 60px; */ /* Quitar margen izquierdo extra */
             box-sizing: border-box;
        }
        body.dark-mode footer {
            background-color: #92927E;
        }
        .footer-content {
            color: #5C5C47;
            padding: 0.5rem;
            margin: 0 auto;
            max-width: 100%;
            position: relative;
        }
        .footer-subtext {
            font-size: 0.75rem;
            color: #5C5C47;
            margin-top: 0.25rem;
            text-align: center;
        }
        .footer-link-green {
            color: #5C5C47;
            text-decoration: none;
            transition: color 0.2s ease;
        }
        .footer-link-green:hover {
            color: #5C5C47; /* Mismo color, quizás subrayado? */
             text-decoration: underline;
        }
        .footer-line {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        /* --- Botones Izquierdos --- */
        .left-sidebar-button {
            position: fixed;
            width: 98px; /* Ancho unificado */
            height: auto; /* Altura automática basada en contenido/aspect ratio */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
            cursor: pointer;
            box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            transition: background-color 0.2s ease, filter 0.2s ease;
            left: 10px; /* Pegados a la izquierda */
            text-align: center;
            background-color: #ABAB99; /* Color base claro */
            border: 1px solid #92927E; /* Borde sutil */
        }
        body.dark-mode .left-sidebar-button {
            background-color: #5C5C47; /* Color base oscuro */
             border: 1px solid #4a4a3a;
        }
         /* Estilos específicos por botón */
         #scroll-toggle {
             top: 120px; /* Posición vertical */
             border-radius: 60px; /* Muy redondeado */
             height: clamp(78.2px, 19.55vw, 145.95px); /* Altura variable */
         }
         #dark-mode-toggle, #home-button, #reload-button, #weather-button, #zoom-button, #reminder-button, #config-button, #on-off-toggle {
              border-radius: 20px; /* Menos redondeado */
              height: 54px; /* Altura fija */
         }
         /* Posicionamiento vertical escalonado */
         #dark-mode-toggle { top: 280px; }
         #home-button { top: 345px; background-color: #668B8B; } /* Verde azulado */
         #reload-button { top: 410px; background-color: #668B8B; } /* Verde azulado */
         #weather-button { top: 475px; }
         #zoom-button { top: 540px; }
         #reminder-button { top: 605px; background-color: #668B8B; } /* Verde azulado */
         #config-button { top: 670px; } /* Último botón */
         #on-off-toggle { bottom: 20px; top: auto; } /* Abajo */


         /* Colores específicos Dark Mode */
         body.dark-mode #home-button,
         body.dark-mode #reload-button,
         body.dark-mode #reminder-button {
             background-color: #526f6f; /* Verde azulado oscuro */
         }
         body.dark-mode #config-button {
              background-color: #92927E; /* Mismo que fondo header dark */
         }
         body.dark-mode #zoom-button.zoomed {
             background-color: #D9A066; /* Naranja para indicar zoom activo */
         }

        /* Hover general para botones izquierdos */
         .left-sidebar-button:hover {
             background-color: #D9A066 !important; /* Naranja al pasar el ratón, !important para sobreescribir colores específicos */
             filter: brightness(1.1);
         }

        /* Iconos dentro de botones izquierdos */
        .left-sidebar-button svg {
            width: clamp(24px, 4vw, 32px);
            height: clamp(24px, 4vw, 32px);
            stroke: #E6E6DC; /* Color trazo icono */
        }
         #scroll-toggle svg { stroke-width: 3; }

        /* --- Fin Botones Izquierdos --- */

        .top-text-container {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(0.6rem, 1.5vw, 0.75rem);
            color: #5C5C47;
            background-color: #D1D5DB; /* Gris claro */
            margin-top: 0.25rem;
            margin-left: 0; /* Ya no necesita margen por el padding del body */
            gap: 0.5rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            animation: fadeOut 4s forwards;
            position: relative;
            height: 2rem;
            transition: height 0.5s ease-in-out, opacity 0.5s ease-in-out;
            width: calc(100% - 60px); /* Ajustar ancho */
            box-sizing: border-box;
             margin-right: auto;
             margin-left: auto; /* Centrar si es necesario */
             max-width: 984px; /* Mantener ancho máximo */
        }
        body.dark-mode .top-text-container {
            background-color: #6B7280; /* Gris oscuro */
        }
        .top-text-container span {
            color: #D9A066; /* Naranja */
            font-size: clamp(0.9rem, 2vw, 1.2rem);
        }
        @keyframes fadeOut {
            0% { opacity: 1; height: 2rem; }
            75% { opacity: 1; height: 2rem; }
            100% { opacity: 0; height: 0; margin-top: 0; padding: 0; overflow: hidden; }
        }
        .arrow-button {
            width: clamp(36px, 6vw, 48px);
            height: clamp(36px, 6vw, 48px);
            background-color: #D9A066; /* Naranja */
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            transition: background-color 0.2s ease;
        }
        .arrow-button:hover {
            background-color: #5C5C47; /* Verde oliva oscuro */
        }
        .arrow-button svg {
            stroke: #E6E6DC; /* Blanco hueso */
        }
        .counter-wrapper { /* Contenedor del contador de visitas */
             display: flex;
             justify-content: center; /* Centra el contenido */
             align-items: center;
             margin-top: 1rem;
             width: calc(100% - 60px); /* Ajustar ancho */
             margin-left: auto;
             margin-right: auto;
             opacity: 0.2; /* Muy transparente */
             max-width: 984px;
        }
        .counter-container {
             text-align: center;
        }
        .favicon-red { filter: hue-rotate(0deg) saturate(200%) brightness(80%); }
        .favicon-blue { filter: hue-rotate(200deg) saturate(150%) brightness(90%); }

        .notices-icon-container {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            max-width: 984px;
            margin: 0 auto; /* Centrado */
             /* margin-left: 140px; */ /* Quitado margen izquierdo extra */
            position: relative;
             box-sizing: border-box;
        }
        .notices-container {
            flex-grow: 1;
            padding: 0.5rem;
            border: none;
            border-radius: 0.5rem;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0;
            margin-left: 2px;
            height: 3rem;
            background-color: rgba(0, 0, 0, 0.1); /* Fondo sutil */
        }
         body.dark-mode .notices-container {
             background-color: rgba(255, 255, 255, 0.1);
         }
        .notice-wrapper {
            padding: 0.5rem;
            height: 1.5rem;
            flex-grow: 1;
            overflow: hidden;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .notice {
            color: #00ff00; /* Verde brillante */
            font-size: 1.1rem;
            font-weight: bold;
            white-space: nowrap;
            text-align: center;
            opacity: 0;
            animation: fadeInOut 14s infinite;
            position: absolute; /* Para que se solapen bien en el ciclo */
        }
        @keyframes fadeInOut { /* Animación para un solo aviso */
            0% { opacity: 0; }
            10% { opacity: 1; } /* Aparece rápido */
            90% { opacity: 1; } /* Se mantiene visible */
            100% { opacity: 0; } /* Desaparece rápido */
        }
         /* Si hay múltiples avisos, el JS debe gestionar cuál es visible */

        .notice-off-icon {
            width: auto;
            height: clamp(2rem, 5vw, 3rem);
            margin-right: 10px;
            align-self: center;
            cursor: pointer;
            transition: filter 0.3s ease;
            border-radius: 5px;
        }
        body.dark-mode .notice-off-icon {
            filter: brightness(85%);
        }
         .notice-off-icon.off { /* Estilo cuando los avisos están apagados */
             filter: grayscale(100%) opacity(50%);
         }


        .toggle-sign img, /* Para iconos dentro de botones */
        .toggle-image img {
            max-width: 80px;
            max-height: 48px;
            object-fit: contain;
        }
         body.dark-mode .toggle-sign#config-button img,
         body.dark-mode .toggle-image#on-off-toggle img {
             filter: brightness(85%);
         }

        /* Contador en botón Recordatorios */
        #reminder-button .reminder-count {
            position: absolute;
            top: 3px;
            left: 3px;
            background-color: #EF4444; /* Rojo */
            color: #FFFFFF;
            border-radius: 50%; /* Circular */
            padding: 2px 6px; /* Ajustar padding para tamaño */
            font-size: 0.85rem; /* Tamaño ajustado */
            font-weight: bold;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1500;
            min-width: 1.4rem; /* Ancho mínimo para números */
            height: 1.4rem; /* Altura igual a ancho mínimo */
            text-align: center;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.5);
        }
        .hidden { display: none; }
        .footer-hidden { display: none; }

        /* Dark mode específicos */
        body.dark-mode .bookmark-item { filter: brightness(60%); }
        body.dark-mode .bg-gray-50.border.border-dashed.border-gray-200.rounded-lg { filter: brightness(60%); }
        /* Colores de botones izquierdos ya definidos arriba */

        /* Minimal Mode */
        .minimal-mode { background-color: #ABAB99; }
        body.dark-mode.minimal-mode { background-color: #92927E; }
        .minimal-mode main,
        .minimal-mode .notices-icon-container,
        .minimal-mode footer,
        .minimal-mode .top-text-container,
        .minimal-mode .left-sidebar-button:not(#on-off-toggle), /* Ocultar todos menos on-off */
        .minimal-mode #reminder-notifications,
        .minimal-mode .counter-wrapper {
            display: none !important;
        }
        .minimal-mode #on-off-toggle {
            filter: none;
            opacity: 0.3;
            background-color: gray !important; /* Indicar inactivo */
        }
        .minimal-mode-message {
            color: #000000;
            font-size: 1rem;
            font-weight: bold;
            position: fixed;
            top: 70px;
            left: 10px;
            z-index: 1000;
             background-color: rgba(255, 255, 255, 0.8);
             padding: 5px 10px;
             border-radius: 5px;
        }

        /* --- Modales --- */
        .modal-overlay { /* Fondo oscuro semitransparente */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 1900; /* Debajo del modal */
            display: none; /* Oculto por defecto */
        }
        .modal-overlay.active {
            display: block;
        }

        /* Modal Base (compartido por reminder, help, table) */
        .modal-base {
             position: fixed;
             background-color: #E6D6A8; /* Beige claro base */
             padding: 1.5rem;
             border-radius: 1rem;
             box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
             z-index: 2000;
             overflow-y: auto;
             display: none; /* Oculto por defecto */
             max-height: 90vh; /* Limitar altura */
        }
        .modal-base.active {
            display: block;
        }

        /* Modal de Recordatorio (Formulario) */
        .reminder-modal {
            top: 5vh; /* Centrado vertical aprox */
            left: 50%;
            transform: translateX(-50%);
            background-color: #D2B48C; /* Beige oscuro */
            padding: 1rem; /* Reducido */
            max-width: 990px;
            width: 90%;
             max-height: 700px; /* Altura específica */
             font-size: 1rem; /* Base */
        }
        .reminder-modal h2 {
            font-size: 1.5rem; font-weight: bold; margin-bottom: 0.5rem; color: #111827;
        }
        .reminder-modal label {
            display: block; margin-bottom: 0.25rem; font-weight: 500; color: #374151; font-size: 0.9rem;
        }
        .reminder-modal textarea#reminder-text { /* Campo principal */
            width: 100%; padding: 0.5rem; margin-bottom: 0.5rem; border: 1px solid #D1D5DB; border-radius: 0.25rem;
            font-size: 1.6rem; /* Aumentado como se pidió */
            font-weight: bold; text-transform: uppercase; min-height: 80px; /* Altura mínima */
        }
        .reminder-modal input[type="text"], /* Otros campos */
        .reminder-modal input[type="number"],
        .reminder-modal input[type="time"], /* Incluir time y date */
        .reminder-modal input[type="date"] {
            width: 100%; padding: 0.5rem; margin-bottom: 0.5rem; border: 1px solid #D1D5DB; border-radius: 0.25rem;
            font-size: 2rem; /* Doble tamaño */
            text-align: center; /* Centrado */
        }
        .reminder-modal .form-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; }
        .reminder-modal .full-width { grid-column: span 4; }
        .reminder-modal .days-group { display: flex; gap: 0.25rem; flex-wrap: wrap; align-items: center; }
        .reminder-modal .days-group label { font-size: 0.8rem; margin-left: 2px; margin-right: 8px; }
        .reminder-modal .days-group input[type="checkbox"] { width: auto; margin-bottom: 0; } /* Ajustar checkboxes */

        .reminder-modal .button-group { display: flex; justify-content: space-between; gap: 0.5rem; flex-wrap: nowrap; margin-top: 1rem;}
        .reminder-modal button { padding: 0.75rem 1rem; border-radius: 0.25rem; cursor: pointer; font-size: 1rem; flex: 1; text-align: center; }

        .reminder-modal button[type="submit"] { /* Botón Aceptar/Guardar */
            background-color: #2563EB; color: #FFFFFF;
            display: flex; align-items: center; justify-content: center; gap: 0.5rem; /* Para alinear texto y contador */
        }
        .reminder-modal button[type="submit"]:hover { background-color: #1D4ED8; }
        .reminder-modal button[type="submit"] span#countdown-save { /* Contador dentro del botón */
             font-size: 1rem; font-weight: bold; color: #FFFFFF;
             /* background-color: rgba(255, 255, 255, 0.2); /* Fondo sutil opcional */
             /* padding: 2px 6px; border-radius: 4px; */
        }
         .reminder-modal button.clear-button { /* Botón Limpiar */
            background-color: #F59E0B; color: #FFFFFF; flex-grow: 0.5; /* Más pequeño */
         }
          .reminder-modal button.clear-button:hover { background-color: #D97706; }

        .reminder-modal button.cancel-button { /* Botón Cancelar/Salir */
            background-color: #D1D5DB; color: #111827; flex-grow: 0.5; /* Más pequeño */
        }
         .reminder-modal button.cancel-button:hover { background-color: #9CA3AF; }

        /* Botón Hablar y Status */
        .speech-button {
            background-color: #22C55E; color: white; border: none; border-radius: 0.25rem;
            padding: 0.5rem; cursor: pointer; margin-left: 0.5rem; font-size: 1rem;
            vertical-align: top; height: 40px; /* Alinear altura con textarea aprox */
        }
        .speech-button:hover { background-color: #16A34A; }
        .speech-button.active { background-color: #EF4444; } /* Rojo cuando está grabando */
        .speech-status {
            font-size: 0.85rem; color: #4B5563; margin-top: 0.25rem; min-height: 1.2em;
            grid-column: span 3; /* Ocupar espacio junto al botón */
        }

        /* Modal de Ayuda */
        .help-modal {
            top: 10%; left: 40px; transform: translateY(-10%); background-color: #DAC8A0;
            padding: 2rem; max-width: 800px; width: 90%; font-size: 1.10rem;
        }
        .help-modal h2 { font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem; color: #111827; }
        .help-modal p, .help-modal ul { margin-bottom: 1rem; color: #374151; }
        .help-modal li { margin-left: 1.5rem; list-style: disc; }
        .help-modal button#close-help { background-color: #2563EB; color: #FFFFFF; font-size: 1.5rem; padding: 1rem 2rem; display: block; margin: 1rem auto 0; }

        /* Notificación de Recordatorio Vencido */
        .reminder-notification {
            position: fixed; top: 45%; left: 50%; transform: translate(-50%, -50%); /* Centrado */
            background-color: #FFFF99; /* Amarillo pálido */
            padding: 1.5rem; border-radius: 1.5rem; /* Más redondeado */
            border: 2px solid #ABAB99; box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
            z-index: 3000; max-width: 470px; width: 90%; text-align: center;
            display: none; /* Oculto por defecto */
        }
         .reminder-notification.active { display: block; }

        .reminder-notification .reminder-text { /* Texto principal */
            margin: 0.5rem 0 1rem 0; font-size: 1.8rem; font-weight: bold; color: #0000FF; /* Azul */
        }
        .reminder-notification .reminder-details { /* Detalles (hora, etc.) */
            margin: 0.5rem 0; font-size: 1.0rem; font-weight: bold; color: #1E40AF; /* Azul oscuro */
        }
        .reminder-notification .button-group { display: flex; justify-content: center; gap: 0.75rem; margin-top: 1rem; flex-wrap: wrap; }
        .reminder-notification button {
            padding: 0.75rem 1rem; border-radius: 0.25rem; cursor: pointer;
            font-size: 1.1rem; /* Tamaño unificado */
            width: 130px; /* Ancho fijo */
             height: 50px; /* Altura fija */
             display: flex; align-items: center; justify-content: center;
             color: #FFFFFF;
             border: none;
        }
         .reminder-notification button.postpone { background-color: #F59E0B; /* Naranja */ }
         .reminder-notification button.modify { background-color: #10B981; /* Verde */ }
         .reminder-notification button.cancel { background-color: #EF4444; /* Rojo */ }
         .reminder-notification button:hover { filter: brightness(110%); }

        /* Modal Tabla de Recordatorios */
        .reminder-table-modal {
            top: 5vh; /* Más arriba */
            left: 50%;
            transform: translateX(-50%);
            background-color: #E6D6A8; /* Beige claro */
            padding: 1.5rem; border-radius: 1rem; /* Menos redondeado que notif */
            max-width: 95%; width: 980px;
        }
        .reminder-table-modal table { width: 100%; border-collapse: collapse; margin-bottom: 1rem; background-color: #FFF; } /* Fondo blanco tabla */
        .reminder-table-modal th, .reminder-table-modal td {
            padding: 0.6rem; border: 1px solid #BFB38F; /* Borde beige más oscuro */
            font-size: 0.9rem; text-align: center; vertical-align: middle;
        }
        .reminder-table-modal td.text-column { text-align: left; } /* Texto a la izquierda */
        .reminder-table-modal th { background-color: #D2B48C; /* Beige oscuro cabecera */ color: #374151; font-weight: bold; }
        .reminder-table-modal td.date-column, .reminder-table-modal td.time-column { white-space: nowrap; } /* Evitar salto línea */

        /* Columna de Acciones */
        .reminder-table-modal td.actions-column {
             display: flex; /* Cambiado a flex si queremos botones horizontales */
             flex-direction: row;
             gap: 0.35rem;
             justify-content: center;
             align-items: center;
             height: auto; /* Altura automática */
             padding: 0.4rem; /* Menos padding vertical */
        }
        .reminder-table-modal td.actions-column button {
            padding: 0.4rem 0.6rem; /* Padding ajustado */
            border-radius: 0.25rem; cursor: pointer; font-size: 0.8rem; margin: 0;
            color: #FFFFFF; border: none; flex-grow: 0; /* No crecer */
            min-width: 60px; /* Ancho mínimo */
        }
         .reminder-table-modal button.modify { background-color: #10B981; } /* Verde */
         .reminder-table-modal button.delete { background-color: #EF4444; } /* Rojo */
         .reminder-table-modal button.postpone { background-color: #F59E0B; /* Naranja */ }
         .reminder-table-modal td.actions-column button:hover { filter: brightness(110%); }

        /* Filas Clicables */
        .reminder-table-modal tbody tr { cursor: pointer; transition: background-color 0.2s ease; }
        .reminder-table-modal tbody tr:hover { background-color: #D9C6A0 !important; } /* Beige más oscuro al pasar (!important por si hay otras reglas) */
        .reminder-table-modal tbody tr.due-soon { background-color: #FFFACD; } /* Amarillo muy pálido para próximos */
        .reminder-table-modal tbody tr.overdue { background-color: #FFD8D8; } /* Rosa pálido para pasados */


        /* Botones Salir de la tabla */
        .reminder-table-modal .table-button-bar { /* Contenedor para botones */
             display: flex;
             justify-content: space-between; /* Poner uno a cada lado */
             align-items: center;
             margin-bottom: 1rem; /* Espacio antes de la tabla */
        }
        .reminder-table-modal #add-new-reminder { /* Botón Añadir Nuevo */
            background-color: #22C55E; /* Verde */
            color: #FFFFFF; font-size: 1rem; padding: 0.6rem 1.5rem;
            border-radius: 0.5rem; border: none; cursor: pointer;
        }
         .reminder-table-modal #add-new-reminder:hover { background-color: #16A34A; }

        .reminder-table-modal #close-reminders-top, /* Botón Salir Arriba */
        .reminder-table-modal #close-reminders-bottom { /* Botón Salir Abajo */
            background-color: #2563EB; /* Azul */
            color: #FFFFFF; font-size: 1.25rem; padding: 0.75rem 3rem; /* Ancho */
            border-radius: 0.5rem; border: 2px solid #1E40AF; cursor: pointer;
            display: inline-block;
        }
         .reminder-table-modal #close-reminders-top:hover,
         .reminder-table-modal #close-reminders-bottom:hover {
             background-color: #1D4ED8;
         }
         /* Contenedor para el botón Salir de abajo */
         .reminder-table-modal .bottom-button-container {
             display: flex;
             justify-content: center; /* Centrar el botón Salir de abajo */
             margin-top: 1rem;
         }


        /* Globo contador (si aún se usa fuera del botón) */
        .reminder-count-globe {
            position: fixed; top: 10px; left: 10px; background-color: #EF4444; color: white;
            border-radius: 50%; padding: 8px 12px; font-size: 1rem; font-weight: bold;
            z-index: 1500; display: none; /* Oculto si usamos el del botón */
        }
        .minimal-mode .reminder-count-globe,
        .minimal-mode .reminder-notification { display: none !important; }

        /* Clases para ocultar/mover header (si aplica) */
        main.header-hidden { margin-top: -1.25rem; }
        .reminder-count-globe.header-hidden,
        #reminder-notifications.header-hidden,
        .notices-icon-container.header-hidden,
        footer.header-hidden { margin-top: -1.25rem; }

        /* === FIN CSS PROPORCIONADO (con ajustes) === */
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-6"> <div id="modal-overlay" class="modal-overlay"></div>

    <div id="reminder-notifications">
        </div>

    <div class="reminder-count-globe" id="reminder-count-globe"></div>

    <div class="top-text-container">
        <div class="arrow-button" id="back-button" title="Ir atrás">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
        </div>
        <span>[ Web anterior o posterior arrastre hacia los bordes ]</span>
        <div class="arrow-button" id="forward-button" title="Ir adelante">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
        </div>
    </div>

    <main>
        <div id="bookmark-grid">
            </div>
    </main>

    <div class="notices-icon-container">
        <img src="https://boardinggate.github.io/Tesla/IMG_4194.jpg" alt="Activar/Desactivar Avisos" class="notice-off-icon" id="notice-toggle-icon" title="Activar/Desactivar Avisos">
        <div class="notices-container">
            <div class="notice-wrapper">
                <span class="notice" id="current-notice">Cargando avisos...</span>
            </div>
        </div>
    </div>

    <footer>
        <div class="footer-content">
            <div class="header-container">
                <img src="https://boardinggate.github.io/Tesla/LOGOTESLA.jpg" alt="Logo Tesla" class="header-logo">
                <div class="title-container">
                    <h1 class="text-2xl font-bold inline">
                        <span class="text-2xl">BoardingGate</span>
                        <span class="text-base">Lanzador</span>
                        <span id="version" class="version-text"></span>
                    </h1>
                </div>
            </div>
            <div class="footer-line">
                <a href="https://x.com/boardinggate?s=21" class="footer-link-green" target="_blank" rel="noopener noreferrer">@BoardingGate</a>
                <span class="text-green-200" style="font-size: 1.5rem;">🤝</span>
                <a href="https://x.com/boardinggate/status/1857325553742721116?s=46" class="footer-link-green" target="_blank" rel="noopener noreferrer">Ahorremos un dinero con mis REFERIDOS</a>
            </div>
            <p class="footer-subtext">La inteligencia tiene ciertas limitaciones. La locura, casi ninguna 🫶 🤟</p>
        </div>
    </footer>

    <div class="counter-wrapper">
        <div class="counter-container">
            <div id="sfcg896pbr68y2dejczgbn1ys664xjxdf2d"></div>
            <script type="text/javascript" src="https://counter4.optistats.ovh/private/counter.js?c=g896pbr68y2dejczgbn1ys664xjxdf2d&down=async" async></script>
            <noscript><a href="https://www.contadorvisitasgratis.com" title="contador de visitas gratis"><img src="https://counter4.optistats.ovh/private/contadorvisitasgratis.php?c=g896pbr68y2dejczgbn1ys664xjxdf2d" border="0" title="contador de visitas gratis" alt="contador de visitas gratis"></a></noscript>
        </div>
    </div>

    <div id="scroll-toggle" class="left-sidebar-button" title="Ir al inicio o fin">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19V5M5 12l7-7 7 7"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14M19 12l-7 7-7-7"/></svg>
    </div>
    <div id="dark-mode-toggle" class="left-sidebar-button" title="Modo Oscuro/Claro">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun hidden"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
    </div>
    <div id="home-button" class="left-sidebar-button" title="Inicio (Lanzador)">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
    </div>
     <div id="reload-button" class="left-sidebar-button" title="Recargar Página">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
    </div>
     <div id="weather-button" class="left-sidebar-button" title="Ventusky (Tiempo)">
         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22.61 16.94a3.43 3.43 0 0 0-3.71-.46l-4.77 1.63-5.2-5.2a3.43 3.43 0 0 0-.46-3.71L3.06 4.8a1.5 1.5 0 0 0-2.12 2.12l4.4 4.4a3.43 3.43 0 0 0 3.71.46l5.2 5.2a3.43 3.43 0 0 0 .46 3.71l4.4 4.4a1.5 1.5 0 0 0 2.12-2.12z"></path><path d="M10 14l-3 3 4 4 3-3"></path><path d="m14 6 3-3-4-4-3 3"></path><path d="M16 18a4 4 0 0 0-5.66-5.66"></path><path d="M12 12l1.41-1.41"></path><path d="m6 6 1.41-1.41"></path></svg>
     </div>
     <div id="zoom-button" class="left-sidebar-button" title="Zoom +/-">
         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="zoom-in"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="11" y1="8" x2="11" y2="14"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg>
         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="zoom-out hidden"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg>
     </div>
     <div id="reminder-button" class="left-sidebar-button" title="Gestionar Recordatorios">
         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path><line x1="10" y1="10" x2="14" y2="14"></line><line x1="14" y1="10" x2="10" y2="14"></line></svg>
         <span class="reminder-count hidden" id="reminder-count-badge">0</span>
     </div>
     <div id="config-button" class="left-sidebar-button" title="Configuración (Ayuda)">
         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
     </div>
     <div id="on-off-toggle" class="left-sidebar-button" title="Modo Mínimal/Completo">
         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18.36 6.64a9 9 0 1 1-12.73 0"></path><line x1="12" y1="2" x2="12" y2="12"></line></svg>
     </div>


    <div id="reminder-modal-container" class="modal-base reminder-modal">
        </div>
    <div id="reminder-table-modal-container" class="modal-base reminder-table-modal">
        </div>
    <div id="help-modal-container" class="modal-base help-modal">
        </div>


    <script>
        // === INICIO JavaScript ===

        // Bloqueador de ventanas emergentes básico (ya proporcionado)
        (function() {
            const originalOpen = window.open;
            window.open = function(url, windowName, specs) {
                console.warn('Intento de abrir ventana:', url, windowName, specs);
                // Añadir dominios sospechosos aquí si es necesario
                const blockedDomains = ['optistats.ovh', 'ads.', 'ad.', 'popup', 'doubleclick.net', 'adservice.google.com'];
                if (url && blockedDomains.some(domain => url.includes(domain))) {
                    console.log('Ventana emergente bloqueada:', url);
                    // Podríamos mostrar una notificación discreta al usuario
                    // showEphemeralMessage("Ventana emergente bloqueada: " + url);
                    return null; // Bloquea la apertura
                }
                // Permitir abrir ventanas que no coincidan con los dominios bloqueados
                // OJO: Ser cuidadoso con qué se permite. Quizás solo permitir URLs relativas o de dominios conocidos.
                console.log('Permitiendo abrir ventana:', url);
                return originalOpen.apply(this, arguments);
            };
        })();

        // --- Constantes y Variables Globales ---
        const bookmarks = [
            { name: "YouTube", url: "https://www.youtube.com" },
            { name: "Google", url: "https://www.google.com" },
            { name: "GDrive", url: "https://drive.google.com", favicon: "./IMG_4172.png" },
            { name: "GMail", url: "https://mail.google.com/mail/mu/mp/603/#tl/Recibidos", favicon: "./IMG_4171.png"},
            { name: "Google Fotos", url: "https://photos.google.com" },
            { name: "iCloud", url: "https://www.icloud.com/", favicon: "https://www.google.com/s2/favicons?domain=icloud.com&sz=64" },
            { name: "ABRP", url: "https://abetterrouteplanner.com" },
            { name: "ElectroMaps", url: "https://map.electromaps.com/es/", favicon: "https://www.google.com/s2/favicons?domain=electromaps.com&sz=64" },
            { name: "REVE PdR España", url: "https://www.mapareve.es/mapa-puntos-recarga", favicon: "https://www.google.com/s2/favicons?domain=mapareve.es&sz=64" },
            { name: "PdR,s", url: "https://www.google.com/maps/search/puntos+recarga+veh%C3%ADculos+el%C3%A9ctricos", favicon: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M12 18h8v2h-8v-2z'/><path d='M12 14h8v2h-8v-2z'/><path d='M12 10h8v2h-8v-2z'/><path d='M12 6h8v2h-8V6z'/><path d='M4 18h4v-2H4v2zM4 14h4v-2H4v2zM4 10h4v-2H4v2zM4 6h4V4H4v2z'/></svg>" },
            { name: "Google Maps", url: "https://maps.google.com" },
            { name: "Ventusky", url: "https://www.ventusky.com/?p=40.2;-4.7;5&l=rain-3h", favicon: "https://www.google.com/s2/favicons?domain=ventusky.com&sz=64" },
            { name: "TESSIE", url: "https://dash.tessie.com/signin", favicon: "https://www.google.com/s2/favicons?domain=tessie.com&sz=64" },
            { name: "Mis Updates", url: "https://dash.tessie.com/software", favicon: "https://cdn-icons-png.flaticon.com/512/148/148767.png" },
            { name: "Olas Updates", url: "https://es.stats.tessie.com/", favicon: "https://cdn-icons-png.flaticon.com/512/5815/5815902.png" },
            { name: "NotaTeslaApp", url: "https://www.notateslaapp.com/software-updates/" },
            { name: "ENHAUTO", url: "https://www.enhauto.com" },
            { name: "MAREAS", url: "https://www.meteogalicia.gal/web/predicion/mareas-e-luas" },
            { name: "ELECTROVERSE", url: "https://electroverse.com/es/map", favicon: "https://www.google.com/s2/favicons?domain=electroverse.com&sz=64" },
            { name: "ACCIONA", url: "https://www.google.com/maps/search/recarga+Acciona", favicon: "https://www.google.com/s2/favicons?domain=acciona.com&sz=64" },
            { name: "IBERDROLA", url: "https://www.google.com/maps/search/recarga+IBERDROLA", favicon: "https://www.google.com/s2/favicons?domain=iberdrola.com&sz=64" },
            { name: "WAYLET Repsol", url: "https://www.google.com/maps/search/recarga+REPSOL+Waylet", favicon: "https://www.google.com/s2/favicons?domain=repsol.com&sz=64" },
            { name: "ENDESA xWay", url: "https://www.google.com/maps/search/recarga+ENDESA+XWAY", favicon: "https://www.google.com/s2/favicons?domain=endesa.com&sz=64" }
        ];
        const bookmarkGrid = document.getElementById('bookmark-grid');
        const versionElement = document.getElementById('version');
        const modalOverlay = document.getElementById('modal-overlay');
        const reminderModalContainer = document.getElementById('reminder-modal-container');
        const reminderTableModalContainer = document.getElementById('reminder-table-modal-container');
        const helpModalContainer = document.getElementById('help-modal-container');
        const reminderNotificationsContainer = document.getElementById('reminder-notifications');
        const reminderCountBadge = document.getElementById('reminder-count-badge');
        // const reminderCountGlobe = document.getElementById('reminder-count-globe'); // Globo opcional
        const noticeToggleIcon = document.getElementById('notice-toggle-icon');
        const currentNoticeElement = document.getElementById('current-notice');
        const noticesContainer = document.querySelector('.notices-container');


        let reminders = [];
        let reminderCheckInterval = null;
        let currentReminderNotification = null; // Para saber si hay una notif activa
        let mainAutoSaveTimerId = null; // ID del timer principal de guardado
        let inactivityTimerId = null;   // ID del timer de inactividad
        const AUTO_SAVE_DURATION = 30; // Segundos para auto-guardar modal recordatorio
        const INACTIVITY_DELAY = 5000; // 5 segundos de inactividad para reiniciar timer
        const REMINDER_CHECK_INTERVAL = 30000; // Chequear recordatorios cada 30 segundos
        let notices = [];
        let currentNoticeIndex = 0;
        let noticeIntervalId = null;
        let noticesEnabled = true; // Estado inicial de los avisos
        const noticesURL = 'URL_DE_TUS_AVISOS.json'; // <-- ¡¡IMPORTANTE: PON AQUÍ LA URL DE TU ARCHIVO DE AVISOS!!

        // Web Speech API
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        let isRecognizing = false;

        // --- Inicialización ---
        document.addEventListener('DOMContentLoaded', () => {
            populateBookmarkGrid();
            setupSidebarButtonListeners();
            setupNavigationListeners();
            setupNoticeControls();
            fetchVersion(); // Obtener versión (implementar)
            loadReminders();
            startReminderChecks();
            updateReminderCount();
            loadNotices(); // Cargar avisos
             // Aplicar modo oscuro si estaba guardado
             if (localStorage.getItem('darkMode') === 'true') {
                 document.body.classList.add('dark-mode');
                 updateDarkModeButton(true);
             } else {
                 updateDarkModeButton(false);
             }
              // Aplicar modo minimal si estaba guardado
              if (localStorage.getItem('minimalMode') === 'true') {
                  document.body.classList.add('minimal-mode');
                  showMinimalModeMessage(true);
              }
              // Inicializar Speech Recognition si existe
              if (SpeechRecognition) {
                  recognition = new SpeechRecognition();
                  recognition.continuous = false; // Reconocer una sola vez
                  recognition.lang = 'es-ES';     // Establecer idioma español
                  recognition.interimResults = false; // No queremos resultados parciales
                  recognition.maxAlternatives = 1;

                  recognition.onresult = (event) => {
                      const speechResult = event.results[0][0].transcript;
                      const reminderTextArea = document.getElementById('reminder-text');
                      if (reminderTextArea) {
                          // Añadir al texto existente, o reemplazar si está vacío? Añadir:
                          reminderTextArea.value += (reminderTextArea.value.length > 0 ? ' ' : '') + speechResult.toUpperCase();
                          // Simular evento input para detener contador, etc.
                          reminderTextArea.dispatchEvent(new Event('input', { bubbles: true }));
                      }
                       stopRecognition(); // Parar después de un resultado
                  };

                  recognition.onerror = (event) => {
                      console.error('Speech recognition error:', event.error);
                      const statusElement = document.getElementById('speech-status');
                      if (statusElement) statusElement.textContent = `Error: ${event.error}`;
                      stopRecognition(); // Asegurarse de parar
                  };

                  recognition.onend = () => {
                      // Se llama cuando para, ya sea por resultado, error o manualmente
                      if (isRecognizing) { // Si paró inesperadamente, intentar reiniciar? O mejor dejarlo parado.
                          // console.log("Speech recognition ended unexpectedly.");
                          stopRecognition(); // Asegurar estado correcto
                      }
                  };
              } else {
                   console.warn("Web Speech API no soportada en este navegador.");
                   // Podrías ocultar el botón de hablar aquí
              }

        });

        // --- Grid de Marcadores ---
        function populateBookmarkGrid() {
            bookmarkGrid.innerHTML = ''; // Limpiar grid existente
            bookmarks.forEach(bm => {
                const div = document.createElement('div');
                div.className = 'bookmark-item p-2 flex flex-col justify-center items-center rounded-lg cursor-pointer'; // Clases Tailwind/CSS

                const link = document.createElement('a');
                link.href = bm.url;
                link.target = "_blank"; // Abrir en nueva pestaña (o _self para la misma)
                link.rel = "noopener noreferrer";
                link.className = "flex flex-col items-center justify-center w-full h-full"; // Enlace ocupa todo el div

                const img = document.createElement('img');
                img.src = bm.favicon || `https://www.google.com/s2/favicons?domain=${getDomain(bm.url)}&sz=64`;
                img.alt = bm.name;
                img.className = 'w-9 h-auto max-w-[40px] rounded-md mb-1'; // Clases imagen
                img.onerror = (e) => { // Fallback si el favicon falla
                    e.target.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="gray"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>';
                };

                const nameSpan = document.createElement('span');
                nameSpan.className = 'bookmark-name text-xs md:text-sm font-bold text-center mt-1 overflow-hidden whitespace-nowrap text-ellipsis w-full';
                nameSpan.textContent = bm.name || getDomain(bm.url); // Usar nombre o dominio
                nameSpan.title = bm.name || getDomain(bm.url); // Tooltip con el nombre completo

                link.appendChild(img);
                link.appendChild(nameSpan);
                div.appendChild(link);
                bookmarkGrid.appendChild(div);
            });
        }

        function getDomain(url) {
            try {
                return new URL(url).hostname.replace(/^www\./, '');
            } catch (e) {
                return url; // Devolver URL original si no es válida
            }
        }

        // --- Lógica Botones Barra Lateral ---
        function setupSidebarButtonListeners() {
            // Scroll
            document.getElementById('scroll-toggle').addEventListener('click', () => {
                if (window.scrollY > window.innerHeight / 2) {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                } else {
                    window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
                }
            });

            // Dark Mode
            document.getElementById('dark-mode-toggle').addEventListener('click', toggleDarkMode);

            // Home (asumiendo que recarga o va a una página específica)
            document.getElementById('home-button').addEventListener('click', () => {
                window.location.href = window.location.pathname; // Recargar la misma página
            });

            // Reload
            document.getElementById('reload-button').addEventListener('click', () => {
                 window.location.reload();
            });

            // Weather (abre Ventusky)
            document.getElementById('weather-button').addEventListener('click', () => {
                 const ventuskyUrl = bookmarks.find(bm => bm.name === "Ventusky")?.url;
                 if (ventuskyUrl) window.open(ventuskyUrl, '_blank');
            });

            // Zoom
            const zoomButton = document.getElementById('zoom-button');
            const zoomInIcon = zoomButton.querySelector('.zoom-in');
            const zoomOutIcon = zoomButton.querySelector('.zoom-out');
            let currentZoom = 1;
            zoomButton.addEventListener('click', () => {
                if (currentZoom === 1) {
                     document.body.style.zoom = 1.2;
                     currentZoom = 1.2;
                     zoomInIcon.classList.add('hidden');
                     zoomOutIcon.classList.remove('hidden');
                     zoomButton.classList.add('zoomed'); // Marcar estado zoomed
                } else {
                     document.body.style.zoom = 1;
                     currentZoom = 1;
                     zoomInIcon.classList.remove('hidden');
                     zoomOutIcon.classList.add('hidden');
                     zoomButton.classList.remove('zoomed');
                }
            });


            // Reminder Button (abre la tabla)
            document.getElementById('reminder-button').addEventListener('click', showAllReminders);

            // Config Button (abre ayuda)
            document.getElementById('config-button').addEventListener('click', showHelpModal);

            // On/Off Minimal Mode
            document.getElementById('on-off-toggle').addEventListener('click', toggleMinimalMode);
        }

        // --- Navegación Historial ---
        function setupNavigationListeners() {
            document.getElementById('back-button').addEventListener('click', () => window.history.back());
            document.getElementById('forward-button').addEventListener('click', () => window.history.forward());
        }

        // --- Dark Mode ---
        function toggleDarkMode() {
            const isDark = document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', isDark); // Guardar preferencia
            updateDarkModeButton(isDark);
        }

        function updateDarkModeButton(isDark) {
            const toggleButton = document.getElementById('dark-mode-toggle');
            const moonIcon = toggleButton.querySelector('.feather-moon');
            const sunIcon = toggleButton.querySelector('.feather-sun');
            if (isDark) {
                moonIcon.classList.add('hidden');
                sunIcon.classList.remove('hidden');
            } else {
                moonIcon.classList.remove('hidden');
                sunIcon.classList.add('hidden');
            }
        }

         // --- Minimal Mode ---
         function toggleMinimalMode() {
             const isMinimal = document.body.classList.toggle('minimal-mode');
             localStorage.setItem('minimalMode', isMinimal); // Guardar preferencia
             showMinimalModeMessage(isMinimal); // Mostrar/ocultar mensaje
         }

         function showMinimalModeMessage(isMinimal) {
             let messageElement = document.getElementById('minimal-mode-message');
             if (isMinimal) {
                 if (!messageElement) {
                     messageElement = document.createElement('div');
                     messageElement.id = 'minimal-mode-message';
                     messageElement.className = 'minimal-mode-message';
                     messageElement.textContent = 'Modo Mínimal Activo';
                     document.body.appendChild(messageElement);
                 }
                 messageElement.style.display = 'block';
             } else {
                 if (messageElement) {
                     messageElement.style.display = 'none';
                 }
             }
         }


        // --- Obtener Versión (Placeholder) ---
        function fetchVersion() {
            // Implementa aquí cómo obtienes la versión (ej: de un archivo, API, etc.)
            const version = "1.2.3"; // Ejemplo
            if (versionElement) versionElement.textContent = `v${version}`;
        }

        // --- Gestión de Modales (Abrir/Cerrar Genérico) ---
        function openModal(modalContainer) {
            modalOverlay.classList.add('active');
            modalContainer.classList.add('active');
             // Deshabilitar scroll del body mientras el modal está abierto
             document.body.style.overflow = 'hidden';
        }

        function closeModal(modalContainer) {
            modalOverlay.classList.remove('active');
            modalContainer.classList.remove('active');
            modalContainer.innerHTML = ''; // Limpiar contenido al cerrar
            // Rehabilitar scroll del body
             document.body.style.overflow = 'auto';

             // Limpiar timers globales de modal recordatorio si se cierran
              clearTimeout(mainAutoSaveTimerId);
              clearTimeout(inactivityTimerId);
              mainAutoSaveTimerId = null;
              inactivityTimerId = null;
              // Detener reconocimiento si estaba activo
               if (isRecognizing) {
                   stopRecognition();
               }
        }

        // --- Ayuda Modal ---
        function showHelpModal() {
            // Generar contenido HTML para la ayuda
            helpModalContainer.innerHTML = `
                <h2>Ayuda y Configuración</h2>
                <p>Bienvenido al Lanzador BoardingGate.</p>
                <p>Funciones principales:</p>
                <ul>
                    <li>Acceso rápido a sitios web frecuentes.</li>
                    <li>Gestión de Recordatorios con notificaciones.</li>
                    <li>Modo Oscuro y Modo Mínimal.</li>
                    <li>Información de Avisos (si está configurado).</li>
                </ul>
                <h3>Recordatorios:</h3>
                <ul>
                    <li>Crea recordatorios con fecha, hora, repetición e intervalo.</li>
                    <li>Recibe notificaciones visuales cuando un recordatorio vence.</li>
                    <li>Puedes posponer, modificar o cancelar desde la notificación.</li>
                    <li>Gestiona todos tus recordatorios desde la tabla (botón campana).</li>
                    <li>El formulario de creación/edición tiene auto-guardado por inactividad.</li>
                    <li>Puedes usar el botón "Hablar" para dictar el texto del recordatorio.</li>
                </ul>
                 <h3>Botones Laterales:</h3>
                 <ul>
                    <li>Scroll: Inicio/Fin de página.</li>
                    <li>Luna/Sol: Cambia Modo Oscuro/Claro.</li>
                    <li>Casa: Vuelve a esta página.</li>
                    <li>Flecha Circular: Recarga la página.</li>
                    <li>Nube/Viento: Abre Ventusky (Tiempo).</li>
                    <li>Lupa: Aplica/Quita Zoom.</li>
                    <li>Campana: Abre la lista de Recordatorios.</li>
                    <li>Engranaje: Muestra esta Ayuda.</li>
                    <li>Power: Activa/Desactiva Modo Mínimal.</li>
                 </ul>
                <button id="close-help" class="mt-4">Cerrar Ayuda</button>
            `;
            openModal(helpModalContainer);
            // Añadir listener al botón de cerrar específico de este modal
            document.getElementById('close-help').addEventListener('click', () => closeModal(helpModalContainer));
        }

        // --- Lógica de Recordatorios ---

        // Cargar desde localStorage
        function loadReminders() {
            const storedReminders = localStorage.getItem('bg_reminders');
            if (storedReminders) {
                reminders = JSON.parse(storedReminders);
                // Convertir fechas de string a Date object si es necesario (depende de cómo se guarden)
                reminders.forEach(r => {
                    if (r.nextDueDate && typeof r.nextDueDate === 'string') {
                         r.nextDueDate = new Date(r.nextDueDate);
                    }
                     if (r.createdAt && typeof r.createdAt === 'string') {
                         r.createdAt = new Date(r.createdAt);
                     }
                });
            } else {
                reminders = [];
            }
            // Ordenar por fecha de vencimiento más próxima
             reminders.sort((a, b) => (a.nextDueDate || new Date(8640000000000000)) - (b.nextDueDate || new Date(8640000000000000)));
            updateReminderCount();
        }

        // Guardar en localStorage
        function saveReminders() {
             // Asegurarse que las fechas se guardan como ISO strings
            const remindersToSave = reminders.map(r => ({
                ...r,
                nextDueDate: r.nextDueDate instanceof Date ? r.nextDueDate.toISOString() : r.nextDueDate,
                createdAt: r.createdAt instanceof Date ? r.createdAt.toISOString() : r.createdAt
            }));
            localStorage.setItem('bg_reminders', JSON.stringify(remindersToSave));
            updateReminderCount();
            // Reordenar después de guardar por si las fechas cambiaron
            loadReminders(); // Recarga y reordena
        }

        // Actualizar contador visual
        function updateReminderCount() {
            const activeRemindersCount = reminders.filter(r => !r.completed).length; // Contar solo activos
            if (reminderCountBadge) {
                reminderCountBadge.textContent = activeRemindersCount;
                reminderCountBadge.classList.toggle('hidden', activeRemindersCount === 0);
            }
            // Actualizar globo opcional
            // if (reminderCountGlobe) {
            //     reminderCountGlobe.textContent = activeRemindersCount;
            //     reminderCountGlobe.style.display = activeRemindersCount > 0 ? 'flex' : 'none';
            // }
        }

        // Iniciar chequeo periódico
        function startReminderChecks() {
            if (reminderCheckInterval) clearInterval(reminderCheckInterval);
            checkReminders(); // Chequeo inicial
            reminderCheckInterval = setInterval(checkReminders, REMINDER_CHECK_INTERVAL);
        }

        // Chequear si hay recordatorios vencidos
        function checkReminders() {
            // console.log("Chequeando recordatorios...");
            if (currentReminderNotification) return; // No mostrar nuevo si ya hay uno

            const now = new Date();
            const dueReminders = reminders.filter(r =>
                !r.completed && r.nextDueDate && r.nextDueDate <= now
            );

             // Ordenar los vencidos por fecha (el más antiguo primero)
             dueReminders.sort((a, b) => a.nextDueDate - b.nextDueDate);


            if (dueReminders.length > 0) {
                // Mostrar notificación para el MÁS VENCIDO primero
                showReminderNotification(dueReminders[0]);
            }
        }

        // Mostrar Notificación Flotante
        function showReminderNotification(reminder) {
            if (currentReminderNotification) return; // Ya hay una activa

            currentReminderNotification = reminder; // Marcar como activa

            const notificationDiv = document.createElement('div');
            notificationDiv.id = `notification-${reminder.id}`;
            notificationDiv.className = 'reminder-notification active'; // Añadir active para mostrarla

            const timeString = reminder.time || '';
            const dateString = reminder.date ? new Date(reminder.date + 'T' + (reminder.time || '00:00')).toLocaleDateString('es-ES') : '';
            const details = [dateString, timeString].filter(Boolean).join(' - ');

            notificationDiv.innerHTML = `
                <div class="reminder-text">${reminder.text}</div>
                ${details ? `<div class="reminder-details">(${details})</div>` : ''}
                <div class="button-group">
                    <button class="postpone" data-id="${reminder.id}">Posponer 1H</button>
                    <button class="modify" data-id="${reminder.id}">Modificar</button>
                    <button class="cancel" data-id="${reminder.id}">Hecho</button>
                </div>
            `;

            reminderNotificationsContainer.appendChild(notificationDiv);

            // Añadir listeners a los botones de la notificación
            notificationDiv.querySelector('.postpone').addEventListener('click', () => handleNotificationAction('postpone', reminder.id));
            notificationDiv.querySelector('.modify').addEventListener('click', () => handleNotificationAction('modify', reminder.id));
            notificationDiv.querySelector('.cancel').addEventListener('click', () => handleNotificationAction('cancel', reminder.id));
        }

        // Manejar acción desde la notificación
        function handleNotificationAction(action, reminderId) {
            const reminder = reminders.find(r => r.id === reminderId);
            if (!reminder) return;

            const notificationDiv = document.getElementById(`notification-${reminderId}`);

            switch (action) {
                case 'postpone':
                    // Calcular próxima ocurrencia (1 hora después)
                    reminder.nextDueDate = new Date(Date.now() + 60 * 60 * 1000);
                    // Si era repetitivo, mantenemos la lógica de repetición original para el futuro,
                    // pero la siguiente notificación será en 1h.
                    // Si no era repetitivo, simplemente se pospone.
                    console.log(`Recordatorio ${reminder.id} pospuesto 1 hora.`);
                    break;
                case 'modify':
                    // Abrir el modal de edición para este recordatorio
                     closeNotification(reminderId); // Cerrar notificación antes de abrir modal
                    showReminderModal(reminder);
                    return; // Salir para no guardar ni cerrar notificación aquí
                case 'cancel': // Marcar como hecho/completado
                    if (reminder.repeat === 'none' || !reminder.repeat) {
                        reminder.completed = true; // Marcar como completado si no se repite
                         reminder.nextDueDate = null; // Borrar fecha de vencimiento
                        console.log(`Recordatorio ${reminder.id} marcado como completado.`);
                    } else {
                        // Si se repite, calcular la siguiente fecha y no marcar como completado
                        reminder.nextDueDate = calculateNextDueDate(reminder);
                        console.log(`Recordatorio ${reminder.id} completado por ahora, siguiente ocurrencia: ${reminder.nextDueDate?.toLocaleString('es-ES')}`);
                    }
                    break;
            }

            saveReminders();
            closeNotification(reminderId);
        }

         // Cerrar notificación específica
         function closeNotification(reminderId) {
             const notificationDiv = document.getElementById(`notification-${reminderId}`);
             if (notificationDiv) {
                 notificationDiv.remove();
             }
             if (currentReminderNotification && currentReminderNotification.id === reminderId) {
                 currentReminderNotification = null; // Liberar bloqueo
                 // Quizás chequear de nuevo si hay otros vencidos inmediatamente?
                  setTimeout(checkReminders, 500); // Pequeño delay antes de re-chequear
             }
         }

        // --- Modal Formulario Recordatorio (showReminderModal) ---
        function showReminderModal(reminderToEdit = null) {
            // Limpiar timers anteriores si se abre un nuevo modal
            clearTimeout(mainAutoSaveTimerId);
            clearTimeout(inactivityTimerId);

            const isEditing = reminderToEdit !== null;
            const modalTitle = isEditing ? 'Editar Recordatorio' : 'Nuevo Recordatorio';
            const submitButtonText = 'Aceptar'; // Texto fijo, el contador va al lado

            // Valores por defecto o del recordatorio a editar
            const defaultTime = new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit'});
            const defaultDate = new Date().toISOString().split('T')[0]; // Formato YYYY-MM-DD

            const currentText = reminderToEdit?.text || '';
            const currentDate = reminderToEdit?.date || defaultDate;
            const currentTime = reminderToEdit?.time || defaultTime;
            const currentRepeat = reminderToEdit?.repeat || 'none';
            const currentInterval = reminderToEdit?.interval || 1;
            const currentIntervalUnit = reminderToEdit?.intervalUnit || 'days';
            const currentDays = reminderToEdit?.days || []; // Array de días [0-6]

             // Formatear fecha para input type="date" (YYYY-MM-DD)
            let inputDateValue = defaultDate;
             if (reminderToEdit?.date) {
                 try {
                     inputDateValue = new Date(reminderToEdit.date + 'T00:00:00').toISOString().split('T')[0];
                 } catch (e) { console.error("Error parsing reminder date:", reminderToEdit.date); }
             } else if (isEditing && !reminderToEdit?.date && reminderToEdit?.nextDueDate) {
                 // Si no tiene fecha pero sí nextDueDate (p.ej. solo hora), usar la fecha de nextDueDate
                 try {
                     inputDateValue = reminderToEdit.nextDueDate.toISOString().split('T')[0];
                 } catch(e) {}
             }

             // Formatear hora para input type="time" (HH:MM)
             let inputTimeValue = defaultTime;
             if (reminderToEdit?.time) {
                  // Asegurarse de que tiene formato HH:MM
                  const timeParts = reminderToEdit.time.split(':');
                  if (timeParts.length === 2) {
                      inputTimeValue = `${timeParts[0].padStart(2, '0')}:${timeParts[1].padStart(2, '0')}`;
                  }
             }


            reminderModalContainer.innerHTML = `
                <h2>${modalTitle}</h2>
                <form id="reminder-form">
                    <div class="full-width mb-3 relative">
                        <label for="reminder-text">Texto Recordatorio:</label>
                         <div class="flex items-start">
                             <textarea id="reminder-text" name="text" rows="3" required class="flex-grow">${currentText}</textarea>
                              ${SpeechRecognition ? '<button type="button" id="speech-button" class="speech-button" title="Dictar texto">🎤</button>' : ''}
                         </div>
                         ${SpeechRecognition ? '<div id="speech-status" class="speech-status"></div>' : ''}
                    </div>

                    <div class="form-grid">
                        <div>
                            <label for="reminder-date">Fecha:</label>
                            <input type="date" id="reminder-date" name="date" value="${inputDateValue}">
                        </div>
                        <div>
                            <label for="reminder-time">Hora:</label>
                            <input type="time" id="reminder-time" name="time" value="${inputTimeValue}">
                        </div>
                        <div>
                            <label for="reminder-repeat">Repetir:</label>
                            <select id="reminder-repeat" name="repeat" class="w-full p-2 border rounded text-base"> <option value="none" ${currentRepeat === 'none' ? 'selected' : ''}>Nunca</option>
                                <option value="daily" ${currentRepeat === 'daily' ? 'selected' : ''}>Diario</option>
                                <option value="weekly" ${currentRepeat === 'weekly' ? 'selected' : ''}>Semanal</option>
                                <option value="monthly" ${currentRepeat === 'monthly' ? 'selected' : ''}>Mensual</option>
                                <option value="yearly" ${currentRepeat === 'yearly' ? 'selected' : ''}>Anual</option>
                                <option value="interval" ${currentRepeat === 'interval' ? 'selected' : ''}>Intervalo</option>
                            </select>
                        </div>
                        <div id="interval-options" class="${currentRepeat === 'interval' ? '' : 'hidden'}">
                            <label for="reminder-interval">Cada:</label>
                            <div class="flex gap-1">
                                <input type="number" id="reminder-interval" name="interval" min="1" value="${currentInterval}" class="w-1/2">
                                <select id="reminder-interval-unit" name="intervalUnit" class="w-1/2 p-2 border rounded text-base">
                                    <option value="minutes" ${currentIntervalUnit === 'minutes' ? 'selected' : ''}>Minutos</option>
                                    <option value="hours" ${currentIntervalUnit === 'hours' ? 'selected' : ''}>Horas</option>
                                    <option value="days" ${currentIntervalUnit === 'days' ? 'selected' : ''}>Días</option>
                                    <option value="weeks" ${currentIntervalUnit === 'weeks' ? 'selected' : ''}>Semanas</option>
                                </select>
                            </div>
                        </div>
                         <div id="weekly-options" class="full-width mt-2 ${currentRepeat === 'weekly' ? '' : 'hidden'}">
                             <label>Días de la semana:</label>
                             <div class="days-group">
                                 ${['L', 'M', 'X', 'J', 'V', 'S', 'D'].map((day, index) => `
                                     <label>
                                         <input type="checkbox" name="days" value="${index}" ${currentDays.includes(index.toString()) ? 'checked' : ''}> ${day}
                                     </label>
                                 `).join('')}
                             </div>
                         </div>
                    </div>

                    <div class="button-group">
                        <button type="button" id="clear-reminder-button" class="clear-button">Limpiar</button>
                        <button type="submit" id="save-reminder-button">${submitButtonText} <span id="countdown-save"></span></button>
                        <button type="button" id="cancel-reminder-button" class="cancel-button">Salir</button>
                    </div>
                </form>
            `;

            openModal(reminderModalContainer);

            // --- Listeners específicos del modal de recordatorio ---
            const form = document.getElementById('reminder-form');
            const repeatSelect = document.getElementById('reminder-repeat');
            const intervalOptions = document.getElementById('interval-options');
            const weeklyOptions = document.getElementById('weekly-options');
            const reminderTextInput = document.getElementById('reminder-text');
            const dateInput = document.getElementById('reminder-date');
            const timeInput = document.getElementById('reminder-time');
            const speechButton = document.getElementById('speech-button');
            const speechStatus = document.getElementById('speech-status');

            // Mostrar/ocultar opciones de intervalo/semanal
            repeatSelect.addEventListener('change', () => {
                intervalOptions.classList.toggle('hidden', repeatSelect.value !== 'interval');
                weeklyOptions.classList.toggle('hidden', repeatSelect.value !== 'weekly');
            });

            // Formateo automático de hora
            timeInput.addEventListener('input', (e) => {
                 formatTimeInput(e.target);
            });
             timeInput.addEventListener('blur', (e) => { // También al perder foco por si acaso
                 formatTimeInput(e.target);
             });


             // Formateo automático de fecha (menos necesario con type="date", pero como ejemplo)
            /* dateInput.addEventListener('input', (e) => {
                 formatDateInput(e.target); // Asumiendo que quieres DDMMAAAA -> DD/MM/AAAA si no fuera type="date"
             }); */

            // Listener de submit
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                saveReminderFromForm(isEditing ? reminderToEdit.id : null);
            });

            // Botón Limpiar
            document.getElementById('clear-reminder-button').addEventListener('click', () => {
                 form.reset(); // Resetea el form a valores iniciales (puede no ser lo esperado si había datos de edición)
                 // Limpiar manualmente para asegurar estado inicial
                 document.getElementById('reminder-text').value = '';
                 document.getElementById('reminder-date').value = defaultDate;
                 document.getElementById('reminder-time').value = defaultTime;
                 document.getElementById('reminder-repeat').value = 'none';
                 document.getElementById('reminder-interval').value = 1;
                 document.getElementById('reminder-interval-unit').value = 'days';
                 document.querySelectorAll('#weekly-options input[type="checkbox"]').forEach(cb => cb.checked = false);
                 intervalOptions.classList.add('hidden');
                 weeklyOptions.classList.add('hidden');
                  reminderTextInput.focus(); // Foco al texto principal
                  // Detener y reiniciar timer si estaba activo
                  resetInactivityAndStopMainTimer(); // Reinicia timer de inactividad (que iniciará el principal)
            });

            // Botón Cancelar/Salir
            document.getElementById('cancel-reminder-button').addEventListener('click', () => {
                closeModal(reminderModalContainer);
            });

             // Botón Hablar (Speech Recognition)
             if (speechButton) {
                 speechButton.addEventListener('click', () => {
                     if (!recognition) return;
                     if (isRecognizing) {
                         stopRecognition();
                     } else {
                         startRecognition();
                     }
                 });
             }

             // --- Lógica Timer Auto-Guardado e Inactividad ---
             function startMainAutoSaveTimerLocal(setFocus = false) {
                 clearTimeout(mainAutoSaveTimerId);
                 clearTimeout(inactivityTimerId);
                 let countdown = AUTO_SAVE_DURATION;
                 const countdownElement = document.getElementById('countdown-save');
                 if (!countdownElement) return; // Salir si el modal ya no existe

                 countdownElement.textContent = `(${countdown}s)`;

                 if (setFocus) {
                     const reminderTextInput = document.getElementById('reminder-text');
                     if (reminderTextInput) reminderTextInput.focus();
                 }

                 mainAutoSaveTimerId = setInterval(() => {
                      if (!document.getElementById('reminder-form')) { // Comprobar si el modal sigue abierto
                          clearInterval(mainAutoSaveTimerId);
                          return;
                      }
                     countdown--;
                     countdownElement.textContent = `(${countdown}s)`;
                     if (countdown <= 0) {
                         clearInterval(mainAutoSaveTimerId);
                         countdownElement.textContent = "";
                         console.log("¡Tiempo agotado! Auto-guardando...");
                          // Guardar automáticamente
                          saveReminderFromForm(isEditing ? reminderToEdit.id : null);
                     }
                 }, 1000);
             }

             function resetInactivityAndStopMainTimerLocal() {
                 clearInterval(mainAutoSaveTimerId);
                 clearTimeout(inactivityTimerId);
                 const countdownElement = document.getElementById('countdown-save');
                  if (countdownElement) countdownElement.textContent = "--"; // Indicar pausa

                 inactivityTimerId = setTimeout(() => {
                      if (!document.getElementById('reminder-form')) return; // No reiniciar si el modal se cerró
                      console.log("Inactividad detectada, reiniciando contador...");
                      startMainAutoSaveTimerLocal(true); // Reinicia y pone foco
                  }, INACTIVITY_DELAY);
             }

             // Añadir listeners a TODOS los campos relevantes del formulario
             const formElements = form.querySelectorAll('textarea, input, select');
             formElements.forEach(element => {
                  const eventType = (element.type === 'checkbox' || element.type === 'radio') ? 'change' : 'input';
                  element.addEventListener(eventType, resetInactivityAndStopMainTimerLocal);
             });

             // Iniciar el contador al abrir el modal
             startMainAutoSaveTimerLocal(true); // Inicia y pone foco
        }

        // --- Formateo de Inputs ---
         function formatTimeInput(inputElement) {
             let value = inputElement.value.replace(/[^0-9]/g, ''); // Permitir solo números inicialmente
             let formattedValue = inputElement.value; // Mantener formato si ya tiene ":"

             if (value.length >= 3 && inputElement.value.indexOf(':') === -1) { // Si hay 3+ dígitos y no hay ':'
                 // Intentar formatear HHMM a HH:MM
                 const hours = value.substring(0, 2);
                 const minutes = value.substring(2, 4); // Tomar solo los 2 siguientes
                 if (parseInt(hours, 10) >= 0 && parseInt(hours, 10) <= 23 &&
                     parseInt(minutes, 10) >= 0 && parseInt(minutes, 10) <= 59) {
                     formattedValue = `${hours}:${minutes}`;
                 } else {
                     // Si los números no son válidos, quizás mantener los dígitos o limpiar?
                     // Por ahora, mantenemos los dígitos pero sin formatear automáticamente
                     formattedValue = value.substring(0, 4); // Limitar a 4 dígitos si no se pudo formatear
                 }
             } else if (inputElement.value.indexOf(':') > -1) {
                 // Si ya tiene ':', validar formato HH:MM
                 const parts = inputElement.value.split(':');
                 const hours = parts[0].replace(/[^0-9]/g, '').padStart(2,'0');
                 const minutes = parts[1] ? parts[1].replace(/[^0-9]/g, '').padStart(2,'0') : '00';
                 if (parseInt(hours, 10) >= 0 && parseInt(hours, 10) <= 23 &&
                     parseInt(minutes, 10) >= 0 && parseInt(minutes, 10) <= 59) {
                     formattedValue = `${hours}:${minutes}`;
                 } else {
                     // Formato inválido con ':', ¿qué hacer? Quizás volver a solo números?
                     // Por ahora, intentamos mantenerlo lo más cercano posible
                     formattedValue = `${hours.substring(0,2)}:${minutes.substring(0,2)}`;
                 }
             } else {
                  // Menos de 3 dígitos y sin ':', mantener como está (limitado a 4 chars?)
                  formattedValue = value.substring(0, 4);
             }

             // Actualizar valor solo si cambió para evitar bucles
             if (inputElement.value !== formattedValue) {
                 inputElement.value = formattedValue;
             }
         }


        // --- Guardar Recordatorio desde Formulario ---
        function saveReminderFromForm(editId = null) {
            const form = document.getElementById('reminder-form');
            if (!form) return;
            const formData = new FormData(form);
            const reminderData = Object.fromEntries(formData.entries());

            // Procesar días de la semana (checkboxes)
            reminderData.days = formData.getAll('days');

            // Crear o actualizar objeto recordatorio
            const newReminder = {
                id: editId || generateUUID(), // Generar nuevo ID si no se edita
                text: reminderData.text.toUpperCase(), // Guardar en mayúsculas
                date: reminderData.date || null, // Guardar YYYY-MM-DD o null
                time: reminderData.time || null, // Guardar HH:MM o null
                repeat: reminderData.repeat,
                interval: parseInt(reminderData.interval, 10) || 1,
                intervalUnit: reminderData.intervalUnit,
                days: reminderData.days, // Array de strings "0" a "6"
                completed: false, // Por defecto no completado
                createdAt: editId ? reminders.find(r => r.id === editId)?.createdAt : new Date(), // Mantener fecha creación original
                nextDueDate: null // Se calculará ahora
            };

            // Validaciones básicas
            if (!newReminder.text) {
                alert("El texto del recordatorio no puede estar vacío.");
                document.getElementById('reminder-text')?.focus();
                return;
            }
             if (!newReminder.date && !newReminder.time && newReminder.repeat === 'none') {
                 alert("Debe especificar al menos una fecha, hora o repetición.");
                 document.getElementById('reminder-date')?.focus();
                 return;
             }
             // Si es semanal, asegurar que haya días marcados
             if (newReminder.repeat === 'weekly' && newReminder.days.length === 0) {
                  alert("Si la repetición es semanal, debe seleccionar al menos un día.");
                  return;
             }


            // Calcular la próxima fecha de vencimiento
            newReminder.nextDueDate = calculateNextDueDate(newReminder);

             if (!newReminder.nextDueDate) {
                 console.warn("No se pudo calcular la próxima fecha de vencimiento. El recordatorio podría no activarse.", newReminder);
                 // Quizás alertar al usuario?
                 // alert("No se pudo determinar una fecha futura para este recordatorio con la configuración actual.");
                 // return; // O permitir guardarlo sin fecha? Mejor permitirlo.
             } else {
                  console.log("Próxima fecha calculada:", newReminder.nextDueDate.toLocaleString('es-ES'));
             }


            if (editId) {
                // Actualizar existente
                const index = reminders.findIndex(r => r.id === editId);
                if (index > -1) {
                    reminders[index] = { ...reminders[index], ...newReminder }; // Fusionar con datos existentes como createdAt
                }
            } else {
                // Añadir nuevo
                reminders.push(newReminder);
            }

            saveReminders();
            closeModal(reminderModalContainer);
            // Si la tabla estaba abierta, refrescarla
            if (document.getElementById('reminder-table')) {
                 showAllReminders(); // Recarga la tabla
            }
             checkReminders(); // Re-chequear por si el nuevo/editado ya está vencido
        }

        // --- Calcular Próxima Fecha de Vencimiento ---
         function calculateNextDueDate(reminder) {
             const now = new Date();
             let baseDate;
             let baseTime = reminder.time || '00:00'; // Hora por defecto si no se especifica

             // 1. Determinar la fecha/hora base para el cálculo
             if (reminder.date && reminder.time) {
                 baseDate = new Date(`${reminder.date}T${reminder.time}`);
             } else if (reminder.date) {
                 baseDate = new Date(`${reminder.date}T${baseTime}`);
             } else if (reminder.time) {
                 // Si solo hay hora, usar hoy o mañana como base
                 const [hours, minutes] = reminder.time.split(':').map(Number);
                 baseDate = new Date();
                 baseDate.setHours(hours, minutes, 0, 0);
                 if (baseDate <= now && reminder.repeat === 'none') { // Si es para hoy y ya pasó (y no se repite), usar mañana
                      baseDate.setDate(baseDate.getDate() + 1);
                 }
             } else if (reminder.repeat !== 'none') {
                  // Si no hay fecha/hora pero SÍ repetición (ej. intervalo), usar AHORA como base
                  baseDate = new Date();
             } else {
                 // No hay fecha, ni hora, ni repetición válida -> no se puede calcular
                 return null;
             }

             // Si la fecha base ya pasó y no hay repetición, no hay fecha futura
             if (baseDate <= now && reminder.repeat === 'none') {
                 return null;
             }

             // Si la fecha base es futura, esa es la primera ocurrencia
              if (baseDate > now && reminder.repeat === 'none') {
                  return baseDate;
              }


             // 2. Calcular según la repetición
             let nextDate = new Date(baseDate); // Clonar para no modificar la base

             // Si la fecha base ya pasó, calcular la SIGUIENTE ocurrencia futura
             if (nextDate <= now) {
                 switch (reminder.repeat) {
                     case 'daily':
                         nextDate.setDate(nextDate.getDate() + 1);
                         while (nextDate <= now) { // Asegurarse de que sea futura
                              nextDate.setDate(nextDate.getDate() + 1);
                         }
                         break;
                     case 'weekly':
                         const currentDay = (now.getDay() + 6) % 7; // 0=Lunes, 6=Domingo
                         const reminderDays = reminder.days.map(Number).sort(); // Días [0-6] seleccionados

                         if (reminderDays.length === 0) return null; // No hay días seleccionados

                         // Buscar el próximo día seleccionado A PARTIR DE HOY
                         let daysToAdd = 7; // Max días a sumar por defecto
                         let foundNext = false;
                          // ¿Hay un día seleccionado más tarde ESTA semana?
                         for (const day of reminderDays) {
                              if (day > currentDay) {
                                   daysToAdd = day - currentDay;
                                   foundNext = true;
                                   break;
                              }
                         }
                          // Si no, buscar el primer día seleccionado de la PRÓXIMA semana
                         if (!foundNext) {
                             daysToAdd = (7 - currentDay) + reminderDays[0];
                         }

                         nextDate = new Date(); // Empezar desde ahora para calcular día correcto
                         nextDate.setHours(baseDate.getHours(), baseDate.getMinutes(), 0, 0); // Poner la hora original
                         nextDate.setDate(nextDate.getDate() + daysToAdd);

                         break;
                     case 'monthly':
                         nextDate.setMonth(nextDate.getMonth() + 1);
                          while (nextDate <= now) {
                              nextDate.setMonth(nextDate.getMonth() + 1);
                          }
                         break;
                     case 'yearly':
                         nextDate.setFullYear(nextDate.getFullYear() + 1);
                          while (nextDate <= now) {
                              nextDate.setFullYear(nextDate.getFullYear() + 1);
                          }
                         break;
                     case 'interval':
                         const interval = reminder.interval || 1;
                         const unit = reminder.intervalUnit || 'days';
                         while (nextDate <= now) {
                             switch (unit) {
                                 case 'minutes': nextDate.setMinutes(nextDate.getMinutes() + interval); break;
                                 case 'hours': nextDate.setHours(nextDate.getHours() + interval); break;
                                 case 'days': nextDate.setDate(nextDate.getDate() + interval); break;
                                 case 'weeks': nextDate.setDate(nextDate.getDate() + interval * 7); break;
                                 default: nextDate.setDate(nextDate.getDate() + interval); // Default a días
                             }
                         }
                         break;
                     case 'none':
                     default:
                          // Ya manejado: si baseDate <= now y no repite, devuelve null arriba
                           // Si baseDate > now, devuelve baseDate arriba
                           return baseDate > now ? baseDate : null; // Seguridad
                 }
             }
              // Si la fecha base era futura, Y hay repetición, la primera es la baseDate
              else if (reminder.repeat !== 'none') {
                  // Necesitamos validar si el día de la semana coincide en caso 'weekly'
                  if (reminder.repeat === 'weekly') {
                      const baseDay = (baseDate.getDay() + 6) % 7;
                      if (!reminder.days.includes(baseDay.toString())) {
                          // La fecha base no coincide con los días semanales, recalcular como si hubiera pasado
                           nextDate = new Date(now); // Resetear a ahora
                           nextDate.setHours(baseDate.getHours(), baseDate.getMinutes(), 0, 0); // Poner la hora original
                           // Re-aplicar lógica de búsqueda de próximo día semanal
                             const currentDay = (now.getDay() + 6) % 7;
                             const reminderDays = reminder.days.map(Number).sort();
                              if (reminderDays.length === 0) return null;
                             let daysToAdd = 7;
                             let foundNext = false;
                              for (const day of reminderDays) { if (day > currentDay) { daysToAdd = day - currentDay; foundNext = true; break; } }
                             if (!foundNext) { daysToAdd = (7 - currentDay) + reminderDays[0]; }
                             nextDate.setDate(nextDate.getDate() + daysToAdd);
                      } else {
                          // La fecha base es futura Y coincide con el día semanal
                          nextDate = baseDate;
                      }
                  } else {
                      // Para otras repeticiones, si la base es futura, esa es la primera
                       nextDate = baseDate;
                  }
              }


             return nextDate; // Devolver la fecha calculada
         }


        // --- Modal Tabla de Recordatorios (showAllReminders) ---
        function showAllReminders() {
            loadReminders(); // Asegurar que tenemos los últimos datos y ordenados

            // Cabecera con botones Añadir y Salir
            const tableHeader = `
                <div class="table-button-bar">
                    <button id="add-new-reminder" title="Crear un nuevo recordatorio">+ Añadir Nuevo</button>
                    <button id="close-reminders-top" title="Cerrar esta ventana">SALIR</button>
                </div>
                <table id="reminder-table">
                    <thead>
                        <tr>
                            <th>Acciones</th>
                            <th>Texto</th>
                            <th>Próxima Vez</th>
                            <th>Repetición</th>
                            <th>Fecha Creación</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${reminders.length === 0 ? '<tr><td colspan="5">No hay recordatorios guardados.</td></tr>' : ''}
                        ${reminders.map(renderReminderRow).join('')}
                    </tbody>
                </table>
                <div class="bottom-button-container">
                     <button id="close-reminders-bottom" title="Cerrar esta ventana">SALIR</button>
                 </div>
            `;

            reminderTableModalContainer.innerHTML = tableHeader;
            openModal(reminderTableModalContainer);

            // --- Listeners de la tabla ---
            // Botones Salir (arriba y abajo)
            document.getElementById('close-reminders-top').addEventListener('click', () => closeModal(reminderTableModalContainer));
            document.getElementById('close-reminders-bottom').addEventListener('click', () => closeModal(reminderTableModalContainer));

            // Botón Añadir Nuevo
            document.getElementById('add-new-reminder').addEventListener('click', () => {
                 // Podríamos cerrar la tabla antes de abrir el form, o dejarla detrás
                 // closeModal(reminderTableModalContainer); // Opción 1: Cerrar tabla
                 showReminderModal(); // Abrir form nuevo
            });

            // Listeners para botones de acción en cada fila (delegación de eventos)
            const tableBody = reminderTableModalContainer.querySelector('tbody');
            tableBody.addEventListener('click', (event) => {
                const button = event.target.closest('button'); // Buscar botón clicado
                const row = event.target.closest('tr'); // Buscar fila clicada
                if (!row) return; // Salir si no se hizo clic en una fila

                const reminderId = row.dataset.reminderId;
                 if (!reminderId) return; // Salir si la fila no tiene ID

                if (button) { // Si se hizo clic en un botón DENTRO de la fila
                     event.stopPropagation(); // Detener la propagación para que no active el clic de fila
                    const action = button.dataset.action;
                    if (action === 'modify') {
                        const reminder = reminders.find(r => r.id === reminderId);
                        if (reminder) showReminderModal(reminder);
                    } else if (action === 'delete') {
                        if (confirm('¿Estás seguro de que quieres eliminar este recordatorio permanentemente?')) {
                            reminders = reminders.filter(r => r.id !== reminderId);
                            saveReminders();
                            showAllReminders(); // Recargar tabla
                        }
                    } else if (action === 'postpone') {
                         const reminder = reminders.find(r => r.id === reminderId);
                         if (reminder) {
                              reminder.nextDueDate = new Date(Date.now() + 60 * 60 * 1000); // Posponer 1h
                              saveReminders();
                              showAllReminders(); // Recargar tabla
                         }
                    }
                } else { // Si se hizo clic en la fila (fuera de un botón)
                    // Abrir modal de edición
                    const reminder = reminders.find(r => r.id === reminderId);
                    if (reminder) {
                         // closeModal(reminderTableModalContainer); // Opcional: cerrar tabla
                         showReminderModal(reminder);
                    }
                }
            });
        }

        // Renderizar una fila de la tabla
        function renderReminderRow(reminder) {
            const now = new Date();
            let rowClass = '';
            let nextDueString = 'N/A';
             let nextDueDateObject = null;

             if (reminder.nextDueDate) {
                try {
                     nextDueDateObject = new Date(reminder.nextDueDate); // Convertir si es string ISO
                     // Formatear fecha y hora
                      nextDueString = nextDueDateObject.toLocaleString('es-ES', {
                          year: '2-digit', month: '2-digit', day: '2-digit',
                          hour: '2-digit', minute: '2-digit'
                      });

                      // Determinar clase de la fila según la fecha
                      const diffHours = (nextDueDateObject - now) / (1000 * 60 * 60);
                      if (diffHours < 0) {
                          rowClass = 'overdue'; // Vencido
                      } else if (diffHours < 24) {
                          rowClass = 'due-soon'; // Próximo (menos de 24h)
                      }
                } catch(e) {
                    console.error("Error parsing nextDueDate for reminder", reminder.id, reminder.nextDueDate);
                     nextDueString = 'Fecha Inválida';
                }
             } else if (reminder.completed) {
                 nextDueString = 'Completado';
                  rowClass = 'opacity-50'; // Atenuar completados
             }

             // Formatear fecha de creación
             let createdDateString = 'N/A';
              if (reminder.createdAt) {
                  try {
                      createdDateString = new Date(reminder.createdAt).toLocaleDateString('es-ES', {
                          year: '2-digit', month: '2-digit', day: '2-digit'
                      });
                  } catch(e) {}
              }


            const repeatText = {
                none: 'Nunca', daily: 'Diario', weekly: 'Semanal', monthly: 'Mensual', yearly: 'Anual',
                interval: `Cada ${reminder.interval || 1} ${reminder.intervalUnit || 'días'}`
            }[reminder.repeat || 'none'];

            return `
                <tr data-reminder-id="${reminder.id}" class="${rowClass}">
                    <td class="actions-column">
                        <button class="modify" data-action="modify" title="Editar">&#9998;</button> <button class="delete" data-action="delete" title="Eliminar">&#10006;</button> ${nextDueDateObject && nextDueDateObject > now ? `<button class="postpone" data-action="postpone" title="Posponer 1h">&#9200;</button>` : ''} </td>
                    <td class="text-column" title="${reminder.text}">${reminder.text}</td>
                    <td class="date-column">${nextDueString}</td>
                    <td>${repeatText}</td>
                    <td class="date-column">${createdDateString}</td>
                </tr>
            `;
        }

        // --- Utilidades ---
        function generateUUID() { // Generador simple de UUIDs
            return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
                (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
            );
        }

         // --- Avisos (Notices) ---
         function setupNoticeControls() {
             noticeToggleIcon.addEventListener('click', toggleNotices);
             // Establecer estado inicial del icono
             noticeToggleIcon.classList.toggle('off', !noticesEnabled);
              noticesContainer.style.display = noticesEnabled ? 'flex' : 'none';
         }

         function toggleNotices() {
             noticesEnabled = !noticesEnabled;
             localStorage.setItem('noticesEnabled', noticesEnabled);
             noticeToggleIcon.classList.toggle('off', !noticesEnabled);
             noticesContainer.style.display = noticesEnabled ? 'flex' : 'none';
             if (noticesEnabled) {
                 startNoticeCycling();
             } else {
                 stopNoticeCycling();
                 currentNoticeElement.style.opacity = 0; // Ocultar aviso actual
             }
         }

         async function loadNotices() {
              noticesEnabled = localStorage.getItem('noticesEnabled') !== 'false'; // Default a true
              setupNoticeControls(); // Actualizar icono y visibilidad inicial

             if (!noticesEnabled) return; // No cargar si están desactivados

             try {
                 // --- CUIDADO: Política CORS ---
                 // Si tu archivo JSON está en un dominio diferente (incluso un subdominio como github.io)
                 // necesitarás que el servidor que aloja el JSON envíe la cabecera:
                 // Access-Control-Allow-Origin: * (o tu dominio específico)
                 // GitHub Pages SÍ permite esto para archivos públicos.
                 // Si está en el mismo dominio, no hay problema.
                 const response = await fetch(noticesURL, { cache: "no-store" }); // Evitar caché
                 if (!response.ok) {
                     throw new Error(`HTTP error! status: ${response.status}`);
                 }
                 notices = await response.json(); // Asume que es un array de strings o objetos {text: "..."}

                 if (notices && notices.length > 0) {
                     startNoticeCycling();
                 } else {
                     currentNoticeElement.textContent = "No hay avisos.";
                     currentNoticeElement.style.opacity = 1;
                 }
             } catch (error) {
                 console.error("Error cargando avisos:", error);
                 currentNoticeElement.textContent = "Error al cargar avisos.";
                 currentNoticeElement.style.opacity = 1;
                 currentNoticeElement.style.color = 'red'; // Indicar error
             }
         }

         function startNoticeCycling() {
             stopNoticeCycling(); // Limpiar intervalo anterior
             if (!noticesEnabled || notices.length === 0) return;

             cycleNotice(); // Mostrar el primero inmediatamente
             noticeIntervalId = setInterval(cycleNotice, 14000); // Ciclar cada 14 segundos (duración animación)
         }

         function stopNoticeCycling() {
             if (noticeIntervalId) clearInterval(noticeIntervalId);
             noticeIntervalId = null;
         }

         function cycleNotice() {
              if (!noticesEnabled || notices.length === 0) {
                 currentNoticeElement.style.opacity = 0; // Ocultar si no hay nada que mostrar
                 return;
              }
             currentNoticeIndex = (currentNoticeIndex + 1) % notices.length;
             const noticeToShow = notices[currentNoticeIndex];
             // Si el aviso es un objeto, extraer la propiedad 'text' o similar
             currentNoticeElement.textContent = typeof noticeToShow === 'object' ? noticeToShow.text : noticeToShow;

             // Reiniciar animación forzando reflow (quitando y añadiendo la clase)
             currentNoticeElement.style.animation = 'none';
             //offsetHeight forza el reflow
             void currentNoticeElement.offsetHeight;
             currentNoticeElement.style.animation = ''; // Volver a aplicar animación definida en CSS
              currentNoticeElement.style.opacity = 0; // Empezar invisible para que fadeIn funcione
               // Forzar inicio de animación fadeInOut
               requestAnimationFrame(() => {
                   currentNoticeElement.style.animation = 'fadeInOut 14s infinite';
               });
         }

         // --- Speech Recognition Control ---
          function startRecognition() {
              if (!recognition || isRecognizing) return;
              try {
                  recognition.start();
                  isRecognizing = true;
                  if (speechButton) speechButton.classList.add('active'); // Estilo activo
                  if (speechStatus) speechStatus.textContent = "Escuchando...";
                   console.log('Speech recognition started');
              } catch(e) {
                  console.error("Error starting recognition:", e);
                   if (speechStatus) speechStatus.textContent = "Error al iniciar dictado.";
                   isRecognizing = false;
                    if (speechButton) speechButton.classList.remove('active');
              }
          }

          function stopRecognition() {
              if (!recognition || !isRecognizing) return;
              recognition.stop();
              isRecognizing = false;
              if (speechButton) speechButton.classList.remove('active'); // Quitar estilo activo
              if (speechStatus) speechStatus.textContent = ""; // Limpiar estado
               console.log('Speech recognition stopped');
          }


        // === FIN JavaScript ===
    </script>

</body>
</html>
