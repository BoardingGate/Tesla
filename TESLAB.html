<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BoardingGate Lanzador</title>
    <link rel="icon" href="https://boardinggate.github.io/Tesla/IMG_4157.jpeg" type="image/jpeg">
    <script src="https://cdn.tailwindcss.com"></script>

<style>
    /* --- Estilos Base y Grid --- */
    :root {
        --grid-max-width: 984px;
        --button-bar-width: 60px;
        --content-margin-left: var(--button-bar-width);
        --content-padding: 16px;
        --content-max-width: var(--grid-max-width);
        --content-effective-width: calc(100% - var(--button-bar-width) - (2 * var(--content-padding)));
    }
    body { display: flex; flex-direction: column; min-height: 100vh; background-color: #ABAB99; margin: 0; overflow-x: hidden; font-family: sans-serif; }
    body.dark-mode { background-color: #92927E; }

    main { margin: 0.5rem auto 0.5rem var(--content-margin-left); background-color: transparent; border-radius: 0.75rem; padding: var(--content-padding); min-height: 400px; transition: background-color 0.3s ease; max-width: var(--content-max-width); width: var(--content-effective-width); box-sizing: border-box; }
    #bookmark-grid { display: grid; grid-template-columns: repeat(6, minmax(120px, 1fr)); gap: 15px; background-color: transparent; border-radius: 0.75rem; position: relative; width: 100%; /* Ocupa el ancho de main */ transition: all 0.3s ease; }
    #bookmark-grid > div { height: auto; aspect-ratio: 16 / 9; transition: all 0.3s ease; border: 2px solid transparent; display: flex; align-items: stretch; justify-content: stretch; }
    #bookmark-grid > div.config-empty-cell { background-color: rgba(249, 250, 251, 0.8); border: 1px dashed #E5E7EB; border-radius: 0.5rem; }
    body.dark-mode #bookmark-grid > div.config-empty-cell { background-color: rgba(55, 65, 81, 0.6); border-color: #4B5563; filter: brightness(60%); }

    .bookmark-item { width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; border-radius: 0.5rem; transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.3s; background-color: hsla(var(--hue, 0), var(--saturation, 80%), var(--lightness, 90%), 0.64); padding: 4px; box-sizing: border-box; box-shadow: 4px 4px 8px rgba(0, 0, 0, 0.5), -4px -4px 8px rgba(255, 255, 255, 0.1); position: relative; }
    .bookmark-item:hover { transform: scale(1.05) translateY(-1px); box-shadow: 6px 6px 12px rgba(0, 0, 0, 0.6), -6px -6px 12px rgba(255, 255, 255, 0.15); }
    .bookmark-item img { width: 36px; height: 36px; max-width: 40px; max-height: 40px; object-fit: contain; border-radius: 0.25rem; margin-bottom: 4px; image-rendering: crisp-edges; -ms-interpolation-mode: nearest-neighbor; }
    .bookmark-name { font-weight: bold; color: #333; text-align: center; margin-top: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: calc(100% - 8px); font-size: clamp(0.85rem, 1.5vw, 1.15rem); }
    body.dark-mode .bookmark-item { filter: brightness(60%); }
    body.dark-mode .bookmark-name { color: #EAEAEA; } /* Mejorar contraste texto dark */

    .small-bookmark img { width: 24px; height: 24px; max-width: 28px; max-height: 28px; }
    /* Responsive Grid */
    @media (max-width: 768px) { #bookmark-grid { grid-template-columns: repeat(3, minmax(100px, 1fr)); gap: 10px; } }
    @media (max-width: 480px) { #bookmark-grid { grid-template-columns: repeat(2, minmax(80px, 1fr)); gap: 8px; } }
    /* Asegurar márgenes responsivos */
    @media (max-width: 984px + 60px) { /* Cuando el viewport es más estrecho que el grid + botones */
      main, footer, .top-text-container, .notices-icon-container, .counter-wrapper {
        margin-left: var(--content-margin-left);
        width: calc(100vw - var(--content-margin-left) - var(--content-padding) * 2); /* Ajustar a viewport */
        max-width: none; /* Anular max-width fijo */
      }
      #bookmark-grid { max-width: none; }
    }

    /* --- Header, Footer, Avisos, Contador --- */
    .header-container { display: flex; align-items: center; justify-content: center; gap: 0.5rem; background-color: #ABAB99; padding: 0.5rem; }
    body.dark-mode .header-container { background-color: #92927E; }
    .header-logo { width: 100px; height: 70px; transition: filter 0.2s ease; }
    body.dark-mode .header-logo { filter: brightness(85%); }
    .title-container { background-color: #ABAB99; padding: 0.5rem 1rem; border-radius: 0.5rem; display: inline-block; }
    body.dark-mode .title-container { background-color: #92927E; }
    .header-container h1 { color: #5C5C47; }
    .version-text { font-size: 0.75rem; color: #5C5C47; font-weight: normal; }
    footer { margin: 0.5rem auto; text-align: center; display: block; background-color: #ABAB99; margin-left: var(--content-margin-left); max-width: var(--content-max-width); width: var(--content-effective-width); box-sizing: border-box; }
    body.dark-mode footer { background-color: #92927E; }
    .footer-content { color: #5C5C47; padding: 0.5rem; margin: 0 auto; max-width: 100%; position: relative; }
    .footer-subtext { font-size: 0.75rem; color: #5C5C47; margin-top: 0.25rem; text-align: center; }
    .footer-link-green { color: #5C5C47; text-decoration: none; transition: color 0.2s ease; }
    .notices-icon-container { display: flex; align-items: center; justify-content: center; margin: 0 auto; margin-left: var(--content-margin-left); position: relative; max-width: var(--content-max-width); width: var(--content-effective-width); box-sizing: border-box; }
    .notices-container { flex-grow: 1; padding: 0.5rem; border: none; border-radius: 0.5rem; overflow: hidden; display: flex; align-items: center; justify-content: center; gap: 0; height: 3rem; margin-left: 10px; }
    .notice-wrapper { padding: 0.5rem; height: 1.5rem; flex-grow: 1; overflow: hidden; position: relative; display: flex; align-items: center; justify-content: center; }
    .notice { color: #00ff00; font-weight: bold; white-space: nowrap; text-align: center; opacity: 0; animation: fadeInOut 14s infinite; }
    @keyframes fadeInOut { 0% { opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { opacity: 0; } }
    .notice-off-icon { width: auto; height: clamp(2rem, 5vw, 3rem); align-self: center; cursor: pointer; transition: filter 0.3s ease; flex-shrink: 0; }
    body.dark-mode .notice-off-icon { filter: brightness(85%); }
    .counter-wrapper { margin: 0.5rem auto 0 var(--content-margin-left); text-align: center; display: block; opacity: 0.5; max-width: var(--content-max-width); width: var(--content-effective-width); box-sizing: border-box; }
    .counter-container { display: flex; justify-content: center; align-items: center; flex-direction: column; margin-top: 1rem; text-align: center; }
    .top-text-container { display: flex; align-items: center; justify-content: center; font-size: clamp(0.6rem, 1.5vw, 0.75rem); color: #5C5C47; background-color: #D1D5DB; margin: 0.25rem auto 0 var(--content-margin-left); gap: 0.5rem; padding: 0.25rem 0.5rem; border-radius: 0.25rem; animation: fadeOut 6s forwards; max-width: var(--content-max-width); width: var(--content-effective-width); box-sizing: border-box; }
    body.dark-mode .top-text-container { background-color: #6B7280; }
    .top-text-container span { color: #D9A066; font-size: clamp(0.9rem, 2vw, 1.2rem); }
    @keyframes fadeOut { 0% { opacity: 1; } 80% { opacity: 1; } 100% { opacity: 0; display: none; } }
    .arrow-button { width: clamp(36px, 6vw, 48px); height: clamp(36px, 6vw, 48px); background-color: #D9A066; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3); transition: background-color 0.2s ease; }
    .arrow-button:hover { background-color: #5C5C47; }
    .arrow-button svg { stroke: #E6E6DC; }
    .favicon-red { filter: hue-rotate(0deg) saturate(200%) brightness(80%); }
    .favicon-blue { filter: hue-rotate(200deg) saturate(150%) brightness(90%); }

    /* --- Botones Laterales --- */
    .side-button { /* Clase común para todos los botones laterales */ position: fixed; width: 91px; height: 54px; border-radius: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 1000; transition: background-color 0.2s ease, filter 0.2s ease, opacity 0.3s, visibility 0.3s, top 0.3s ease-out; left: 10px; box-sizing: border-box; overflow: hidden; background-color: #668B8B; /* Default BG */ color: #E6E6DC; /* Default Text Color */ box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3); }
    .side-button:hover { background-color: #D9A066 !important; /* Hover siempre naranja, usa important */ }
    .side-button img { max-width: calc(100% - 10px); max-height: calc(100% - 10px); object-fit: contain; }
    .side-button.toggle-sign { font-weight: bold; font-size: 1.25rem; text-align: center; }
    .side-button.toggle-sign .sign { font-size: 1.5rem; margin-right: 3px; min-width: 12px; display: inline-block; text-align: center; }
    .side-button.toggle-image { background-color: transparent !important; /* Imagen no tiene fondo */ box-shadow: none; /* Imagen no tiene sombra */ }
    .side-button.toggle-image img { width: 100%; height: 100%; object-fit: cover; /* O contain */ border-radius: 20px; } /* Imagen ocupa todo */
    .side-button#scroll-toggle { height: clamp(78.2px, 19.55vw, 175.95px); flex-direction: column; justify-content: space-between; padding: clamp(10px, 2vw, 20px); border-radius: 60px; }
    .side-button#scroll-toggle svg { width: clamp(24px, 4vw, 32px); height: clamp(24px, 4vw, 32px); stroke: #E6E6DC; }
    #reminder-button { position: relative; /* Para posicionar contador */ }
    #reminder-button .reminder-count { position: absolute; top: 4px; left: 4px; font-size: 0.65rem; color: #FFFFFF; background-color: #EF4444; border-radius: 50%; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-weight: bold; box-shadow: 0 0 3px rgba(0,0,0,0.5); }

    /* Colores Específicos Botones (Light Mode) */
    body:not(.dark-mode) .toggle-sign.range-toggle[data-state="visible"] { background-color: #006400; }
    body:not(.dark-mode) .toggle-sign.range-toggle[data-state="hidden"] { background-color: #696969; }
    body:not(.dark-mode) #reload-button { background-color: #5DA8D6; }
    body:not(.dark-mode) #home-button { background-color: #5DA8D6; }
    body:not(.dark-mode) #weather-button { background-color: #FBBF24; }
    body:not(.dark-mode) #zoom-button { background-color: #F97316; }
    body:not(.dark-mode) #zoom-button.zoomed { background-color: #C2410C; }
    body:not(.dark-mode) #reminder-button { background-color: #4DA7A7; }
    body:not(.dark-mode) #config-button { background-color: #ABAB99; }
    body:not(.dark-mode) #scroll-toggle { background-color: #668B8B; }

    /* Colores Específicos Botones (Dark Mode) */
    body.dark-mode .side-button { background-color: #5C5C47; /* Default Dark BG */ }
    body.dark-mode .toggle-sign.range-toggle[data-state="visible"] { background-color: #166534; }
    body.dark-mode .toggle-sign.range-toggle[data-state="hidden"] { background-color: #4B5563; }
    body.dark-mode #reload-button { background-color: #0e7490; }
    body.dark-mode #home-button { background-color: #0e7490; }
    body.dark-mode #weather-button { background-color: #b45309; }
    body.dark-mode #zoom-button { background-color: #c2410c; }
    body.dark-mode #zoom-button.zoomed { background-color: #7c2d12; }
    body.dark-mode #reminder-button { background-color: #4DA7A7; }
    body.dark-mode #config-button { background-color: #92927E; }
    body.dark-mode #scroll-toggle { background-color: #5C5C47; }
    body.dark-mode .toggle-image#on-off-toggle { filter: brightness(85%); }
    body.dark-mode .toggle-sign#config-button img { filter: brightness(85%); }

    /* --- Clase Hidden y Footer Hidden --- */
    .hidden { /* Controlado por JS, sin !important */ display: none; visibility: hidden; opacity: 0; pointer-events: none; transition: opacity 0.3s, visibility 0.3s; }
    .footer-hidden { display: none !important; } /* Ocultar elementos específicos del footer */

    /* --- Minimal Mode --- */
    /* La clase .minimal-mode en body activa estas reglas */
    .minimal-mode main,
    .minimal-mode footer,
    .minimal-mode .notices-icon-container,
    .minimal-mode .counter-wrapper,
    .minimal-mode .top-text-container,
    .minimal-mode #scroll-toggle,
    .minimal-mode .range-toggle,
    .minimal-mode #weather-button,
    .minimal-mode #reminder-button,
    .minimal-mode #zoom-button,
    .minimal-mode #dark-mode-toggle,
    .minimal-mode #reload-button,
    .minimal-mode #home-button,
    .minimal-mode #reminder-notifications {
        display: none; /* No necesita !important si se aplica después */
        visibility: hidden;
        opacity: 0;
    }
    .minimal-mode #on-off-toggle { /* Excepción: On/Off sí se ve pero tenue */
        display: block; /* Asegurar display */
        visibility: visible;
        opacity: 0.3;
        filter: none;
    }
    .minimal-mode #config-button { /* Excepción: Config sí se ve */
        display: flex; /* Asegurar display */
        visibility: visible;
        opacity: 1;
    }
    .minimal-mode-message { color: #000000; font-size: 1rem; font-weight: bold; position: fixed; top: 70px; left: 10px; z-index: 1100; background: rgba(255, 255, 255, 0.7); padding: 5px; border-radius: 5px; }
    body.dark-mode .minimal-mode-message { color: #FFFFFF; background: rgba(0, 0, 0, 0.7); }

    /* --- Recordatorios y Configuración (Modales) --- */
    /* Estilos de Modales (sin cambios significativos, ya incluyen .dark-mode) */
    .reminder-modal, .config-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: #F3F4F6; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); z-index: 2000; max-width: 400px; width: 90%; color: #111827; }
    .reminder-modal.dark-mode, .config-modal.dark-mode { background-color: #4B5563; color: #F3F4F6; }
    /* ... (resto de estilos de modal y notificaciones como antes) ... */
    .reminder-modal h2, .config-modal h2 { font-size: 1.25rem; font-weight: bold; margin-bottom: 1rem; }
    .reminder-modal label, .config-modal label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
    .reminder-modal input, .reminder-modal textarea, .config-modal input, .config-modal textarea { width: 100%; padding: 0.5rem; margin-bottom: 1rem; border: 1px solid #D1D5DB; border-radius: 0.25rem; background-color: #FFFFFF; color: #111827; box-sizing: border-box; }
    .reminder-modal.dark-mode input, .reminder-modal.dark-mode textarea, .config-modal.dark-mode input, .config-modal.dark-mode textarea { background-color: #6B7280; color: #F3F4F6; border-color: #9CA3AF; }
    .reminder-modal .button-group, .config-modal .button-group { display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1.5rem; }
    .reminder-modal button, .config-modal button { padding: 0.5rem 1rem; border-radius: 0.25rem; cursor: pointer; border: none; }
    .reminder-modal button[type="submit"], .config-modal button[type="submit"] { background-color: #2563EB; color: #FFFFFF; }
    .reminder-modal.dark-mode button[type="submit"], .config-modal.dark-mode button[type="submit"] { background-color: #3B82F6; }
    .reminder-modal button[type="button"], .config-modal button[type="button"] { background-color: #D1D5DB; color: #111827; }
    .reminder-modal.dark-mode button[type="button"], .config-modal.dark-mode button[type="button"] { background-color: #4B5563; color: #F3F4F6; }
    .reminder-modal button.delete-reminder { background-color: #EF4444; color: #FFFFFF; margin-left: 0.5rem; padding: 0.25rem 0.5rem; font-size:0.8rem; }
    .reminder-modal.dark-mode button.delete-reminder { background-color: #DC2626; }
    .reminder-modal button.modify-reminder { background-color: #10B981; color: #FFFFFF; margin-left: 0.5rem; padding: 0.25rem 0.5rem; font-size:0.8rem; }
    .reminder-modal.dark-mode button.modify-reminder { background-color: #059669; }
    /* Config Modal Specific buttons */
    .config-modal .config-toggle-button { background-color: #668B8B; color: #E6E6DC; padding: 0.75rem 1.25rem; font-size: 1rem; margin: 0.5rem; }
    .config-modal.dark-mode .config-toggle-button { background-color: #5C5C47; }
    .config-modal .cancel-button { background-color: #EF4444; }
    .config-modal.dark-mode .cancel-button { background-color: #B91C1C; }
    .config-modal .save-button { background-color: #10B981; }
    .config-modal.dark-mode .save-button { background-color: #059669; }

    #reminder-notifications { position: fixed; top: 10px; right: 10px; z-index: 1500; max-width: 300px; width: 90%; }
    .reminder-notification { background-color: #FFFF99; padding: 1rem; margin-bottom: 0.5rem; border-radius: 0.25rem; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); display: flex; flex-direction: column; gap: 0.5rem; color: #333; }
    .reminder-notification.dark-mode { background-color: #FDE047; color: #1F2937; }
    .reminder-notification p { margin: 0; font-size: 1rem; color: #1E40AF; }
    .reminder-notification.dark-mode p { color: #172554; }
    .reminder-notification .button-group { display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 0.5rem; }
    .reminder-notification button { padding: 0.25rem 0.5rem; border-radius: 0.25rem; cursor: pointer; font-size: 0.8rem; border: none; color: #FFFFFF; }
    .reminder-notification button.cancel { background-color: #EF4444; }
    .reminder-notification button.modify { background-color: #10B981; }
    .reminder-notification button.postpone { background-color: #F59E0B; }
    .reminder-notification.dark-mode button.cancel { background-color: #DC2626; }
    .reminder-notification.dark-mode button.modify { background-color: #059669; }
    .reminder-notification.dark-mode button.postpone { background-color: #D97706; }

    /* --- Modo Configuración --- */
    .config-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); z-index: 2500; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; color: white; }
    /* Grid en Modo Selección */
    body.selecting-items-mode #bookmark-grid { border: 3px dashed #D9A066 !important; background-color: rgba(217, 160, 102, 0.1); position: relative; z-index: 1; }
    body.selecting-items-mode #bookmark-grid > div { cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.3s ease, border-color 0.2s ease; opacity: 0.6; border-width: 2px; border-style: solid; border-color: transparent; }
    body.dark-mode.selecting-items-mode #bookmark-grid > div { opacity: 0.5; }
    body.selecting-items-mode #bookmark-grid > div:not(.config-empty-cell):hover { transform: scale(1.05); opacity: 0.8; }
    body.dark-mode.selecting-items-mode #bookmark-grid > div:not(.config-empty-cell):hover { opacity: 0.7; }
    body.selecting-items-mode #bookmark-grid > div.config-selected { opacity: 1 !important; border-color: #2563EB !important; box-shadow: 0 0 10px rgba(37, 99, 235, 0.7); transform: scale(1.02); }
    body.dark-mode.selecting-items-mode #bookmark-grid > div.config-selected { border-color: #60A5FA !important; box-shadow: 0 0 10px rgba(96, 165, 250, 0.7); }
    body.selecting-items-mode #bookmark-grid > div.config-empty-cell { opacity: 0.2 !important; cursor: not-allowed; background-color: rgba(128, 128, 128, 0.3) !important; }
    body.dark-mode.selecting-items-mode #bookmark-grid > div.config-empty-cell { background-color: rgba(0, 0, 0, 0.3) !important; }
    /* Ocultar botones en Modo Config */
    body.config-mode .side-button:not(#config-button):not(#dark-mode-toggle) { display: none; visibility: hidden; }
    body.config-mode .top-text-container, body.config-mode #reminder-notifications { display: none; visibility: hidden; }
    body.config-mode #dark-mode-toggle { z-index: 2600; /* Asegura que esté sobre overlay */ }

</style>
</head>
<body class="min-h-screen bg-[#ABAB99] flex flex-col items-center p-6">
    <!-- Contenedor de Texto Superior -->
    <div class="top-text-container">
        <div class="arrow-button" id="back-button">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
        </div>
        <span>[ Web anterior o posterior arrastre hacia los bordes ]</span>
        <div class="arrow-button" id="forward-button">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
        </div>
    </div>

    <!-- Contenido Principal -->
    <main>
        <div id="bookmark-grid">
            <!-- Grid se rellena con JS -->
            <!-- Ejemplo de celda mientras carga: -->
             <!-- <div class="bg-gray-200 animate-pulse rounded-lg"></div> -->
        </div>
    </main>

     <!-- Avisos y Footer -->
    <div class="notices-icon-container">
        <img src="https://boardinggate.github.io/Tesla/IMG_4194.jpg" alt="Toggle Avisos" class="notice-off-icon" id="notice-toggle-icon">
        <div class="notices-container">
            <div class="notice-wrapper">
                <span class="notice" id="current-notice">Cargando avisos...</span>
            </div>
        </div>
    </div>

    <footer>
        <div class="footer-content">
            <div class="header-container">
                <img src="https://boardinggate.github.io/Tesla/LOGOTESLA.jpg" class="header-logo">
                <div class="title-container">
                    <h1 class="text-2xl font-bold inline">
                        <span class="text-2xl">BoardingGate</span>
                        <span class="text-base">Lanzador</span>
                        <span id="version" class="version-text"></span>
                    </h1>
                </div>
            </div>
            <div class="footer-line">
                <a href="https://x.com/boardinggate?s=21" class="footer-link-green" target="_blank" rel="noopener noreferrer">@BoardingGate</a>
                <span class="text-green-200" style="font-size: 1.5rem;">🤝</span>
                <a href="https://x.com/boardinggate/status/1857325553742721116?s=46" class="footer-link-green" target="_blank" rel="noopener noreferrer">Ahorremos un dinero con mis REFERIDOS</a>
            </div>
            <p class="footer-subtext">La inteligencia tiene ciertas limitations. La locura, casi ninguna 🫶 🤟</p>
        </div>
    </footer>

    <!-- Contador -->
    <div class="counter-wrapper">
        <div class="counter-container">
            <div id="sfcg896pbr68y2dejczgbn1ys664xjxdf2d"></div>
            <script type="text/javascript" src="https://counter4.optistats.ovh/private/counter.js?c=g896pbr68y2dejczgbn1ys664xjxdf2d&down=async" async></script>
        </div>
    </div>

     <!-- Botón Scroll -->
    <div id="scroll-toggle" class="side-button" title="Ir al inicio o fin">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19V5M5 12l7-7 7 7"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14M19 12l-7 7-7-7"/></svg>
    </div>
    <!-- Resto de botones laterales se crean con JS -->

    <!-- Notificaciones Recordatorios -->
    <div id="reminder-notifications"></div>

    <!-- Script Principal -->
    <script>
        // --- Constantes y Variables Globales ---
        const bookmarks = [
             { name: "YouTube", url: "https://www.youtube.com" }, //0
            { name: "Google", url: "https://www.google.com" }, //1
            { name: "GDrive", url: "https://drive.google.com", favicon: "./IMG_4172.png" }, //2
            { name: "GMail", url: "https://mail.google.com/mail/mu/mp/603/#tl/Recibidos", favicon: "./IMG_4171.png"}, //3
            { name: "Google Fotos", url: "https://photos.google.com" }, //4
            { name: "iCloud", url: "https://www.icloud.com/", favicon: "https://www.google.com/s2/favicons?domain=icloud.com&sz=64" }, //5
            { name: "ABRP", url: "https://abetterrouteplanner.com" }, //6
            { name: "ElectroMaps", url: "https://map.electromaps.com/es/", favicon: "https://www.google.com/s2/favicons?domain=electromaps.com&sz=64" }, //7
            { name: "REVE PdR España", url: "https://www.mapareve.es/mapa-puntos-recarga", favicon: "https://www.google.com/s2/favicons?domain=mapareve.es&sz=64" }, //8
            { name: "PdR,s", url: "https://www.google.com/maps/search/puntos+recarga+veh%C3%ADculos+el%C3%A9ctricos", favicon: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M12 18h8v2h-8v-2z'/><path d='M12 14h8v2h-8v-2z'/><path d='M12 10h8v2h-8v-2z'/><path d='M12 6h8v2h-8V6z'/><path d='M4 18h4v-2H4v2zM4 14h4v-2H4v2zM4 10h4v-2H4v2zM4 6h4V4H4v2z'/></svg>" }, //9
            { name: "Google Maps", url: "https://maps.google.com" }, //10
            { name: "", url: "https://www.ventusky.com/?p=40.2;-4.7;5&l=rain-3h" }, // 11: Ventusky (sin nombre)
            { name: "TESSIE", url: "https://dash.tessie.com/signin", favicon: "https://www.google.com/s2/favicons?domain=tessie.com&sz=64" }, //12
            { name: "Mis Updates", url: "https://dash.tessie.com/software", favicon: "https://cdn-icons-png.flaticon.com/512/148/148767.png" }, //13
            { name: "Olas Updates", url: "https://es.stats.tessie.com/", favicon: "https://cdn-icons-png.flaticon.com/512/5815/5815902.png" }, //14
            { name: "NotaTeslaApp", url: "https://www.notateslaapp.com/software-updates/" }, //15
            { name: "ENHAUTO", url: "https://www.enhauto.com" }, //16
            { name: "MAREAS", url: "https://www.meteogalicia.gal/web/predicion/mareas-e-luas" }, //17
            // --- Grupo PdR,s (18-29) ---
            { name: "ELECTROVERSE", url: "https://electroverse.com/es/map", favicon: "https://www.google.com/s2/favicons?domain=electroverse.com&sz=64" }, // 18
            { name: "ACCIONA", url: "https://www.google.com/maps/search/recarga+Acciona", favicon: "https://www.google.com/s2/favicons?domain=acciona.com&sz=64" }, //19
            { name: "IBERDROLA", url: "https://www.google.com/maps/search/recarga+IBERDROLA", favicon: "https://www.google.com/s2/favicons?domain=iberdrola.com&sz=64" }, //20
            { name: "WAYLET Repsol", url: "https://www.google.com/maps/search/recarga+REPSOL+Waylet", favicon: "https://www.google.com/s2/favicons?domain=repsol.com&sz=64" }, //21
            { name: "ENDESA xWay", url: "https://www.google.com/maps/search/recarga+ENDESA+XWAY", favicon: "https://www.google.com/s2/favicons?domain=endesa.com&sz=64" }, //22
            { name: "ZUNDER", url: "https://www.google.com/maps/search/recarga+ZUNDER", favicon: "https://www.google.com/s2/favicons?domain=zunder.com&sz=64" }, //23
            { name: "IONITY", url: "https://www.google.com/maps/search/recarga+IONITY", favicon: "https://www.google.com/s2/favicons?domain=ionity.eu&sz=64" }, //24
            { name: "WENEA", url: "https://www.google.com/maps/search/recarga+WENEA", favicon: "https://www.google.com/s2/favicons?domain=wenea.com&sz=64" }, //25
            { name: "T.ENERGIES", url: "https://www.google.com/maps/search/recarga+TOTAL+ENERGIES", favicon: "https://www.google.com/s2/favicons?domain=totalenergies.com&sz=64" }, //26
            { name: "GALP", url: "https://www.google.com/maps/search/recarga+GALP", favicon: "https://www.google.com/s2/favicons?domain=galp.com&sz=64" }, //27
            { name: "MIIO", url: "https://miio.com", favicon: "https://www.google.com/s2/favicons?domain=miio.com&sz=64" }, //28
            { name: "EVDC", url: "https://evdc.network", favicon: "https://www.google.com/s2/favicons?domain=evdc.network&sz=64" }, // 29
            // --- Grupo iAs (30-41) ---
            { name: "GROK", url: "https://grok.com/?referrer=website" }, // 30
            { name: "CHATGPT", url: "https://chat.openai.com" }, //31
            { name: "CLAUDE", url: "https://claude.ai/new" }, //32
            { name: "GEMINI", url: "https://gemini.google.com" }, //33
            { name: "NOTEBOOKLM", url: "https://notebooklm.google.com" }, // 34
             null, null, null, null, null, null, null, // 35-41
            // --- Grupo Útil (42-59) ---
            { name: "Batería", url: "https://docs.google.com/spreadsheets/d/1bLZmgVGTBqg2bS2E45JpORjs9eK2nb05AWXYLLDY-RI/edit?gid=1398548891#gid=1398548891", favicon: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><circle cx='12' cy='12' r='10'/><polyline points='12 6 12 12 16 14'/></svg>" }, // 42
            { name: "TeslaParaTodos", url: "https://teslaparatodos.com/cine/" }, //43
            { name: "BetterTheater", url: "https://abettertheater.com", favicon: "https://www.google.com/s2/favicons?domain=abettertheater.com&sz=64" }, //44
            { name: "Filmin", url: "https://www.filmin.es/catalogo/peliculas" }, //45
            { name: "Octopus", url: "https://octopus.energy/dashboard" }, //46
            { name: "App MCE", url: "https://www.oscarabilleira.com/app-mi-coche-electrico/#ayuda" }, //47
            { name: "Patrón Luz", url: "https://docs.google.com/spreadsheets/d/1R7UUZ9i4BAYWAGAX6PQT1WGd12GEZ4Ja/edit?usp=sharing&ouid=108345701896498198132&rtpof=true&sd=true" }, //48
            { name: "TradingView", url: "https://es.tradingview.com/chart/t5g9UFG0/" }, //49
            { name: "Inicio Tesla" }, // 50: Placeholder, sin URL
            { name: "Twitter", url: "https://x.com" }, //51
            { name: "Maesal Detailer", url: "https://www.maesaldetailer.es/" }, //52
            { name: "Superchargers", url: "https://www.tesla.com/es_es/findus?bounds=45.41107111786193%2C19.27853056943938%2C29.703668286784747%2C-16.64676239931062" }, //53
            { name: "TESLA web", url: "https://www.tesla.com/es_es" }, //54
            { name: "Manual M3", url: "https://www.tesla.com/ownersmanual/model3/es_es/" }, //55
            { name: "de Servicio", url: "https://service.tesla.com/docs/Model3/ServiceManual/2024/es-es/" }, //56
            { name: "de Despiece", url: "https://epc.tesla.com/es-MX/catalogs/e0e07c3d-272f-4d06-b8b6-9e92f857e5f3" }, //57
            { name: "de Usted Mismo", url: "https://www.tesla.com/es_es/support/do-it-yourself-guides" }, //58
            { name: "de Filtro Cabina", url: "https://service.tesla.com/docs/Public/diy/model3/es_es/GUID-DB0A1E3C-926E-498C-A2FD-A27B8421A471.html" }, // 59
            // --- Grupo Varios (60-95) ---
            { name: "de Móvil remoto", url: "https://service.tesla.com/docs/Public/diy/model3/es_es/GUID-53651B16-A2E3-4118-933E-B5F41C74D433.html" }, // 60
            { name: "Waze (consultas)", url: "https://www.waze.com/es/live-map/", favicon: "https://www.google.com/s2/favicons?domain=waze.com&sz=64" }, //61
            { name: "AMAZON", url: "https://www.amazon.es" }, //62
            { name: "BIP&DRIVE", url: "https://areaprivada.bipdrive.com/login" }, //63
            { name: "ITV Cita", url: "https://www.sycitv.com/es/cita-previa-particulares/", favicon: "https://boardinggate.github.io/Tesla/itv.png" }, //64
            null, null, // 65, 66
            { name: "Jaime Odena", url: "https://www.youtube.com/@JOdena", favicon: "https://www.youtube.com/favicon.ico" }, //67
            { name: "Eduardo Arcos", url: "https://www.youtube.com/@earcos", favicon: "https://www.youtube.com/favicon.ico" }, //68
            { name: "AutoIngenium", url: "https://www.youtube.com/@AutoIngenium", favicon: "https://www.youtube.com/favicon.ico" }, //69
            { name: "Gallego en Munich", url: "https://www.youtube.com/@ungallegoenmunich", favicon: "https://www.youtube.com/favicon.ico" }, //70
            { name: "Electromiaumiau", url: "https://www.youtube.com/@electromiaumiau", favicon: "https://www.youtube.com/favicon.ico" }, //71
            { name: "Manuel Martos", url: "https://www.youtube.com/@Manuel_Martos", favicon: "https://www.youtube.com/favicon.ico" }, //72
            { name: "Todos Electricos", url: "https://www.youtube.com/@TodosElectricos", favicon: "https://www.youtube.com/favicon.ico" }, //73
            { name: "Juan Vidal Haces", url: "https://www.youtube.com/@JuanVidalHaces", favicon: "https://www.youtube.com/favicon.ico" }, //74
            { name: "Ruedana", url: "https://www.youtube.com/@ruedana", favicon: "https://www.youtube.com/favicon.ico" }, //75
            { name: "STR-600", url: "https://www.youtube.com/@STR-600", favicon: "https://www.youtube.com/favicon.ico" }, //76
            { name: "Juanjo T. Aventuras", url: "https://www.youtube.com/@juanjoteslaventuras", favicon: "https://www.youtube.com/favicon.ico" }, //77
            { name: "Carlos Cuezva", url: "https://www.youtube.com/@CarlosCuezva", favicon: "https://www.youtube.com/favicon.ico" }, //78
            { name: "Javi Manzanoo", url: "https://www.youtube.com/@javimanzanoo", favicon: "https://www.youtube.com/favicon.ico" }, //79
            { name: "Crifedi", url: "https://www.youtube.com/@Crifedi", favicon: "https://www.youtube.com/favicon.ico" }, //80
            { name: "Tescno Tesla", url: "https://www.youtube.com/@TecnoTesla", favicon: "https://www.youtube.com/favicon.ico" }, //81
            { name: "Full Electric Mex", url: "https://www.youtube.com/@FullElectricMexico", favicon: "https://www.youtube.com/favicon.ico" }, //82
            null, null, // 83, 84
            { name: "La iA Jon", url: "https://www.youtube.com/@la_inteligencia_artificial", favicon: "https://www.youtube.com/favicon.ico" }, //85
            { name: "JF Ccalero", url: "https://www.youtube.com/@jfcalero", favicon: "https://www.youtube.com/favicon.ico" }, //86
            { name: "Visual Politik", url: "https://www.youtube.com/@VisualPolitik", favicon: "https://www.youtube.com/favicon.ico" }, //87
            { name: "Fabian Barrio", url: "https://www.youtube.com/@fabiancbarrio", favicon: "https://www.youtube.com/favicon.ico" }, //88
            { name: "Loquetudigas", url: "https://www.youtube.com/@Loquetudigas", favicon: "https://www.youtube.com/favicon.ico" }, //89
            { name: "David Antunes", url: "https://www.youtube.com/@davidantunesmusic", favicon: "https://www.youtube.com/favicon.ico" }, //90
            { name: "TheWildProject", url: "https://www.youtube.com/@TheWildProject", favicon: "https://www.youtube.com/favicon.ico" }, //91
            { name: "Estas Tonne", url: "https://www.youtube.com/@Estastonne", favicon: "https://www.youtube.com/favicon.ico" }, //92
            { name: "BBC6 Music", url: "https://www.youtube.com/@BBC6Music", favicon: "https://www.youtube.com/favicon.ico" }, //93
            null, null // 94, 95
        ];
        const TOTAL_CELLS = 96;
        const COLS = 6;
        const grid = document.getElementById('bookmark-grid');
        let isDarkMode = false;
        let isMinimalMode = false;
        let pressStartTime = null;
        let reminderPressStartTime = null;
        let isActive = true; // Avisos
        let isFooterVisible = true; // Footer
        let notices = [];
        let currentNoticeIndex = 0;
        const cellElements = []; // Celdas del grid
        let createdToggleButtons = []; // Botones toggle filtro
        let sideButtons = []; // Todos los botones laterales dinámicos + scroll

        let customToggleConfigs = {};
        let isConfigMode = false;
        let currentConfiguringToggle = null;
        let currentConfigIndices = [];

        const toggleRanges = [
            { id: "toggle-pdr", start: 18, end: 29, defaultLabel: "PdR,s" },
            { id: "toggle-ias", start: 30, end: 41, defaultLabel: "iAs" },
            { id: "toggle-util", start: 42, end: 59, defaultLabel: "Útil" },
            { id: "toggle-varios", start: 60, end: 95, defaultLabel: "Varios" }
        ];

        // --- Funciones Auxiliares ---
        function clamp(min, val, max) { return Math.min(Math.max(val, min), max); }
        function checkDarkModeTime() { const now = new Date(); const h = now.getHours(); return (h >= 21 || h < 7); }

        // --- Carga/Guardado Ajustes ---
        function loadCustomToggleConfigs() {
            const saved = localStorage.getItem('customToggleConfigs');
            customToggleConfigs = {};
            if (saved) { try { const p = JSON.parse(saved); if(typeof p === 'object' && p !== null) customToggleConfigs = p; } catch(e) { console.error("Err load ToggleCfg", e); }}
            // console.log("Loaded Toggle Configs:", customToggleConfigs);
        }
        function saveCustomToggleConfigs() { localStorage.setItem('customToggleConfigs', JSON.stringify(customToggleConfigs)); /* console.log("Saved Toggle Configs"); */ }
        function saveSettings() {
            localStorage.setItem('darkMode', JSON.stringify(isDarkMode));
            localStorage.setItem('minimalMode', JSON.stringify(isMinimalMode));
            const tStates = {}; createdToggleButtons.forEach(t => { if(t.dataset.toggleId) tStates[t.dataset.toggleId] = t.dataset.state; }); localStorage.setItem('toggleStates', JSON.stringify(tStates));
            const zb = document.getElementById('zoom-button'); if (zb) localStorage.setItem('zoomState', zb.dataset.zoomState);
            const oot = document.getElementById('on-off-toggle'); if (oot) localStorage.setItem('onOffState', oot.dataset.state);
            localStorage.setItem('noticesActive', JSON.stringify(isActive));
            localStorage.setItem('footerVisible', JSON.stringify(isFooterVisible));
            // console.log("Settings saved.");
        }
        function loadSavedSettings() {
            console.log("Loading saved settings...");
            isDarkMode = localStorage.getItem('darkMode') === 'true' || (!localStorage.getItem('darkMode') && checkDarkModeTime()); // Default based on time only if never saved
            isMinimalMode = localStorage.getItem('minimalMode') === 'true'; // Default false
            isActive = localStorage.getItem('noticesActive') !== 'false'; // Default true
            isFooterVisible = localStorage.getItem('footerVisible') !== 'false'; // Default true

            loadCustomToggleConfigs(); // Cargar configs ANTES de aplicar estados

            if (isDarkMode) document.body.classList.add('dark-mode');

            const zoomButton = document.getElementById('zoom-button');
            if (zoomButton) { zoomButton.dataset.zoomState = localStorage.getItem('zoomState') || 'off'; applyZoom(zoomButton.dataset.zoomState); }

            const onOffToggle = document.getElementById('on-off-toggle');
            if (onOffToggle) { onOffToggle.dataset.state = localStorage.getItem('onOffState') || 'on'; }

            let toggleStates = {}; try { toggleStates = JSON.parse(localStorage.getItem('toggleStates') || '{}'); } catch(e) {}
            createdToggleButtons.forEach(toggle => {
                const id = toggle.dataset.toggleId; if (id) { toggle.dataset.state = toggleStates[id] || 'visible'; applyToggleConfiguration(id); }
            });

             // Aplicar estado minimal (que puede ocultar cosas)
            if (isMinimalMode) {
                toggleMinimalMode(true); // Llama a adjustPositions dentro
            } else {
                toggleFooterVisibility(); // Aplicar visibilidad normal footer/avisos
                adjustButtonPositions(); // Ajustar posiciones si no es minimal
            }

            loadReminders(); // Cargar recordatorios
            updateButtonStyles(); // Estilos finales botones
            console.log("Finished loading saved settings. isMinimalMode:", isMinimalMode);
        }

        // --- Modo Minimal ---
        function toggleMinimalMode(enable) {
            console.log("Toggling Minimal Mode:", enable);
            isMinimalMode = enable;
            document.body.classList.toggle('minimal-mode', enable);
            const msgId = 'minimal-mode-message'; let msg = document.getElementById(msgId);
            if (enable && !msg) {
                msg = document.createElement('div'); msg.id = msgId; msg.className = 'minimal-mode-message';
                msg.textContent = 'Pulse ON/OFF 2 seg. para reactivar'; document.body.appendChild(msg);
            } else if (!enable && msg) { msg.remove(); }
            // Forzar visibilidad footer/avisos/contador según modo
            toggleFooterVisibility(); // Esta función ahora respeta isMinimalMode
            adjustButtonPositions(); // APLICAR CAMBIOS DE VISIBILIDAD A BOTONES
            saveSettings();
        }

        // --- Zoom ---
        function applyZoom(state) { /* ... (Implementación sin cambios) ... */
            const zoomButton = document.getElementById('zoom-button');
            if (!zoomButton) return;
            const gridCells = document.querySelectorAll('#bookmark-grid > div');
            const bookmarkImages = document.querySelectorAll('.bookmark-item img');
            const bookmarkNames = document.querySelectorAll('.bookmark-name');
            const smallBookmarkImages = document.querySelectorAll('.small-bookmark img');
            const smallBookmarkNames = document.querySelectorAll('.small-bookmark .bookmark-name');
            const originalWidth = 984; const adjustedWidth = 935;
            const originalCols = 6; const zoomedCols = 4; const gap = 15;
            const zoomedCellWidthPx = (adjustedWidth - (zoomedCols - 1) * gap) / zoomedCols;

            if (state === 'on') {
                grid.style.gridTemplateColumns = `repeat(${zoomedCols}, ${zoomedCellWidthPx}px)`;
                grid.style.maxWidth = `${adjustedWidth}px`;
                gridCells.forEach(cell => { cell.style.aspectRatio = '16 / 9'; });
                bookmarkImages.forEach(img => { img.style.width = '48px'; img.style.maxWidth = '56px'; img.style.maxHeight = '56px'; });
                bookmarkNames.forEach(name => { name.style.fontSize = 'clamp(1.05rem, 1.8vw, 1.35rem)'; });
                smallBookmarkImages.forEach(img => { img.style.width = '48px'; img.style.maxWidth = '56px'; img.style.maxHeight = '56px'; });
                smallBookmarkNames.forEach(name => { name.style.fontSize = 'clamp(1.05rem, 1.8vw, 1.35rem)'; });
                zoomButton.innerHTML = `<img src="./zoon+.png" alt="Zoom In" class="max-w-[80px] max-h-[48px] object-contain">`;
                zoomButton.classList.add('zoomed');
            } else {
                grid.style.gridTemplateColumns = `repeat(${originalCols}, minmax(120px, 1fr))`;
                grid.style.maxWidth = `${originalWidth}px`;
                gridCells.forEach(cell => { cell.style.aspectRatio = '16 / 9'; });
                bookmarkImages.forEach(img => { img.style.width = '36px'; img.style.maxWidth = '40px'; img.style.maxHeight = '40px'; });
                bookmarkNames.forEach(name => { name.style.fontSize = 'clamp(0.85rem, 1.5vw, 1.15rem)'; });
                smallBookmarkImages.forEach(img => { img.style.width = '24px'; img.style.maxWidth = '28px'; img.style.maxHeight = '28px'; });
                smallBookmarkNames.forEach(name => { name.style.fontSize = 'clamp(0.85rem, 1.5vw, 1.15rem)'; });
                zoomButton.innerHTML = `<img src="./zoon-.png" alt="Zoom Out" class="max-w-[80px] max-h-[48px] object-contain">`;
                zoomButton.classList.remove('zoomed');
            }
         }

        // --- Estilos Botones y Versión ---
        function updateButtonStyles() { /* ... (Implementación sin cambios) ... */
            const darkModeToggle = document.getElementById('dark-mode-toggle');
            const onOffToggle = document.getElementById('on-off-toggle');
            const zoomButton = document.getElementById('zoom-button');
            const reminderButton = document.getElementById('reminder-button');

            if (onOffToggle) {
                onOffToggle.src = `https://boardinggate.github.io/Tesla/${onOffToggle.dataset.state === 'on' ? 'IMG_4192.jpg' : 'IMG_4191.jpg'}`;
                onOffToggle.alt = `Toggle ${onOffToggle.dataset.state === 'on' ? 'On' : 'Off'}`;
            }
            if (darkModeToggle) {
                 darkModeToggle.src = `https://boardinggate.github.io/Tesla/${isDarkMode ? 'IMG_4189.jpg' : 'IMG_4190.jpg'}`;
                darkModeToggle.alt = `Toggle ${isDarkMode ? 'Oscuro' : 'Claro'}`;
            }
            if (reminderButton) {
                const reminders = JSON.parse(localStorage.getItem('reminders') || '[]');
                const pendingCount = reminders.length;
                let countElement = reminderButton.querySelector('.reminder-count');
                if (pendingCount > 0) {
                    if (!countElement) {
                        countElement = document.createElement('span'); countElement.className = 'reminder-count'; reminderButton.appendChild(countElement);
                    }
                    countElement.textContent = pendingCount; countElement.style.display = 'flex';
                } else if (countElement) { countElement.style.display = 'none'; }
            }
            if (zoomButton) { zoomButton.classList.toggle('zoomed', zoomButton.dataset.zoomState === 'on'); }
        }
        function formatVersionDate(d) { if (!d || isNaN(d.getTime())) return "?.?.?"; const y = d.getUTCFullYear().toString().slice(-2); const m = String(d.getUTCMonth() + 1).padStart(2, '0'); const day = String(d.getUTCDate()).padStart(2, '0'); const h = String(d.getUTCHours()).padStart(2, '0'); return `${y}.${m}.${day}${h}`; }
        async function getLastModifiedDate() { /* ... (Implementación sin cambios) ... */
             const cacheKey = 'teslaHtmlLastModified'; const cacheTimestampKey = 'teslaHtmlLastModifiedTimestamp'; const cacheDuration = 3600000;
             const cachedDate = localStorage.getItem(cacheKey); const cachedTimestamp = localStorage.getItem(cacheTimestampKey); const now = Date.now();
             if (cachedDate && cachedTimestamp && now - parseInt(cachedTimestamp) < cacheDuration) { return new Date(cachedDate); }
             try {
                 const r = await fetch('https://boardinggate.github.io/Tesla/version.txt', { cache: 'no-cache', headers: { 'Cache-Control': 'no-cache', 'Pragma': 'no-cache' } }); if (!r.ok) throw new Error(`HTTP ${r.status}`);
                 const t = await r.text(); const d = new Date(t.trim()); if (isNaN(d.getTime())) throw new Error('Invalid date'); localStorage.setItem(cacheKey, d.toISOString()); localStorage.setItem(cacheTimestampKey, now.toString()); return d;
             } catch (error) { console.error('Err fetch version:', error); if (cachedDate) return new Date(cachedDate); return new Date('2024-01-01T00:00:00Z'); }
         }
        async function updateVersion() { try { const d = await getLastModifiedDate(); const v = formatVersionDate(d); const ve = document.getElementById('version'); if(ve) ve.textContent = `v${v}`; } catch (e) { console.error("Fail update version:", e); const ve = document.getElementById('version'); if(ve) ve.textContent = 'v?.?.?'; } }

        // --- Creación Grid ---
        const getFaviconUrl = (bm) => { if (bm.favicon) return bm.favicon; try { if (bm.url) { const d = new URL(bm.url).hostname; if (d && d !== 'localhost' && d.includes('.')) return `https://www.google.com/s2/favicons?domain=${d}&sz=64`; } } catch (e) {} return 'https://via.placeholder.com/64/E0E0E0/AAAAAA?text=+'; };
        function generateBrightColor() { const h = Math.floor(Math.random() * 360); const s = 50 + Math.floor(Math.random() * 25); const l = 75 + Math.floor(Math.random() * 15); return `hsla(${h}, ${s}%, ${l}%, 0.75)`; }
        function areColorsSimilar(c1, c2, t = 45) { if (!c1 || !c2) return false; try { const p = (c) => c.match(/\d+/g).map(Number); const [h1, s1, l1] = p(c1); const [h2, s2, l2] = p(c2); const hd = Math.min(Math.abs(h1 - h2), 360 - Math.abs(h1 - h2)); const sd = Math.sqrt(Math.pow(s1 - s2, 2) + Math.pow(l1 - l2, 2)); return hd < t || (hd < t * 1.5 && sd < t * 1.5); } catch (e) { return false; } }
        function createGridItems() {
            console.log("Creating grid items...");
            grid.innerHTML = ''; cellElements.length = 0; const colors = Array(TOTAL_CELLS).fill(null);
            for (let i = 0; i < TOTAL_CELLS; i++) { if (bookmarks[i]) { let c, a = 0; do { c = generateBrightColor(); a++; const tN = (i >= COLS) ? colors[i - COLS] : null; const lN = (i % COLS !== 0) ? colors[i - 1] : null; } while ((areColorsSimilar(c, tN) || areColorsSimilar(c, lN)) && a < 20); colors[i] = c; } }
            Array.from({ length: TOTAL_CELLS }).forEach((_, i) => {
                const cell = document.createElement('div'); const bm = (i < bookmarks.length) ? bookmarks[i] : null; const isEmpty = (!bm || bm.name === undefined);
                if (!isEmpty) {
                    const link = document.createElement('a'); link.className = i >= 60 ? 'bookmark-item small-bookmark' : 'bookmark-item'; link.title = bm.name || `Link ${i + 1}`;
                    if (colors[i]) { try { const [h, s, l] = colors[i].match(/\d+/g).map(Number); link.style.setProperty('--hue', h); link.style.setProperty('--saturation', `${s}%`); link.style.setProperty('--lightness', `${l}%`); } catch(e){ link.style.backgroundColor='#E0E0E0'; } } else { link.style.backgroundColor='#E0E0E0'; }
                    link.href = bm.url || "#"; if (bm.url && bm.name !== "Inicio Tesla") { link.target = "_blank"; link.rel = "noopener noreferrer"; }
                    if (bm.name !== "") { const img = document.createElement('img'); img.src = getFaviconUrl(bm); img.alt = `Favicon ${bm.name || ''}`; img.loading = "lazy"; img.onerror = (e) => { e.target.src = 'https://via.placeholder.com/64/CCCCCC/FFFFFF?text=?'; e.target.onerror = null; }; if (bm.name === "Mis Updates") img.classList.add('favicon-red'); else if (bm.name === "Olas Updates") img.classList.add('favicon-blue'); link.appendChild(img); }
                    if (bm.name !== "") { const name = document.createElement('span'); name.className = 'bookmark-name'; name.textContent = bm.name; link.appendChild(name); } else { link.classList.add('no-name'); }
                    cell.appendChild(link);
                } else { cell.classList.add('config-empty-cell'); }
                grid.appendChild(cell); cellElements.push(cell);
            });
            applyCurrentThemeToElements(); // Apply dark mode to empty cells if needed
            console.log("Grid items created.");
        }

        // --- Creación Botones Laterales ---
        function createSideButtons() {
            console.log("Creating side buttons...");
            const buttonContainer = document.body; createdToggleButtons = []; // Reset filter buttons array
            const allButtons = []; // Array for ALL dynamic buttons

            const onOffToggle = document.createElement('img');
            onOffToggle.className = 'side-button toggle-image'; onOffToggle.id = 'on-off-toggle'; onOffToggle.dataset.state = 'on';
            buttonContainer.appendChild(onOffToggle); allButtons.push(onOffToggle);
            onOffToggle.addEventListener('mousedown', () => { pressStartTime = Date.now(); }); onOffToggle.addEventListener('mouseup', handleOnOffLongPress);
            onOffToggle.addEventListener('touchstart', (e) => { e.preventDefault(); pressStartTime = Date.now(); }); onOffToggle.addEventListener('touchend', (e) => { e.preventDefault(); handleOnOffLongPress(); });

            toggleRanges.forEach((range) => {
                const toggle = document.createElement('span');
                toggle.className = 'side-button toggle-sign range-toggle'; toggle.dataset.toggleId = range.id; toggle.dataset.state = 'visible';
                buttonContainer.appendChild(toggle); allButtons.push(toggle); createdToggleButtons.push(toggle);
                toggle.addEventListener('click', () => { if (!isMinimalMode && !isConfigMode) updateToggleState(toggle); });
            });

            const weatherButton = document.createElement('span'); weatherButton.className = 'side-button toggle-sign'; weatherButton.id = 'weather-button'; weatherButton.innerHTML = `<img src="https://www.google.com/s2/favicons?domain=ventusky.com&sz=64" alt="Tiempo">`;
            buttonContainer.appendChild(weatherButton); allButtons.push(weatherButton);
            weatherButton.addEventListener('click', () => { if (!isMinimalMode && !isConfigMode) window.open('https://www.ventusky.com/?p=40.2;-4.7;5&l=rain-3h', '_blank'); });

            const reminderButton = document.createElement('span'); reminderButton.className = 'side-button toggle-sign'; reminderButton.id = 'reminder-button'; reminderButton.innerHTML = `<img src="https://boardinggate.github.io/Tesla/IMG_4197.jpg" alt="Recordatorio">`;
            buttonContainer.appendChild(reminderButton); allButtons.push(reminderButton);
            reminderButton.addEventListener('mousedown', () => { reminderPressStartTime = Date.now(); }); reminderButton.addEventListener('mouseup', handleReminderLongPress);
            reminderButton.addEventListener('touchstart', (e) => { e.preventDefault(); reminderPressStartTime = Date.now(); }); reminderButton.addEventListener('touchend', (e) => { e.preventDefault(); handleReminderLongPress(); });

            const zoomButton = document.createElement('span'); zoomButton.className = 'side-button toggle-sign'; zoomButton.id = 'zoom-button'; zoomButton.dataset.zoomState = 'off'; zoomButton.innerHTML = `<img src="./zoon-.png" alt="Zoom">`;
            buttonContainer.appendChild(zoomButton); allButtons.push(zoomButton);
            zoomButton.addEventListener('click', () => { if (!isMinimalMode && !isConfigMode) { const n = zoomButton.dataset.zoomState === 'off' ? 'on' : 'off'; zoomButton.dataset.zoomState = n; applyZoom(n); updateButtonStyles(); saveSettings(); } });

            const darkModeToggle = document.createElement('img'); darkModeToggle.className = 'side-button toggle-image'; darkModeToggle.id = 'dark-mode-toggle';
            buttonContainer.appendChild(darkModeToggle); allButtons.push(darkModeToggle);
            darkModeToggle.addEventListener('click', () => { if (!isMinimalMode) { isDarkMode = !isDarkMode; document.body.classList.toggle('dark-mode', isDarkMode); applyCurrentThemeToElements(); updateButtonStyles(); saveSettings(); } });

            const reloadButton = document.createElement('span'); reloadButton.className = 'side-button toggle-sign'; reloadButton.id = 'reload-button'; reloadButton.innerHTML = `<img src="./reload.webp" alt="Recargar">`;
            buttonContainer.appendChild(reloadButton); allButtons.push(reloadButton);
            reloadButton.addEventListener('click', () => { if (!isMinimalMode && !isConfigMode) location.reload(); });

            const homeButton = document.createElement('span'); homeButton.className = 'side-button toggle-sign'; homeButton.id = 'home-button'; homeButton.innerHTML = `<img src="./home.webp" alt="Inicio">`;
            buttonContainer.appendChild(homeButton); allButtons.push(homeButton);
            homeButton.addEventListener('click', (e) => { if (!isMinimalMode && !isConfigMode) { e.preventDefault(); window.history.back(); } });

            const configButton = document.createElement('span'); configButton.className = 'side-button toggle-sign'; configButton.id = 'config-button'; configButton.innerHTML = `<img src="https://boardinggate.github.io/Tesla/config.jpg" alt="Configuración">`;
            buttonContainer.appendChild(configButton); allButtons.push(configButton);
            configButton.addEventListener('click', () => { if (!isMinimalMode && !isConfigMode) showConfigMenu(); });

            console.log("Side buttons created in DOM.");
            return allButtons; // Devuelve solo los botones dinámicos
        }

        // --- Aplicar Tema Dark/Light ---
        function applyCurrentThemeToElements() {
            // console.log("Applying theme. Dark:", isDarkMode);
            document.querySelectorAll('#bookmark-grid > div.config-empty-cell').forEach(cell => {
                 cell.style.filter = isDarkMode ? 'brightness(60%)' : '';
                 cell.style.backgroundColor = isDarkMode ? 'rgba(55, 65, 81, 0.6)' : 'rgba(249, 250, 251, 0.8)';
                 cell.style.borderColor = isDarkMode ? '#4B5563' : '#E5E7EB';
            });
            document.querySelectorAll('.reminder-modal, .config-modal').forEach(m => m.classList.toggle('dark-mode', isDarkMode));
            document.querySelectorAll('.reminder-notification').forEach(n => n.classList.toggle('dark-mode', isDarkMode));
        }

        // --- Posicionamiento Botones ---
        function adjustButtonPositions() {
             console.log("Adjusting button positions. MinimalMode:", isMinimalMode);
             const scrollToggle = document.getElementById('scroll-toggle'); // Botón estático
             if (!scrollToggle) { console.error("Scroll toggle button not found!"); return; }

             const allSideButtons = [scrollToggle, ...sideButtons]; // Incluir el scroll toggle
             let visibleButtonCount = 0;
             let currentTop = 10;
             const buttonHeight = 54; const scrollHeight = scrollToggle.offsetHeight || 120; // Estimate scroll height
             const spacing = 4;

             allSideButtons.forEach((button) => {
                 if (!button) return; // Saltar si falta algún botón
                 const isScroll = button.id === 'scroll-toggle';
                 const isException = (button.id === 'config-button' || button.id === 'on-off-toggle');
                 const shouldBeVisible = !isMinimalMode || isException;

                 if (shouldBeVisible) {
                     button.style.top = `${currentTop}px`;
                     button.style.visibility = 'visible';
                     button.style.opacity = '1';
                     button.style.display = isScroll ? 'flex' : (button.tagName === 'IMG' ? 'block' : 'flex'); // Correct display
                     currentTop += (isScroll ? scrollHeight : buttonHeight) + spacing;
                     visibleButtonCount++;
                     // console.log(`Positioned ${button.id || 'button'} at ${button.style.top}`);
                 } else {
                     button.style.visibility = 'hidden';
                     button.style.opacity = '0';
                     button.style.display = 'none';
                     // console.log(`Hid ${button.id || 'button'}`);
                 }
             });
             console.log(`Button positions adjusted. Visible buttons: ${visibleButtonCount}`);
        }

        // --- Lógica Toggles Filtro ---
        function getDefaultIndices(rangeInfo) { /* ... (Sin cambios) ... */
            const indices = []; if (rangeInfo && typeof rangeInfo.start === 'number' && typeof rangeInfo.end === 'number') { for (let i = rangeInfo.start; i <= rangeInfo.end; i++) { if (i < cellElements.length && cellElements[i] && !cellElements[i].classList.contains('config-empty-cell')) { indices.push(i); } } } return indices;
         }
        function applyToggleConfiguration(toggleId) { /* ... (Sin cambios) ... */
            if (!toggleId) return; const toggleButton = createdToggleButtons.find(btn => btn.dataset.toggleId === toggleId); if (!toggleButton) return;
            const rangeInfo = toggleRanges.find(r => r.id === toggleId); const config = customToggleConfigs[toggleId]; let label = config?.label || rangeInfo.defaultLabel; let itemIndices = config?.itemIndices || getDefaultIndices(rangeInfo);
            toggleButton.dataset.itemIndices = itemIndices.join(','); toggleButton.dataset.label = label; const currentState = toggleButton.dataset.state || 'visible'; const sign = currentState === 'visible' ? '-' : '+'; toggleButton.innerHTML = `<span class="sign">${sign}</span>${label}`; const hideItems = currentState === 'hidden';
            itemIndices.forEach(index => { if (index < cellElements.length && cellElements[index]) { cellElements[index].classList.toggle('hidden', hideItems); } });
        }
        function updateToggleState(toggle) { /* ... (Sin cambios) ... */
             if (!toggle || !toggle.dataset || !toggle.dataset.toggleId) return; const currentState = toggle.dataset.state; const itemIndicesString = toggle.dataset.itemIndices || ''; const itemIndices = itemIndicesString.split(',').filter(s => s !== '').map(Number); const label = toggle.dataset.label; const newState = currentState === 'visible' ? 'hidden' : 'visible'; const hideItems = newState === 'hidden'; const sign = newState === 'visible' ? '-' : '+'; console.log(`Toggling ${label} to ${newState}.`); itemIndices.forEach(index => { if (index < cellElements.length && cellElements[index]) { cellElements[index].classList.toggle('hidden', hideItems); } }); toggle.dataset.state = newState; toggle.innerHTML = `<span class="sign">${sign}</span>${label}`; updateButtonStyles(); saveSettings();
        }
        function updateAllToggles(targetState) { /* ... (Sin cambios) ... */
             createdToggleButtons.forEach(toggle => { const id = toggle.dataset.toggleId; if (!id) return; const current = toggle.dataset.state; const shouldBeVisible = targetState === 'on'; if ((shouldBeVisible && current === 'hidden') || (!shouldBeVisible && current === 'visible')) { updateToggleState(toggle); } }); const oot = document.getElementById('on-off-toggle'); if (oot) { oot.dataset.state = targetState; updateButtonStyles(); }
        }

        // --- Lógica ON/OFF y Minimal ---
        function handleOnOffLongPress() { /* ... (Sin cambios) ... */
             const pressDuration = pressStartTime ? Date.now() - pressStartTime : 0; const oot = document.getElementById('on-off-toggle'); if (pressDuration >= 2000) { toggleMinimalMode(!isMinimalMode); } else if (!isMinimalMode && oot) { const current = oot.dataset.state; updateAllToggles(current === 'on' ? 'off' : 'on'); saveSettings(); } pressStartTime = null;
        }

        // --- Lógica Configuración ---
        function showConfigMenu() { /* ... (Sin cambios) ... */
             if (isConfigMode) return; isConfigMode = true; document.body.classList.add('config-mode'); document.body.style.overflow = 'hidden'; const overlay = document.createElement('div'); overlay.className = 'config-overlay'; overlay.id = 'config-overlay'; overlay.onclick = (e) => { if (e.target === overlay) exitConfigurationMode(); }; const modal = document.createElement('div'); modal.className = 'config-modal'; if (isDarkMode) modal.classList.add('dark-mode'); modal.onclick = (e) => e.stopPropagation(); modal.innerHTML = `<h2>Configuración</h2><p>Opción:</p><button id="config-customize-toggles">Personalizar Filtros</button><button id="config-reset-toggles">Restaurar Filtros</button><hr style="margin: 1.5rem 0; border-color: rgba(128,128,128,0.5);"><button id="config-clear-cache">Borrar Caché</button><button id="config-cancel" class="cancel-button">Cerrar</button>`; overlay.appendChild(modal); document.body.appendChild(overlay); document.getElementById('config-customize-toggles').onclick = showToggleSelectionMenu; document.getElementById('config-clear-cache').onclick = () => { if (confirm('¿Borrar TODOS los datos (ajustes, recordatorios, filtros) y recargar?')) { localStorage.clear(); location.reload(); } }; document.getElementById('config-reset-toggles').onclick = () => { if (confirm('¿Restaurar TODOS los filtros a valores predeterminados?')) { customToggleConfigs = {}; saveCustomToggleConfigs(); alert('Filtros restaurados.'); createdToggleButtons.forEach(t => applyToggleConfiguration(t.dataset.toggleId)); updateButtonStyles(); exitConfigurationMode(); } }; document.getElementById('config-cancel').onclick = exitConfigurationMode;
        }
        function showToggleSelectionMenu() { /* ... (Sin cambios) ... */
            const modal = document.querySelector('.config-modal'); if (!modal) return; if (isDarkMode) modal.classList.add('dark-mode'); let btns = createdToggleButtons.map(t => { const id = t.dataset.toggleId; if (!id) return ''; const lbl = t.dataset.label || toggleRanges.find(r => r.id === id)?.defaultLabel || '???'; return `<button class="config-toggle-button" data-toggle-id="${id}">${lbl}</button>`; }).join(''); modal.innerHTML = `<h2>Personalizar Filtros</h2><p>Seleccione filtro:</p><div style="display: flex; flex-wrap: wrap; justify-content: center;">${btns}</div><hr style="margin: 1.5rem 0; border-color: rgba(128,128,128,0.5);"><button id="config-back" class="cancel-button">Volver</button>`; modal.querySelectorAll('.config-toggle-button').forEach(b => { b.onclick = () => startToggleConfiguration(b.dataset.toggleId); }); document.getElementById('config-back').onclick = showConfigMenu;
        }
        function startToggleConfiguration(toggleId) { /* ... (Implementación sin cambios, maneja selección en grid) ... */
            currentConfiguringToggle = toggleId; const rangeInfo = toggleRanges.find(r => r.id === toggleId); const currentConfig = customToggleConfigs[toggleId]; const currentLabel = currentConfig?.label || rangeInfo.defaultLabel; const currentIndices = currentConfig?.itemIndices || getDefaultIndices(rangeInfo); currentConfigIndices = [...currentIndices]; const newLabel = prompt(`Etiqueta para "${currentLabel}" (máx 6 letras):`, currentLabel); if (newLabel === null) return; const validatedLabel = newLabel.trim().substring(0, 6); if (!validatedLabel) { alert("Etiqueta vacía."); return; } const modal = document.querySelector('.config-modal'); if (!modal) return; if (isDarkMode) modal.classList.add('dark-mode'); modal.innerHTML = `<h2>Configurando: ${validatedLabel}</h2><p>Pulse iconos grid para AÑADIR/QUITAR.</p><p style="margin-top:0.5rem; font-size: 0.9em; color: ${isDarkMode ? '#B0B0B0' : '#666'};">(Seleccionados azul. Vacíos no selecc.).</p><div style="margin-top: 1.5rem;"><button id="config-save-group" class="save-button">Guardar Grupo "${validatedLabel}"</button><button id="config-cancel-group" class="cancel-button">Cancelar</button></div>`; document.body.classList.add('selecting-items-mode'); const overlay = document.getElementById('config-overlay'); if (overlay) overlay.style.backgroundColor = 'transparent'; modal.style.cssText = 'position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 3000;'; grid.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); cellElements.forEach((cell, index) => { cell.classList.remove('config-selected', 'config-empty-cell'); const isEmpty = cell.children.length === 0 || !cell.querySelector('a'); if (!isEmpty && bookmarks[index] !== null && bookmarks[index].name !== undefined) { if (currentConfigIndices.includes(index)) cell.classList.add('config-selected'); cell.removeEventListener('click', handleGridItemClickInConfig); cell.addEventListener('click', handleGridItemClickInConfig); cell.dataset.gridIndex = index; cell.style.cursor = 'pointer'; } else { cell.classList.add('config-empty-cell'); cell.style.cursor = 'not-allowed'; cell.removeEventListener('click', handleGridItemClickInConfig); } }); document.getElementById('config-save-group').onclick = () => saveToggleConfiguration(toggleId, validatedLabel); document.getElementById('config-cancel-group').onclick = () => { exitItemSelectionMode(); showToggleSelectionMenu(); };
         }
        function handleGridItemClickInConfig(event) { /* ... (Sin cambios) ... */
            event.preventDefault(); event.stopPropagation(); const cell = event.currentTarget; if (!cell || !cell.dataset || cell.classList.contains('config-empty-cell')) return; const index = parseInt(cell.dataset.gridIndex); if (isNaN(index)) return; cell.classList.toggle('config-selected'); const isSelected = cell.classList.contains('config-selected'); if (isSelected && !currentConfigIndices.includes(index)) currentConfigIndices.push(index); else if (!isSelected && currentConfigIndices.includes(index)) currentConfigIndices = currentConfigIndices.filter(i => i !== index); console.log("Indices temp:", currentConfigIndices.sort((a,b)=>a-b));
        }
        function saveToggleConfiguration(toggleId, newLabel) { /* ... (Sin cambios) ... */
            customToggleConfigs[toggleId] = { label: newLabel, itemIndices: [...currentConfigIndices].sort((a, b) => a - b) }; saveCustomToggleConfigs(); exitItemSelectionMode(); applyToggleConfiguration(toggleId); showToggleSelectionMenu(); alert(`Filtro "${newLabel}" guardado.`);
        }
        function exitItemSelectionMode() { /* ... (Sin cambios) ... */
            document.body.classList.remove('selecting-items-mode'); const overlay = document.getElementById('config-overlay'); if (overlay) overlay.style.backgroundColor = ''; cellElements.forEach(cell => { cell.removeEventListener('click', handleGridItemClickInConfig); cell.classList.remove('config-selected', 'config-empty-cell'); cell.style.cursor = ''; delete cell.dataset.gridIndex; }); currentConfiguringToggle = null; currentConfigIndices = [];
         }
        function exitConfigurationMode() { /* ... (Sin cambios) ... */
             if (document.body.classList.contains('selecting-items-mode')) exitItemSelectionMode(); const overlay = document.getElementById('config-overlay'); if (overlay) document.body.removeChild(overlay); document.body.classList.remove('config-mode'); document.body.style.overflow = ''; isConfigMode = false;
        }

        // --- Lógica Avisos y Footer ---
        async function loadNotices() { /* ... (Sin cambios) ... */
             try { const r = await fetch('https://boardinggate.github.io/Tesla/avisos.txt', { cache: 'no-cache', headers:{'Cache-Control':'no-cache','Pragma':'no-cache'} }); if (!r.ok) throw new Error(`Status: ${r.status}`); const t = await r.text(); notices = t.split('\n').map(l => l.trim()).filter(l => l.length > 0 && !l.startsWith('#')); if (notices.length === 0) notices = ['BoardingGate Lanzador']; } catch (e) { console.error('Err load notices:', e); notices = ['Error al cargar avisos.']; } currentNoticeIndex = 0; updateNotice(); startNoticeRotation();
         }
        function updateNotice() { /* ... (Sin cambios) ... */
             const ne = document.getElementById('current-notice'); if (!ne) return; if (notices.length > 0) { ne.style.animation = 'none'; ne.offsetHeight; ne.style.animation = ''; ne.textContent = notices[currentNoticeIndex]; ne.style.animationName = 'fadeInOut'; } else { ne.textContent = ''; }
        }
        function startNoticeRotation() { /* ... (Sin cambios) ... */
            if (window.noticeIntervalId) clearInterval(window.noticeIntervalId); if (notices.length > 1) { window.noticeIntervalId = setInterval(() => { if (!isMinimalMode && isActive && isFooterVisible) { currentNoticeIndex = (currentNoticeIndex + 1) % notices.length; updateNotice(); } }, 14000); }
        }
        function toggleFooterVisibility() { /* Actualizado para respetar isMinimalMode */
            const footerElement = document.querySelector('footer');
            const counterElement = document.querySelector('.counter-wrapper');
            const noticeIconContainer = document.querySelector('.notices-icon-container');
            const shouldBeVisible = !isMinimalMode && isActive && isFooterVisible; // Condición clave
            if (noticeIconContainer) noticeIconContainer.classList.toggle('hidden', !shouldBeVisible);
            if (footerElement) footerElement.classList.toggle('hidden', !shouldBeVisible);
            if (counterElement) counterElement.classList.toggle('hidden', !shouldBeVisible);
            if (!isMinimalMode) saveSettings(); // Guardar solo si no estamos en minimal
        }
        document.getElementById('notice-toggle-icon').addEventListener('click', () => { if (isMinimalMode || isConfigMode) return; isActive = !isActive; isFooterVisible = isActive; toggleFooterVisibility(); });

        // --- Lógica Recordatorios (Implementaciones completas necesarias aquí) ---
        function parseTimeOrTimerFromText(text) {
            const timeRegex = /(\d{1,2}):(\d{2})\s*(am|pm)?/i; const timerRegex = /(\d+)\s*(minutos?|mins?|m|horas?|hrs?|h)/i; let match = text.match(timeRegex);
            if (match) { let h = parseInt(match[1]); const m = match[2]; const p = match[3]?.toLowerCase(); if (h<0||h>23||parseInt(m)<0||parseInt(m)>59) return null; if (p) { if (p==='pm'&&h<12) h+=12; if (p==='am'&&h===12) h=0; } return { time: `${String(h).padStart(2,'0')}:${m}`, isTimer: false }; }
            match = text.match(timerRegex); if (match) { const v = parseInt(match[1]); if (v<=0) return null; const u = match[2].toLowerCase(); let min = v; if (u.startsWith('h')) min = v * 60; const n = new Date(); n.setMinutes(n.getMinutes() + min); return { time: `${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}`, isTimer: true }; } return null;
        }
        function showReminderModal(reminder = null) { /* ... (Implementación completa como en versiones anteriores) ... */
             const existingModal = document.querySelector('.reminder-modal'); if (existingModal) document.body.removeChild(existingModal); const modal = document.createElement('div'); modal.className = 'reminder-modal'; if (isDarkMode) modal.classList.add('dark-mode'); modal.setAttribute('role', 'dialog'); modal.setAttribute('aria-modal', 'true'); modal.setAttribute('aria-labelledby', 'reminder-modal-title');
             modal.innerHTML = `<h2 id="reminder-modal-title">${reminder ? 'Editar' : 'Nuevo'} Recordatorio</h2><form id="reminder-form"><div><label for="reminder-text">Texto (puede incluir hora ej. "14:30" o temporizador ej. "en 10 min"):</label><textarea id="reminder-text" rows="3" required aria-required="true">${reminder ? reminder.text : ''}</textarea></div><div style="margin-top: 1rem;"><label for="reminder-time">Hora específica (HH:MM, opcional):</label><input type="time" id="reminder-time" value="${reminder && reminder.time ? reminder.time : ''}"></div><div style="margin-top: 1rem;"><label>Repetir los días:</label><div style="display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: space-between;">${['Do','Lu','Ma','Mi','Ju','Vi','Sá'].map((day, i) => `<label style="flex-basis: calc(100% / 7 - 1rem); text-align: center;"><input type="checkbox" name="repeat" value="${i}" ${reminder && reminder.repeatDays && reminder.repeatDays.includes(i) ? 'checked' : ''} style="margin-right: 0.25rem;"> ${day}</label>`).join('')}</div></div><div class="button-group" style="margin-top: 1.5rem;"><button type="submit">${reminder ? 'Guardar Cambios' : 'Añadir Recordatorio'}</button><button type="button" id="cancel-reminder">Cancelar</button></div></form>`;
             document.body.appendChild(modal); document.body.style.overflow = 'hidden'; modal.querySelector('#reminder-text').focus();
             modal.querySelector('#reminder-form').addEventListener('submit', (e) => { e.preventDefault(); const text = modal.querySelector('#reminder-text').value.trim(); const explicitTime = modal.querySelector('#reminder-time').value; const repeatDays = Array.from(modal.querySelectorAll('input[name="repeat"]:checked')).map(input => parseInt(input.value)); if (!text) { alert('Texto vacío.'); return; } let reminders = JSON.parse(localStorage.getItem('reminders') || '[]'); let finalTime = explicitTime || null; if (!finalTime) { const timeInfo = parseTimeOrTimerFromText(text); if (timeInfo) { finalTime = timeInfo.time; if (timeInfo.isTimer) repeatDays.length = 0; } }
             if (reminder) { const i = reminders.findIndex(r => r.id === reminder.id); if (i !== -1) { reminders[i] = { ...reminders[i], text, time: finalTime, repeatDays, lastShown: null }; } } else { reminders.push({ id: Date.now(), text, time: finalTime, repeatDays, createdAt: Date.now(), lastShown: null }); }
             reminders.sort((a, b) => { if (a.time && !b.time) return -1; if (!a.time && b.time) return 1; if (a.time && b.time) return a.time.localeCompare(b.time); return (a.createdAt || 0) - (b.createdAt || 0); });
             localStorage.setItem('reminders', JSON.stringify(reminders)); document.body.removeChild(modal); document.body.style.overflow = ''; updateButtonStyles(); checkReminders(); });
             modal.querySelector('#cancel-reminder').addEventListener('click', () => { document.body.removeChild(modal); document.body.style.overflow = ''; });
        }
        function showReminderNotification(reminder) { /* ... (Implementación completa como en versiones anteriores) ... */
             const now = Date.now(); if (reminder.lastShown && (now - reminder.lastShown < 55000)) { return; } updateReminderLastShown(reminder.id, now); const container = document.getElementById('reminder-notifications'); if (!container) return; const existing = container.querySelector(`.reminder-notification[data-id="${reminder.id}"]`); if (existing) container.removeChild(existing); const notification = document.createElement('div'); notification.className = 'reminder-notification'; if (isDarkMode) notification.classList.add('dark-mode'); notification.dataset.id = reminder.id; notification.setAttribute('role', 'alert'); notification.setAttribute('aria-live', 'assertive');
             notification.innerHTML = `<p>${reminder.text}</p>${reminder.time ? `<p style="font-size: 0.8em; opacity: 0.8;">Hora: ${reminder.time}</p>` : ''}${reminder.repeatDays && reminder.repeatDays.length > 0 ? `<p style="font-size: 0.8em; opacity: 0.8;">Repite: ${reminder.repeatDays.map(day => ['Do','Lu','Ma','Mi','Ju','Vi','Sá'][day]).join(', ')}</p>` : ''}<div class="button-group"><button class="postpone" title="Aplazar 10 min">Aplazar</button><button class="modify" title="Modificar">Editar</button><button class="cancel" title="Descartar">OK</button></div>`;
             container.insertBefore(notification, container.firstChild);
             notification.querySelector('.cancel').onclick = () => { container.removeChild(notification); if (!reminder.repeatDays || reminder.repeatDays.length === 0) deleteReminder(reminder.id); };
             notification.querySelector('.modify').onclick = () => { container.removeChild(notification); const rems = JSON.parse(localStorage.getItem('reminders') || '[]'); const rEdit = rems.find(r => r.id === reminder.id); if (rEdit) showReminderModal(rEdit); else alert("Recordatorio no encontrado."); };
             notification.querySelector('.postpone').onclick = () => { container.removeChild(notification); postponeReminder(reminder.id, 10); };
        }
        function deleteReminder(id) { let rems = JSON.parse(localStorage.getItem('reminders') || '[]'); rems = rems.filter(r => r.id !== id); localStorage.setItem('reminders', JSON.stringify(rems)); updateButtonStyles(); console.log("Reminder deleted:", id); }
        function postponeReminder(id, min) { let rems = JSON.parse(localStorage.getItem('reminders') || '[]'); const i = rems.findIndex(r => r.id === id); if (i !== -1) { const n = new Date(); n.setMinutes(n.getMinutes() + min); const nt = `${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}`; rems[i].time = nt; rems[i].repeatDays = []; rems[i].lastShown = null; localStorage.setItem('reminders', JSON.stringify(rems)); console.log(`Reminder ${id} postponed to ${nt}`); updateButtonStyles(); } }
        function updateReminderLastShown(id, ts) { let rems = JSON.parse(localStorage.getItem('reminders') || '[]'); const i = rems.findIndex(r => r.id === id); if (i !== -1) { rems[i].lastShown = ts; localStorage.setItem('reminders', JSON.stringify(rems)); } }
        function showAllReminders() { /* ... (Implementación completa como en versiones anteriores) ... */
             const existingModal = document.querySelector('.reminder-modal'); if (existingModal) document.body.removeChild(existingModal); let reminders = JSON.parse(localStorage.getItem('reminders') || '[]'); reminders.sort((a, b) => { if (a.time && !b.time) return -1; if (!a.time && b.time) return 1; if (a.time && b.time) return a.time.localeCompare(b.time); return (a.createdAt || 0) - (b.createdAt || 0); }); const modal = document.createElement('div'); modal.className = 'reminder-modal'; if (isDarkMode) modal.classList.add('dark-mode'); modal.setAttribute('role', 'dialog'); modal.setAttribute('aria-modal', 'true'); modal.setAttribute('aria-labelledby', 'all-reminders-title');
             modal.innerHTML = `<h2 id="all-reminders-title">Todos los Recordatorios (${reminders.length})</h2><ul style="max-height: 60vh; overflow-y: auto; margin-bottom: 1rem; padding: 0; list-style: none;">${reminders.length === 0 ? '<li style="text-align: center; opacity: 0.7;">No hay recordatorios.</li>' : reminders.map(r => `<li style="padding: 0.75rem 0.5rem; border-bottom: 1px solid ${isDarkMode ? '#6B7280' : '#D1D5DB'}; display: flex; justify-content: space-between; align-items: center; gap: 0.5rem;"><div style="flex-grow: 1;"><span>${r.text}</span>${r.time ? `<br><small style="opacity: 0.8;">Hora: ${r.time}</small>` : ''}${r.repeatDays && r.repeatDays.length > 0 ? `<br><small style="opacity: 0.8;">Repite: ${r.repeatDays.map(day => ['Do','Lu','Ma','Mi','Ju','Vi','Sá'][day]).join(', ')}</small>` : ''}</div><div style="flex-shrink: 0; display: flex; gap: 0.5rem;"><button class="modify-reminder" data-id="${r.id}" title="Modificar" style="padding: 0.25rem 0.5rem; font-size:0.8rem;">Editar</button><button class="delete-reminder" data-id="${r.id}" title="Eliminar" style="padding: 0.25rem 0.5rem; font-size:0.8rem;">Borrar</button></div></li>`).join('')}</ul><div class="button-group" style="margin-top: 1.5rem;"><button type="button" id="add-new-reminder">Añadir Nuevo</button><button type="button" id="close-reminders">Cerrar</button></div>`;
             document.body.appendChild(modal); document.body.style.overflow = 'hidden';
             modal.querySelectorAll('.modify-reminder').forEach(b => { b.onclick = () => { const id = parseInt(b.dataset.id); const rEdit = JSON.parse(localStorage.getItem('reminders') || '[]').find(r => r.id === id); if (rEdit) showReminderModal(rEdit); else { alert("Recordatorio no existe."); showAllReminders(); } }; });
             modal.querySelectorAll('.delete-reminder').forEach(b => { b.onclick = () => { const id = parseInt(b.dataset.id); if (confirm("¿Eliminar permanentemente?")) { deleteReminder(id); const li = b.closest('li'); if (li) li.remove(); const title = modal.querySelector('#all-reminders-title'); const count = modal.querySelectorAll('ul li').length; if (title) title.textContent = `Todos los Recordatorios (${count})`; if (count === 0) modal.querySelector('ul').innerHTML = '<li style="text-align: center; opacity: 0.7;">No hay recordatorios.</li>'; } }; });
             modal.querySelector('#add-new-reminder').onclick = () => { showReminderModal(); };
             modal.querySelector('#close-reminders').onclick = () => { document.body.removeChild(modal); document.body.style.overflow = ''; };
        }
        function checkReminders() { /* ... (Implementación sin cambios) ... */
             if (isMinimalMode || isConfigMode) return; const reminders = JSON.parse(localStorage.getItem('reminders') || '[]'); const now = new Date(); const currentTime = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`; const currentDay = now.getDay();
             reminders.forEach(r => { if (r.time && r.time === currentTime) { const showToday = (r.repeatDays && r.repeatDays.length > 0 && r.repeatDays.includes(currentDay)); const isOneTime = (!r.repeatDays || r.repeatDays.length === 0); if (showToday || isOneTime) { showReminderNotification(r); } } });
         }
        function loadReminders() { /* ... (Sin cambios) ... */ setTimeout(checkReminders, 1000); setInterval(checkReminders, 60000); updateButtonStyles(); }
        function handleReminderLongPress() { /* ... (Sin cambios) ... */ const d = reminderPressStartTime ? Date.now() - reminderPressStartTime : 0; if (isMinimalMode || isConfigMode) return; if (d >= 1500) showAllReminders(); else showReminderModal(); reminderPressStartTime = null; }

        // --- Navegación y Swipe ---
        document.getElementById('back-button').addEventListener('click', () => { if (!isMinimalMode && !isConfigMode) window.history.back(); });
        document.getElementById('forward-button').addEventListener('click', () => { if (!isMinimalMode && !isConfigMode) window.history.forward(); });
        let touchStartX = 0; let touchEndX = 0;
        document.addEventListener('touchstart', e => { if (isMinimalMode || isConfigMode || e.target.closest('.side-button, #bookmark-grid, .reminder-modal, .config-overlay')) { touchStartX = 0; return; } touchStartX = e.changedTouches[0].screenX; });
        document.addEventListener('touchend', e => { if (touchStartX === 0 || isMinimalMode || isConfigMode) return; touchEndX = e.changedTouches[0].screenX; handleSwipe(); touchStartX = 0; });
        function handleSwipe() { const d = touchEndX - touchStartX; const min = 80; if (d > min) window.history.back(); else if (d < -min) window.history.forward(); }

        // --- Inicialización ---
        window.addEventListener('resize', () => { if (!isMinimalMode && !isConfigMode) adjustButtonPositions(); });

        document.addEventListener('DOMContentLoaded', async () => {
            console.log("DOM Loaded. Initializing...");
            // 1. Crear Grid
            createGridItems();
            // 2. Crear Botones Laterales (obtener referencias)
            sideButtons = createSideButtons();
            // 3. Cargar Versión
            await updateVersion();
            // 4. Cargar TODOS los ajustes y aplicar estados/modos
            loadSavedSettings(); // Llama a adjustPositions al final
            // 5. Cargar Avisos
            await loadNotices();
            console.log("Initialization complete.");
        });

    </script>
</body>
</html>